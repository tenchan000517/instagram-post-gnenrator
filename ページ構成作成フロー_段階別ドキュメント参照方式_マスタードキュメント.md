# ページ構成作成フロー - 段階別ドキュメント参照方式

## 📋 概要

このドキュメントは、新しいページ構成パターンを体系的に設計・実装するための**段階別ドキュメント参照方式**の完全なフローを定義します。テンプレート作成フローと密接に連携し、システム全体の整合性を保証します。

## 🎯 基本思想

### 従来の問題点
```
❌ 一括設計方式
Step 1: ページ数・テンプレート・構造を同時に考える
Step 2: pageStructure.json作成開始
→ 複雑さ・非論理性・テンプレート不整合・保守困難
```

### 新方式の原則
```
✅ 段階別ドキュメント参照方式
各ステップで必要最小限の要素のみ考慮
→ 論理的積み重ね・システム整合性・保守性・拡張性確保
```

## 🔗 テンプレート作成フローとの関係性

### 密接な連携ポイント
1. **ページ構成 → テンプレート需要**: 新しいページ構成パターンが新テンプレート需要を生む
2. **テンプレート → ページ構成**: 新テンプレートの特性が新ページ構成パターンを可能にする
3. **templateOverrides**: ページ構成で特定されたテンプレート需要の具体的実装
4. **システム整合性**: 両フローの結果がPageStructureMatcherで統合される

### 整合性保証メカニズム
```typescript
// ページ構成フロー結果
"templateOverrides": {
  "3": "ng_good_comparison",
  "4": "category_explanation", 
  "6": "vision_strength_matrix"
}

// テンプレート作成フロー対象
NgGoodComparisonTemplate.tsx
CategoryExplanationTemplate.tsx  
VisionStrengthMatrixTemplate.tsx
```

## 📁 重要なパス情報

### システムファイルパス
- **PageStructureMatcher**: `/mnt/c/instagram-course/instagram-post-generator/app/services/knowledgeBase/PageStructureMatcher.ts`
- **TemplateRegistry**: `/mnt/c/instagram-course/instagram-post-generator/app/components/templates/TemplateRegistry.ts`
- **ContentLayoutService**: `/mnt/c/instagram-course/instagram-post-generator/app/services/contentLayoutService.ts`

### データファイルパス
- **マッチングデータ**: `/mnt/c/instagram-course/instagram-post-generator/app/services/knowledgeBase/data/pageStructureMatching.json`
- **ページ構成定義**: `/mnt/c/instagram-course/instagram-post-generator/app/services/knowledgeBase/data/pageStructures/`
- **既存パターン例**: `typeID002-sequential-dependency.json`

### 参考データパス
- **ナレッジベース例**: `/mnt/c/instagram-course/instagram-post-generator/app/data/knowledgeBase/knowledge/K117.json`
- **投稿判断基準**: `/mnt/c/instagram-course/instagram-post-generator/投稿タイプ判断基準マスタードキュメント.md`

## 🔄 完全フロー（4段階）

### 【段階1】構造パターン分析
#### 📚 分析対象
- **実際のコンテンツ構造のみ**（順序性・依存性・並列性）
- **PageStructureMatcherの既存パターンは見ない**

#### 🎯 分析手順
1. **順序依存性の確認**
   ```
   ✅ 順序依存型：1→2→3の順序で理解が必要
   - 前の項目が次の項目の前提となる
   - 順序を変えると効果が減少する
   - 例：志望動機の4つのポイント（K117）
   
   ✅ 並列型：どの項目から始めても問題ない
   - 各項目が独立した価値を持つ
   - 必要な項目だけ選択して活用可能
   - 例：転職活動の5つのコツ
   ```

2. **ページ数の論理的算出**
   ```typescript
   // 基本算出式
   totalPages = 1(導入) + コンテンツページ数 + 0-1(まとめ)
   
   // K117例
   totalPages = 1(導入) + 4(ポイント別) + 0(まとめなし) = 5ページ
   ```

3. **結果記録**
   ```json
   {
     "structureAnalysis": {
       "dependencyType": "sequential", // または "parallel"
       "contentUnits": 4,
       "totalPages": 5,
       "requiresIndex": true,
       "requiresSummary": false
     }
   }
   ```

#### ⚠️ 重要な制約
- **テンプレート選択を考慮しない**
- **既存パターンと比較しない** 
- **純粋に構造の論理性のみに集中**

---

### 【段階2】テンプレート需要設計
#### 📚 参照情報
- **段階1の結果**（構造パターン分析）
- **TemplateRegistryの利用可能テンプレート**

#### 🎯 設計手順
1. **既存テンプレートでの表現可能性確認**
   ```typescript
   // TemplateRegistryから利用可能なテンプレート確認
   const availableTemplates = Object.keys(templateRegistry);
   // ['basic_intro', 'step_guide_achievement', 'enumeration', ...]
   ```

2. **特殊表現需要の特定**
   ```typescript
   // 例：K117の場合
   specialNeeds = {
     "page3": "NG/GOOD比較表示", // → ng_good_comparison
     "page4": "カテゴリ別説明",   // → category_explanation  
     "page6": "マトリックス表"   // → vision_strength_matrix
   }
   ```

3. **templateOverrides設計**
   ```json
   {
     "templateNeeds": {
       "standardPages": ["basic_intro", "step_guide_achievement"],
       "specialOverrides": {
         "3": "ng_good_comparison",
         "4": "category_explanation", 
         "6": "vision_strength_matrix"
       }
     }
   }
   ```

#### ⚠️ 重要な制約
- **存在しないテンプレートは指定しない**
- **テンプレート作成フローの対象として記録**
- **ページ構成ファイル作成は考慮しない**

---

### 【段階3】ページ構成パターン設計
#### 📚 参照情報
- **段階1-2の結果**
- **既存のpageStructuresパターン**
- **PageStructureMatcherの仕組み**

#### 🎯 設計手順

##### Step 3.1: パターンID命名
```typescript
// 命名規則：typeID + 構造特徴 + 特殊性
"typeID002-sequential-dependency"  // K117タイプ
"typeID001-emotion-empathy-list"   // 感情共感リスト型
"typeID003-info-strategic-data"    // 情報戦略データ型
```

##### Step 3.2: ページ定義構造設計
```json
{
  "pageStructureId": "typeID002-sequential-dependency",
  "name": "TypeID002 順序依存型ステップフロー", 
  "pages": [
    {
      "pageNumber": 1,
      "templateId": "basic_intro",
      "templateStructure": {
        "title": "string",
        "targetAudience": "string",
        "problems": "string[]",
        "savePrompt": "string"
      }
    },
    {
      "pageNumber": "dynamic", // 2-5の動的生成
      "templateId": "step_guide_achievement",
      "templateStructure": {
        "pointNumber": "string",
        "title": "string", 
        "content": "string[]",
        "actionItems": "string[]"
      }
    }
  ]
}
```

##### Step 3.3: マッチングパターン設計
```json
{
  "matchingKey": "002-T007",
  "description": "教育型×就活ノウハウ志向×段階的スキル習得",
  "pageStructureId": "typeID002-sequential-dependency",
  "reasoning": "就活ノウハウには順序依存の段階的スキル習得が最適"
}
```

#### ⚠️ 重要な制約
- **既存パターンとの重複を避ける**
- **PageStructureMatcherとの整合性確保**
- **実装方法は考慮しない**

---

### 【段階4】実装・システム統合
#### 📚 参照情報
- **段階1-3の全結果**
- **PageStructureMatcherの実装**
- **既存パターンファイルの構造**

#### 🎯 実装手順

##### Step 4.1: pageStructure.jsonファイル作成
```bash
# ファイルパス
/app/services/knowledgeBase/data/pageStructures/{パターンID}.json
```

##### Step 4.2: pageStructureMatching.json更新
```json
{
  "patterns": [
    // 既存パターン...
    {
      "matchingKey": "002-T007", 
      "description": "教育型×就活ノウハウ志向×段階的スキル習得",
      "pageStructureId": "typeID002-sequential-dependency",
      "reasoning": "就活ノウハウには順序依存の段階的スキル習得が最適"
    }
  ]
}
```

##### Step 4.3: PageStructureMatcher.ts更新
```typescript
import typeID002SequentialDependency from './data/pageStructures/typeID002-sequential-dependency.json'

private static readonly pageStructureMap = {
  // 既存マッピング...
  'typeID002-sequential-dependency': typeID002SequentialDependency,
};
```

##### Step 4.4: システム動作確認
```typescript
// 動作テスト例
const pattern = PageStructureMatcher.findExactMatch("002", "T007");
const structure = PageStructureMatcher.loadPageStructure(
  pattern.pageStructureId, 
  templateOverrides
);
```

## 🚨 段階別制約・禁止事項

### 【段階1】制約
- [ ] **テンプレート選択を考慮しない**
- [ ] **既存パターンと比較しない**
- [ ] **実装方法を考慮しない**
- [ ] **純粋に構造の論理性のみに集中**

### 【段階2】制約  
- [ ] **存在しないテンプレートは指定しない**
- [ ] **TemplateRegistry準拠を確認**
- [ ] **ページ構成ファイル作成は考慮しない**
- [ ] **テンプレート作成フローとの連携を記録**

### 【段階3】制約
- [ ] **既存パターンとの重複を避ける**
- [ ] **PageStructureMatcherとの整合性確保**
- [ ] **命名規則を厳密に遵守**
- [ ] **実装方法は考慮しない**

### 【段階4】制約
- [ ] **段階1-3の結果に忠実に従う**
- [ ] **システムファイルの整合性確保**
- [ ] **既存パターンを破壊しない**
- [ ] **動作確認を徹底する**

## 📊 実践例：K117フロー復習

### 【段階1】構造パターン分析
**コンテンツ**: 志望動機の4つのポイント
**分析結果**: 順序依存型、4コンテンツユニット、5ページ構成

### 【段階2】テンプレート需要設計
**標準テンプレート**: basic_intro, step_guide_achievement
**特殊需要**: NG/GOOD比較、カテゴリ説明、マトリックス表
**templateOverrides**: 3→ng_good_comparison, 4→category_explanation, 6→vision_strength_matrix

### 【段階3】ページ構成パターン設計
**パターンID**: typeID002-sequential-dependency
**マッチングキー**: 002-T007
**動的ページ生成**: step_guide_achievementで2-5ページ

### 【段階4】実装・システム統合
- typeID002-sequential-dependency.json作成
- pageStructureMatching.json更新
- PageStructureMatcher.ts更新
- テンプレート作成フローとの連携実行

## ✅ 品質保証チェックリスト

### 各段階完了時チェック
- [ ] **段階1**: 構造の論理性が明確に分析されている
- [ ] **段階2**: テンプレート需要が適切に設計されている
- [ ] **段階3**: ページ構成パターンが論理的に設計されている
- [ ] **段階4**: システム統合が完全に実装されている

### 最終品質チェック
- [ ] **論理性**: 構造が論理的で一貫している
- [ ] **システム整合性**: 全システムファイルが整合している
- [ ] **テンプレート連携**: テンプレート作成フローと連携している
- [ ] **保守性**: 将来の拡張・修正が容易である
- [ ] **動作確認**: PageStructureMatcherで正常動作する

## 🎯 このフローの利点

### 1. **論理的積み重ね**
- 構造分析から実装まで段階的構築
- 各段階の論理的妥当性確保
- 一貫性のあるシステム設計

### 2. **システム整合性**
- PageStructureMatcherとの完全統合
- TemplateRegistryとの整合性保証
- テンプレート作成フローとの連携

### 3. **拡張性・保守性**
- 新パターン追加の標準化
- 既存システムの非破壊性
- 明確な設計思想の継承

### 4. **品質保証**
- 段階別品質チェック
- システム動作確認の徹底
- 論理的設計の保証

## 🔄 運用指針

### 新パターン作成時
1. **段階を厳密に分離して実施**
2. **制約を厳格に守る**
3. **テンプレート作成フローとの連携確認**

### 既存パターン改善時
1. **段階1から再分析**
2. **システム整合性の再確認**
3. **影響範囲の事前調査**

### システム保守
1. **PageStructureMatcherの定期確認**
2. **新テンプレートとの連携テスト**
3. **パフォーマンス影響の評価**

---

**作成日**: 2025-07-27  
**バージョン**: 1.0  
**基準**: K117ページ構成実装完了・テンプレート作成フロー確定時点  
**重要度**: 最高 - 全ページ構成開発の標準プロセス  
**連携フロー**: テンプレート作成フロー_段階別ドキュメント参照方式_マスタードキュメント.md  
**適用範囲**: 全ページ構成パターン作成・改善作業