# コンテンツ分析フロー - 段階別ドキュメント参照方式

## 📋 概要

このドキュメントは、新しいナレッジベースコンテンツを体系的に分析し、システムに統合するための**段階別ドキュメント参照方式**の完全なフローを定義します。

## 🎯 基本思想

### 従来の問題点
```
❌ 一括読み込み方式
Step 1: 全マスタードキュメントを読む
Step 2: 分析開始
→ 先入観・混乱・判断基準の曖昧化
```

### 新方式の原則
```
✅ 段階別ドキュメント参照方式
各ステップで必要最小限の情報のみ参照
→ 集中力維持・先入観排除・精度向上
```

## 📁 重要なパス情報

### ドキュメントパス
- **投稿タイプ判断基準**: `/mnt/c/instagram-course/instagram-post-generator/投稿タイプ判断基準マスタードキュメント.md`
- **ターゲット判断基準**: `/mnt/c/instagram-course/instagram-post-generator/ターゲット判断基準マスタードキュメント.md`
- **ページ構成判断基準**: `/mnt/c/instagram-course/instagram-post-generator/ページ構成判断基準マスタードキュメント.md`
- **KxxxJSONフォーマット**: `/mnt/c/instagram-course/instagram-post-generator/KxxxJSONフォーマットマスタードキュメント.md`

### コンテンツパス
- **オリジナルコンテンツ**: `/mnt/c/instagram-course/instagram-post-generator/contents/{ナレッジID}/`
- **画像ファイル**: `S__16326659_0.jpg` ～ `S__16326665_0.jpg` (ファイル名は可変)

### 保存先パス
- **KxxxJSON保存先**: `/mnt/c/instagram-course/instagram-post-generator/app/data/knowledgeBase/knowledge/{ナレッジID}.json`
- **既存参考ファイル**: `/mnt/c/instagram-course/instagram-post-generator/app/data/knowledgeBase/knowledge/K115.json`

### システムファイルパス
- **型定義**: `/mnt/c/instagram-course/instagram-post-generator/app/types/knowledgeBase.ts`
- **PageStructureMatcher**: `/mnt/c/instagram-course/instagram-post-generator/app/services/knowledgeBase/PageStructureMatcher.ts`
- **PageStructureAnalyzer**: `/mnt/c/instagram-course/instagram-post-generator/app/services/pageStructureAnalyzer.ts`

## 🔄 完全フロー（5段階）

### 【段階1】投稿タイプ判断
#### 📚 参照ドキュメント
- **`/mnt/c/instagram-course/instagram-post-generator/投稿タイプ判断基準マスタードキュメント.md`のみ**

#### 🎯 判断手順
1. **Problem-Solutionの本質分析**
   - 感情的な悩み・困った状況 → TypeID=001
   - 実践的なスキル・ノウハウ習得 → TypeID=002  
   - 純粋な知識・情報・データ → TypeID=003
   - 効率化・時短のツール・方法 → TypeID=004

2. **判断基準チェック**
   - コンテンツの根本的ニーズを特定
   - 解決アプローチの方法論を確認
   - ユーザーの最終的な獲得価値で決定

3. **結果記録**
   ```json
   {
     "postType": "002",
     "postTypeReason": "志望動機作成の4つのポイントを段階的に学習する実践的ノウハウ伝授型コンテンツ"
   }
   ```

#### ⚠️ 重要な制約
- **他のマスタードキュメントは見ない**
- **ターゲットやページ構成は考慮しない**
- **純粋に投稿タイプのみに集中**

---

### 【段階2】ターゲット判断
#### 📚 参照ドキュメント
- **`/mnt/c/instagram-course/instagram-post-generator/ターゲット判断基準マスタードキュメント.md`のみ**
- **段階1の結果**（postType）

#### 🎯 判断手順
1. **投稿タイプ別ターゲット候補確認**
   - TypeID=001 → T001-T006
   - TypeID=002 → T007-T012
   - TypeID=003 → T013-T018
   - TypeID=004 → T019-T024

2. **3要素による絞り込み**
   - **対象者**（学生/社会人）で絞り込み
   - **性別**（女性/男性/共通）で絞り込み
   - **具体的なニーズ**で最終決定

3. **結果記録**
   ```json
   {
     "targetId": "T007",
     "targetReason": "対策方法やノウハウによって就活で差をつけたい学生"
   }
   ```

#### ⚠️ 重要な制約
- **投稿タイプが決定した6個の中からのみ選択**
- **24個全体から選ばない**
- **ページ構成は考慮しない**

---

### 【段階3】ページ構成判断
#### 📚 参照ドキュメント
- **`/mnt/c/instagram-course/instagram-post-generator/ページ構成判断基準マスタードキュメント.md`のみ**
- **段階1-2の結果**（postType, targetId）

#### 🎯 判断手順

##### Step 3.1: 順序依存性の確認（最重要）
1. **順序依存型の特徴チェック**
   - 1→2→3の順序で実行・理解が必要か？
   - 前の項目が次の項目の前提となるか？
   - 順序を変えると効果が減少するか？

2. **並列型の特徴チェック**
   - どの項目から始めても問題ないか？
   - 各項目が独立した価値を持つか？
   - 必要な項目だけ選択して活用可能か？

##### Step 3.2: 基本パターン選択
1. **投稿タイプ内のパターン確認**
2. **コンテンツの構造的特徴と照合**
3. **最も適合度の高いパターン選択**

##### Step 3.3: 拡張オプション判断
1. **INDEXページの必要性**
   - ステップが4個以上？
   - 構造の事前説明が必要？
   → YES: INDEXページ追加

2. **templateOverridesの必要性**
   - 標準テンプレートで表現できない構造？
   → YES: templateOverrides設定

##### Step 3.4: 選択パターンの実装ファイル確認
1. **選択されたパターンのJSONファイル確認**
   ```bash
   # 選択されたパターンのJSONファイルが存在するか確認
   /app/services/knowledgeBase/data/pageStructures/{selectedPattern}.json
   
   # 例：選択パターンが"typeID001-emotion-empathy-list"の場合
   # → typeID001-emotion-empathy-list.json が存在するか確認
   ```

2. **未実装の場合 → JSONファイル作成必要**
   **🚨 重要**: ページ構成判断基準マスタードキュメント.mdに定義済みだが、実装ファイル未作成の場合

#### 🔄 ページ構成ファイル作成フロー
**参照**: `/mnt/c/instagram-course/instagram-post-generator/ページ構成作成フロー_段階別ドキュメント参照方式_マスタードキュメント.md`

- **段階3-4のみ実行**: 既定パターンのJSONファイル作成
- **段階1-2はスキップ**: パターン仕様は判断基準マスタードキュメント.mdで確定済み

**⚠️ 注意**: JSONファイル作成が必要な場合は、ページ構成作成フローを完了してから、コンテンツ分析フローのStep 3.5に戻る

##### Step 3.5: 最終的なページ構成確定
```json
{
  "pageStructurePattern": "typeID002-sequential-dependency",
  "templateOverrides": {
    "3": "ng_good_comparison",
    "4": "category_explanation",
    "5": "category_explanation",
    "6": "vision_strength_matrix"
  }
}
```

#### ⚠️ 重要な制約
- **既存パターン優先使用**
- **新パターン作成は最小限に抑制**
- **JSON作成方法は考慮しない**

#### 🚨 TypeID=002の必須判断基準（重要）
**上下2アイテム配置型の特徴を見落とすな！**

##### 判断ポイント
- **K132, K134型**: 12個の方法/表現を2つずつ上下配置
- **構造**: page1(導入) → page2-7(各2アイテム) → page8(まとめ)
- **パターン**: `typeID002-parallel-introduction` ← **これを選ぶ**
- **テンプレート**: `dual_enumeration`（上下2アイテム配置）

##### 間違いやすいケース
❌ **誤判断**: `typeID002-sequential-dependency`（1つずつの順序依存型）
✅ **正判断**: `typeID002-parallel-introduction`（上下2アイテム配置型）

**判断基準**: 複数の方法/表現/ツールが並列的に紹介され、2つずつペアで学習する構造

---

### 【段階4】JSON作成
#### 📚 参照ドキュメント
- **`/mnt/c/instagram-course/instagram-post-generator/KxxxJSONフォーマットマスタードキュメント.md`のみ**
- **段階1-3の全結果**

#### 🎯 作成手順

##### Step 4.1: 基本フィールド設定
```json
{
  "source": "contents-132",  // 🆕 K132の例
  "problemCategory": "仕事効率化",
  "problemDescription": "自分は要領が悪くて仕事が遅い・効率的に仕事ができない",
  "postType": "002",  // 段階1の結果
  "postTypeReason": "要領が良くなるための12個の実践的方法を並列的に紹介する実践的ノウハウ伝授型コンテンツ",
  "pageStructurePattern": "typeID002-parallel-introduction"  // 段階3の結果
}
```

##### Step 4.2: solutionContent構造化
```json
{
  "solutionContent": {
    "概要": "...",
    "具体的手順": [...],
    "提供情報": [...],
    "実用的なアドバイス": [...]
  }
}
```

##### Step 4.3: templateOverrides設定
```json
{
  "templateOverrides": {  // 段階3で必要と判断された場合のみ
    "3": "ng_good_comparison",
    "4": "category_explanation",
    "5": "category_explanation",
    "6": "vision_strength_matrix"
  }
}
```

##### Step 4.4: detailedContent構造化
```json
{
  "detailedContent": {
    "page1": { "role": "導入・問題提起", "section": "introduction", "content": {...} },
    "page2": { 
      "role": "方法1-2", 
      "section": "mainContent", 
      "content": {
        "items": [
          {
            "number": "1",
            "title": "キーマンをおさえる",
            "description": "決定権を持つ人に話を通しておくと、早く進むことができます",
            "imageSrc": "/misaki.png"  // 🆕 画像フィールド（オプショナル）
          },
          {
            "number": "2", 
            "title": "手段にとらわれない",
            "description": "もっと良い方法がないか常に考え、ムダを省くことが重要です"
            // imageSrcなし → 画像表示なし
          }
        ]
      }
    }
    // ...各ページの詳細構造
  }
}
```

##### Step 4.4.1: 🆕 画像フィールド設定指針
**設定条件**:
- アイテム型テンプレート（`dual_enumeration`, `enumeration`, `multiple_items_display`等）で使用
- `/public`フォルダ内の利用可能画像から選択
- オプショナル：設定しない場合は画像なしで表示

**利用可能画像パターン**:
```typescript
availableImages = [
  // キャラクター画像
  '/misaki.png',      // みさき
  '/kikuyo.png',      // きくよ  
  '/king.png',        // キング
  '/ten.png',         // てん
  '/ten_worry.png',   // てん（心配）
  '/misaki_worry.png',// みさき（心配）
  '/kikuyo_worry.png',// きくよ（心配）
  '/king_warry.png',  // キング（心配）
  '/iida.png',        // いいだ
  '/iida_worry.png',  // いいだ（心配）
  
  // AIツール画像（multiple_items_display用）
  '/imag/ai/ChatGPT-Logo.svg',     // ChatGPT
  '/imag/ai/claude-ai-icon.png',   // Claude
  '/imag/ai/perplexity.png',       // Perplexity
  '/imag/ai/mymind.png',           // mymind
  '/imag/ai/napkin-ai.png',        // Napkin.ai
  '/imag/ai/notebooklm.png',       // NotebookLM
]
```

**設定戦略**:
- アイテムの感情やトーンに合わせて画像選択
- 心配・悩み系→ `_worry.png`
- ポジティブ・解決系→ 通常画像
- 統一感よりもアイテム内容との適合性を優先

**AIツール画像の使用指針**（multiple_items_display用）:
- ツール名の言及がある場合は対応するAIツール画像を使用
- 例：「ChatGPT」という文字列が含まれる → `/imag/ai/ChatGPT-Logo.svg`
- ツール名が明確でない場合はキャラクター画像を使用
- 画像パスは大文字小文字を正確に記載（例：ChatGPT-Logo.svg）

#### ⚠️ 重要な制約
- **CTA要素は削除**（savePrompt, cta, finalPageOffer）
- **純粋なコンテンツのみ記載**
- **汎用的な表現に統一**

---

### 【段階5】システム登録
#### 📚 参照ドキュメント
- **`/mnt/c/instagram-course/instagram-post-generator/app/data/knowledgeBase/type-target-persona-relations.json`**
- **段階2の結果**（targetId）

#### 🎯 登録手順

##### Step 5.1: ペルソナID割り当て
```json
{
  "personaId": "P118"  // K118 → P118
}
```

##### Step 5.2: targetToPersonas更新
```json
{
  "T007": [...既存のペルソナ..., "P118"]  // 段階2で決定したターゲットID
}
```

##### Step 5.3: personaToKnowledge追加
```json
{
  "P118": ["K118"]  // ペルソナとナレッジの紐付け
}
```

##### Step 5.4: 🆕 複数ターゲット対応（該当する場合のみ）
**判断基準**: コンテンツが就活生・女性・男性すべてに該当する場合
- ビジネスマナー、敬語、コミュニケーション等の汎用スキル
- 効率化ツール、仕事術等の性別・立場を問わない内容

**実行手順**:
1. **該当する全ターゲットに追加**
   ```json
   "T007": [..., "P134"],  // 就活生
   "T009": [..., "P134"],  // 女性
   "T010": [..., "P134"]   // 男性
   ```

2. **duplicatedPersonasで重複管理**
   ```json
   "duplicatedPersonas": {
     "P134": ["T007", "T009", "T010"]
   }
   ```

3. **KxxxJSONにtargetIds配列追加**
   ```json
   {
     "targetIds": ["T007", "T009", "T010"],
     "targetReason": "ビジネスマナーとしての謝り方は就活生・女性・男性すべてに共通して必要なスキル"
   }
   ```

#### ⚠️ 重要な制約
- **ターゲットIDは段階2の結果を使用**
- **ペルソナIDはナレッジIDと同じ番号**
- **既存の配列に追加する際はカンマを忘れない**
- **🆕 複数ターゲット該当時は全ターゲットに必ず追加し、duplicatedPersonasで管理**

## 📊 実践例：K117の完全フロー

### 【段階1】投稿タイプ判断
**参照**: `/mnt/c/instagram-course/instagram-post-generator/投稿タイプ判断基準マスタードキュメント.md`

#### 分析プロセス
1. **Problem**: 志望動機の作り方がわからない・企業研究が浅い
2. **Solution**: 志望動機に必要な4つのポイントとNG/GOOD例による具体的解説
3. **本質**: 実践的なノウハウ伝授による「できるようになりたい」の支援

#### 判断結果
```json
{
  "postType": "002",
  "postTypeReason": "志望動機作成の4つのポイントを段階的に学習する実践的ノウハウ伝授型コンテンツ"
}
```

---

### 【段階2】ターゲット判断
**参照**: `/mnt/c/instagram-course/instagram-post-generator/ターゲット判断基準マスタードキュメント.md`

#### 分析プロセス
1. **投稿タイプ**: TypeID=002 → 候補はT007-T012
2. **対象者**: 就活生 → T007, T008に絞り込み
3. **ニーズ**: 就活ノウハウによる差別化 → T007

#### 判断結果
```json
{
  "targetId": "T007",
  "targetReason": "対策方法やノウハウによって就活で差をつけたい学生"
}
```

---

### 【段階3】ページ構成判断
**参照**: `/mnt/c/instagram-course/instagram-post-generator/ページ構成判断基準マスタードキュメント.md`

#### 分析プロセス
1. **順序依存性**: ポイント1→2→3→4の順序で学習が必要 ✓
2. **基本パターン**: TypeID=002-順序依存型ステップフロー
3. **INDEXページ**: 4つのポイント提示が必要 ✓
4. **templateOverrides**: NG/GOOD比較、カテゴリ説明、マトリックス分析が必要 ✓

#### 判断結果
```json
{
  "pageStructurePattern": "typeID002-sequential-dependency",
  "templateOverrides": {
    "3": "ng_good_comparison",
    "4": "category_explanation",
    "5": "category_explanation",
    "6": "vision_strength_matrix"
  }
}
```

---

### 【段階4】JSON作成
**参照**: `/mnt/c/instagram-course/instagram-post-generator/KxxxJSONフォーマットマスタードキュメント.md`

#### 4.1: KxxxJSON作成
- 段階1-3の結果に基づいてJSON作成
- KxxxJSONフォーマットマスタードキュメント完全準拠

#### 4.2: 必須チェック実行（絶対実行）
KxxxJSON作成後、必ず以下の全25項目をチェックする：

##### JSON構文チェック
- [ ] **JSON構文エラーなし**: 不要なカンマ、引用符ミス等の構文エラーがない
- [ ] **プロパティ名ダブルクォート**: 全てのプロパティ名が正しくダブルクォートされている
- [ ] **オブジェクト構造正常**: ネストしたオブジェクトの開閉括弧が正しい

##### detailedContent構造チェック
- [ ] **sectionフィールド必須**: 全ページに`section`フィールドが存在する
- [ ] **section値妥当性**: `introduction`/`mainContent`/`summary`のいずれかが使用されている
- [ ] **layoutフィールド禁止**: `layout`フィールドが一切含まれていない
- [ ] **iconフィールド禁止**: `icon`フィールドが一切含まれていない
- [ ] **role記載**: 各ページに適切な`role`（日本語）が記載されている

##### 語尾・表現チェック
- [ ] **特殊語尾除去**: 「にゃ」「にゃよ」「にゃね」等のキャラクター語尾が全て除去されている
- [ ] **丁寧語統一**: 「です」「ます」「ください」等の標準的な丁寧語に統一されている
- [ ] **汎用的表現**: ブランド固有表現ではなく汎用的な表現に統一されている

##### フィールド整合性チェック
- [ ] **pageCount一致**: `pageCount`と`detailedContent`のページ数が一致している
- [ ] **pageStructurePattern存在**: 指定されたページ構造パターンファイルが存在する
- [ ] **templateOverrides妥当性**: 指定されたテンプレートIDが存在する（設定時のみ）

##### CTA・禁止要素チェック
- [ ] **CTA要素除去**: `savePrompt`、`cta`、`finalPageOffer`等のCTA要素が完全に除去されている
- [ ] **純粋コンテンツ**: 販促・誘導要素ではなく純粋なコンテンツのみ記載されている

##### 複数ターゲット対応チェック
- [ ] **複数ターゲット判断**: 性別・立場を問わない汎用スキルか確認（ストレス管理、セルフマネジメント、自己分析等）
- [ ] **targetIds配列追加**: 該当する全ターゲットIDをJSONに記載（例: ["T009", "T010"]）
- [ ] **targetReason記載**: 複数ターゲットに該当する理由を明記
- [ ] **システム登録確認**: type-target-persona-relations.jsonの全該当ターゲットに追加
- [ ] **duplicatedPersonas更新**: 複数ターゲットに紐づくペルソナを重複管理に追加

#### 最終的なKxxxJSON
全チェック項目クリア後に段階5へ進む

## 🚨 段階別制約・禁止事項

### 【段階1】制約
- [ ] **他のマスタードキュメントを読まない**
- [ ] **ターゲットを考慮しない**
- [ ] **ページ構成を考慮しない**
- [ ] **Problem-Solutionの本質のみに集中**

### 【段階2】制約  
- [ ] **投稿タイプ決定後の6個からのみ選択**
- [ ] **24個全体から選ばない**
- [ ] **ページ構成を考慮しない**
- [ ] **対象者・性別・ニーズの3要素で判断**

### 【段階3】制約
- [ ] **既定パターンから選択**（ページ構成判断基準マスタードキュメント.md準拠）
- [ ] **選択パターンのJSONファイル存在確認**
- [ ] **未実装の場合はページ構成作成フロー実行**
- [ ] **新パターン創出は禁止**
- [ ] **JSON作成方法を考慮しない**

### 【段階4】制約
- [ ] **CTA要素を削除**
- [ ] **純粋なコンテンツのみ記載**
- [ ] **汎用的な表現に統一**
- [ ] **マスタードキュメント準拠を確認**
- [ ] **必須チェック完全実行**: 4.2の全チェック項目を必ず実行
- [ ] **チェック未完了時は段階5進行禁止**: 全項目クリアまで次段階に進まない

## ✅ 品質保証チェックリスト

### 各段階完了時チェック
- [ ] **段階1**: postTypeとpostTypeReasonが明確
- [ ] **段階2**: targetIdとtargetReasonが適切
- [ ] **段階3**: pageStructurePatternとtemplateOverridesが設定、実装ファイル確認済み
- [ ] **段階4**: 完全なKxxxJSONが作成 + **必須チェック25項目全てクリア**

### 段階4必須チェック完了確認（絶対実行）
**⚠️ 重要**: 以下の全項目が✅になるまで段階5に進行してはならない

#### JSON構文チェック (3項目)
- [ ] **JSON構文エラーなし**
- [ ] **プロパティ名ダブルクォート**  
- [ ] **オブジェクト構造正常**

#### detailedContent構造チェック (5項目)
- [ ] **sectionフィールド必須**
- [ ] **section値妥当性**
- [ ] **layoutフィールド禁止**
- [ ] **iconフィールド禁止** 
- [ ] **role記載**

#### 語尾・表現チェック (3項目)
- [ ] **特殊語尾除去**
- [ ] **丁寧語統一**
- [ ] **汎用的表現**

#### フィールド整合性チェック (3項目)
- [ ] **pageCount一致**
- [ ] **pageStructurePattern存在**
- [ ] **templateOverrides妥当性**

#### CTA・禁止要素チェック (2項目)
- [ ] **CTA要素除去**
- [ ] **純粋コンテンツ**

#### 複数ターゲット対応チェック (5項目)
- [ ] **複数ターゲット判断**
- [ ] **targetIds配列追加**
- [ ] **targetReason記載**
- [ ] **システム登録確認**
- [ ] **duplicatedPersonas更新**

### 最終品質チェック
- [ ] **整合性**: 全段階の判断結果が一貫している
- [ ] **準拠性**: 各マスタードキュメントに準拠している
- [ ] **完全性**: 必須フィールドが全て設定されている
- [ ] **構文正確性**: JSON構文エラーが一切ない
- [ ] **フォーマット準拠**: KxxxJSONフォーマットマスタードキュメント完全準拠

## 🎯 このフローの利点

### 1. **集中力維持**
- 一度に一つの判断に集中
- 認知負荷の軽減
- 判断精度の向上

### 2. **先入観排除**
- 次段階の基準が判断に影響しない
- 純粋な判断基準の適用
- バイアスの最小化

### 3. **段階的確信**
- 前段階の結果を基に次段階を判断
- 論理的な積み重ね
- 一貫性の保証

### 4. **体系的品質**
- 各段階での品質チェック
- 最終的な整合性確認
- 標準化された品質

## 🔄 運用指針

### 初回実施時
1. **各段階を厳密に分離**
2. **制約を厳格に守る**
3. **判断根拠を明確に記録**

### 習熟後
1. **段階別の判断パターンを蓄積**
2. **よくある判断ミスを記録**
3. **フロー改善点を継続的に更新**

---

**作成日**: 2025-07-27  
**更新日**: 2025-07-28
**バージョン**: 1.1  
**更新内容**: MultipleItemsDisplay用AIツール画像パス追加
**基準**: K117実装完了・4つのマスタードキュメント確定時点  
**重要度**: 最高 - 全ナレッジベース分析の標準プロセス  
**参照**: 
- `投稿タイプ判断基準マスタードキュメント.md`
- `ターゲット判断基準マスタードキュメント.md`
- `ページ構成判断基準マスタードキュメント.md`
- `ページ構成作成フロー_段階別ドキュメント参照方式_マスタードキュメント.md`
- `KxxxJSONフォーマットマスタードキュメント.md`