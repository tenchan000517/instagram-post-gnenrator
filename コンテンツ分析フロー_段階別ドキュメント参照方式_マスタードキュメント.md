# コンテンツ分析フロー - 段階別ドキュメント参照方式

## 📋 概要

このドキュメントは、新しいナレッジベースコンテンツを体系的に分析し、システムに統合するための**段階別ドキュメント参照方式**の完全なフローを定義します。

## 🎯 基本思想

### 従来の問題点
```
❌ 一括読み込み方式
Step 1: 全マスタードキュメントを読む
Step 2: 分析開始
→ 先入観・混乱・判断基準の曖昧化
```

### 新方式の原則
```
✅ 段階別ドキュメント参照方式
各ステップで必要最小限の情報のみ参照
→ 集中力維持・先入観排除・精度向上
```

## 📁 重要なパス情報

### ドキュメントパス
- **投稿タイプ判断基準**: `/mnt/c/instagram-course/instagram-post-generator/投稿タイプ判断基準マスタードキュメント.md`
- **ターゲット判断基準**: `/mnt/c/instagram-course/instagram-post-generator/ターゲット判断基準マスタードキュメント.md`
- **ページ構成判断基準**: `/mnt/c/instagram-course/instagram-post-generator/ページ構成判断基準マスタードキュメント.md`
- **KxxxJSONフォーマット**: `/mnt/c/instagram-course/instagram-post-generator/KxxxJSONフォーマットマスタードキュメント.md`

### コンテンツパス
- **オリジナルコンテンツ**: `/mnt/c/instagram-course/instagram-post-generator/contents/{ナレッジID}/`
- **画像ファイル**: `S__16326659_0.jpg` ～ `S__16326665_0.jpg` (ファイル名は可変)

### 保存先パス
- **KxxxJSON保存先**: `/mnt/c/instagram-course/instagram-post-generator/app/data/knowledgeBase/knowledge/{ナレッジID}.json`
- **既存参考ファイル**: `/mnt/c/instagram-course/instagram-post-generator/app/data/knowledgeBase/knowledge/K115.json`

### システムファイルパス
- **型定義**: `/mnt/c/instagram-course/instagram-post-generator/app/types/knowledgeBase.ts`
- **PageStructureMatcher**: `/mnt/c/instagram-course/instagram-post-generator/app/services/knowledgeBase/PageStructureMatcher.ts`
- **PageStructureAnalyzer**: `/mnt/c/instagram-course/instagram-post-generator/app/services/pageStructureAnalyzer.ts`

## 🔄 完全フロー（5段階）

### 【段階1】投稿タイプ判断
#### 📚 参照ドキュメント
- **`/mnt/c/instagram-course/instagram-post-generator/投稿タイプ判断基準マスタードキュメント.md`のみ**

#### 🎯 判断手順
1. **Problem-Solutionの本質分析**
   - 感情的な悩み・困った状況 → TypeID=001
   - 実践的なスキル・ノウハウ習得 → TypeID=002  
   - 純粋な知識・情報・データ → TypeID=003
   - 効率化・時短のツール・方法 → TypeID=004

2. **判断基準チェック**
   - コンテンツの根本的ニーズを特定
   - 解決アプローチの方法論を確認
   - ユーザーの最終的な獲得価値で決定

3. **結果記録**
   ```json
   {
     "postType": "002",
     "postTypeReason": "志望動機作成の4つのポイントを段階的に学習する実践的ノウハウ伝授型コンテンツ"
   }
   ```

#### ⚠️ 重要な制約
- **他のマスタードキュメントは見ない**
- **ターゲットやページ構成は考慮しない**
- **純粋に投稿タイプのみに集中**

---

### 【段階2】ターゲット判断
#### 📚 参照ドキュメント
- **`/mnt/c/instagram-course/instagram-post-generator/ターゲット判断基準マスタードキュメント.md`のみ**
- **段階1の結果**（postType）

#### 🎯 判断手順
1. **投稿タイプ別ターゲット候補確認**
   - TypeID=001 → T001-T006
   - TypeID=002 → T007-T012
   - TypeID=003 → T013-T018
   - TypeID=004 → T019-T024

2. **3要素による絞り込み**
   - **対象者**（学生/社会人）で絞り込み
   - **性別**（女性/男性/共通）で絞り込み
   - **具体的なニーズ**で最終決定

3. **結果記録**
   ```json
   {
     "targetId": "T007",
     "targetReason": "対策方法やノウハウによって就活で差をつけたい学生"
   }
   ```

#### ⚠️ 重要な制約
- **投稿タイプが決定した6個の中からのみ選択**
- **24個全体から選ばない**
- **ページ構成は考慮しない**

---

### 【段階3】ページ構成判断
#### 📚 参照ドキュメント
- **`/mnt/c/instagram-course/instagram-post-generator/ページ構成判断基準マスタードキュメント.md`のみ**
- **段階1-2の結果**（postType, targetId）

#### 🎯 判断手順

##### Step 3.1: 順序依存性の確認（最重要）
1. **順序依存型の特徴チェック**
   - 1→2→3の順序で実行・理解が必要か？
   - 前の項目が次の項目の前提となるか？
   - 順序を変えると効果が減少するか？

2. **並列型の特徴チェック**
   - どの項目から始めても問題ないか？
   - 各項目が独立した価値を持つか？
   - 必要な項目だけ選択して活用可能か？

##### Step 3.2: 基本パターン選択
1. **投稿タイプ内のパターン確認**
2. **コンテンツの構造的特徴と照合**
3. **最も適合度の高いパターン選択**

##### Step 3.3: 拡張オプション判断
1. **INDEXページの必要性**
   - ステップが4個以上？
   - 構造の事前説明が必要？
   → YES: INDEXページ追加

2. **templateOverridesの必要性**
   - 標準テンプレートで表現できない構造？
   → YES: templateOverrides設定

##### Step 3.4: 選択パターンの実装ファイル確認
1. **選択されたパターンのJSONファイル確認**
   ```bash
   # 選択されたパターンのJSONファイルが存在するか確認
   /app/services/knowledgeBase/data/pageStructures/{selectedPattern}.json
   
   # 例：選択パターンが"typeID001-emotion-empathy-list"の場合
   # → typeID001-emotion-empathy-list.json が存在するか確認
   ```

2. **未実装の場合 → JSONファイル作成必要**
   **🚨 重要**: ページ構成判断基準マスタードキュメント.mdに定義済みだが、実装ファイル未作成の場合

#### 🔄 ページ構成ファイル作成フロー
**参照**: `/mnt/c/instagram-course/instagram-post-generator/ページ構成作成フロー_段階別ドキュメント参照方式_マスタードキュメント.md`

- **段階3-4のみ実行**: 既定パターンのJSONファイル作成
- **段階1-2はスキップ**: パターン仕様は判断基準マスタードキュメント.mdで確定済み

**⚠️ 注意**: JSONファイル作成が必要な場合は、ページ構成作成フローを完了してから、コンテンツ分析フローのStep 3.5に戻る

##### Step 3.5: 最終的なページ構成確定
```json
{
  "pageStructurePattern": "typeID002-sequential-dependency",
  "templateOverrides": {
    "3": "ng_good_comparison",
    "4": "category_explanation",
    "5": "category_explanation",
    "6": "vision_strength_matrix"
  }
}
```

#### ⚠️ 重要な制約
- **既存パターン優先使用**
- **新パターン作成は最小限に抑制**
- **JSON作成方法は考慮しない**

---

### 【段階4】JSON作成
#### 📚 参照ドキュメント
- **`/mnt/c/instagram-course/instagram-post-generator/KxxxJSONフォーマットマスタードキュメント.md`のみ**
- **段階1-3の全結果**

#### 🎯 作成手順

##### Step 4.1: 基本フィールド設定
```json
{
  "source": "contents-117",
  "problemCategory": "就活スキル習得",
  "problemDescription": "...",
  "postType": "002",  // 段階1の結果
  "postTypeReason": "...",
  "pageStructurePattern": "typeID002-sequential-dependency"  // 段階3の結果
}
```

##### Step 4.2: solutionContent構造化
```json
{
  "solutionContent": {
    "概要": "...",
    "具体的手順": [...],
    "提供情報": [...],
    "実用的なアドバイス": [...]
  }
}
```

##### Step 4.3: templateOverrides設定
```json
{
  "templateOverrides": {  // 段階3で必要と判断された場合のみ
    "3": "ng_good_comparison",
    "4": "category_explanation",
    "5": "category_explanation",
    "6": "vision_strength_matrix"
  }
}
```

##### Step 4.4: detailedContent構造化
```json
{
  "detailedContent": {
    "page1": { "role": "...", "layout": "...", "content": {...} },
    "page2": { "role": "...", "layout": "...", "content": {...} },
    // ...各ページの詳細構造
  }
}
```

#### ⚠️ 重要な制約
- **CTA要素は削除**（savePrompt, cta, finalPageOffer）
- **純粋なコンテンツのみ記載**
- **汎用的な表現に統一**

---

### 【段階5】システム登録
#### 📚 参照ドキュメント
- **`/mnt/c/instagram-course/instagram-post-generator/app/data/knowledgeBase/type-target-persona-relations.json`**
- **段階2の結果**（targetId）

#### 🎯 登録手順

##### Step 5.1: ペルソナID割り当て
```json
{
  "personaId": "P118"  // K118 → P118
}
```

##### Step 5.2: targetToPersonas更新
```json
{
  "T007": [...既存のペルソナ..., "P118"]  // 段階2で決定したターゲットID
}
```

##### Step 5.3: personaToKnowledge追加
```json
{
  "P118": ["K118"]  // ペルソナとナレッジの紐付け
}
```

#### ⚠️ 重要な制約
- **ターゲットIDは段階2の結果を使用**
- **ペルソナIDはナレッジIDと同じ番号**
- **既存の配列に追加する際はカンマを忘れない**

## 📊 実践例：K117の完全フロー

### 【段階1】投稿タイプ判断
**参照**: `/mnt/c/instagram-course/instagram-post-generator/投稿タイプ判断基準マスタードキュメント.md`

#### 分析プロセス
1. **Problem**: 志望動機の作り方がわからない・企業研究が浅い
2. **Solution**: 志望動機に必要な4つのポイントとNG/GOOD例による具体的解説
3. **本質**: 実践的なノウハウ伝授による「できるようになりたい」の支援

#### 判断結果
```json
{
  "postType": "002",
  "postTypeReason": "志望動機作成の4つのポイントを段階的に学習する実践的ノウハウ伝授型コンテンツ"
}
```

---

### 【段階2】ターゲット判断
**参照**: `/mnt/c/instagram-course/instagram-post-generator/ターゲット判断基準マスタードキュメント.md`

#### 分析プロセス
1. **投稿タイプ**: TypeID=002 → 候補はT007-T012
2. **対象者**: 就活生 → T007, T008に絞り込み
3. **ニーズ**: 就活ノウハウによる差別化 → T007

#### 判断結果
```json
{
  "targetId": "T007",
  "targetReason": "対策方法やノウハウによって就活で差をつけたい学生"
}
```

---

### 【段階3】ページ構成判断
**参照**: `/mnt/c/instagram-course/instagram-post-generator/ページ構成判断基準マスタードキュメント.md`

#### 分析プロセス
1. **順序依存性**: ポイント1→2→3→4の順序で学習が必要 ✓
2. **基本パターン**: TypeID=002-順序依存型ステップフロー
3. **INDEXページ**: 4つのポイント提示が必要 ✓
4. **templateOverrides**: NG/GOOD比較、カテゴリ説明、マトリックス分析が必要 ✓

#### 判断結果
```json
{
  "pageStructurePattern": "typeID002-sequential-dependency",
  "templateOverrides": {
    "3": "ng_good_comparison",
    "4": "category_explanation",
    "5": "category_explanation",
    "6": "vision_strength_matrix"
  }
}
```

---

### 【段階4】JSON作成
**参照**: `/mnt/c/instagram-course/instagram-post-generator/KxxxJSONフォーマットマスタードキュメント.md`

#### 最終的なKxxxJSON
完全なK117.json（前回作成済み）

## 🚨 段階別制約・禁止事項

### 【段階1】制約
- [ ] **他のマスタードキュメントを読まない**
- [ ] **ターゲットを考慮しない**
- [ ] **ページ構成を考慮しない**
- [ ] **Problem-Solutionの本質のみに集中**

### 【段階2】制約  
- [ ] **投稿タイプ決定後の6個からのみ選択**
- [ ] **24個全体から選ばない**
- [ ] **ページ構成を考慮しない**
- [ ] **対象者・性別・ニーズの3要素で判断**

### 【段階3】制約
- [ ] **既定パターンから選択**（ページ構成判断基準マスタードキュメント.md準拠）
- [ ] **選択パターンのJSONファイル存在確認**
- [ ] **未実装の場合はページ構成作成フロー実行**
- [ ] **新パターン創出は禁止**
- [ ] **JSON作成方法を考慮しない**

### 【段階4】制約
- [ ] **CTA要素を削除**
- [ ] **純粋なコンテンツのみ記載**
- [ ] **汎用的な表現に統一**
- [ ] **マスタードキュメント準拠を確認**

## ✅ 品質保証チェックリスト

### 各段階完了時チェック
- [ ] **段階1**: postTypeとpostTypeReasonが明確
- [ ] **段階2**: targetIdとtargetReasonが適切
- [ ] **段階3**: pageStructurePatternとtemplateOverridesが設定、実装ファイル確認済み
- [ ] **段階4**: 完全なKxxxJSONが作成

### 最終品質チェック
- [ ] **整合性**: 全段階の判断結果が一貫している
- [ ] **準拠性**: 各マスタードキュメントに準拠している
- [ ] **完全性**: 必須フィールドが全て設定されている
- [ ] **純粋性**: CTA要素が完全に除去されている

## 🎯 このフローの利点

### 1. **集中力維持**
- 一度に一つの判断に集中
- 認知負荷の軽減
- 判断精度の向上

### 2. **先入観排除**
- 次段階の基準が判断に影響しない
- 純粋な判断基準の適用
- バイアスの最小化

### 3. **段階的確信**
- 前段階の結果を基に次段階を判断
- 論理的な積み重ね
- 一貫性の保証

### 4. **体系的品質**
- 各段階での品質チェック
- 最終的な整合性確認
- 標準化された品質

## 🔄 運用指針

### 初回実施時
1. **各段階を厳密に分離**
2. **制約を厳格に守る**
3. **判断根拠を明確に記録**

### 習熟後
1. **段階別の判断パターンを蓄積**
2. **よくある判断ミスを記録**
3. **フロー改善点を継続的に更新**

---

**作成日**: 2025-07-27  
**バージョン**: 1.0  
**基準**: K117実装完了・4つのマスタードキュメント確定時点  
**重要度**: 最高 - 全ナレッジベース分析の標準プロセス  
**参照**: 
- `投稿タイプ判断基準マスタードキュメント.md`
- `ターゲット判断基準マスタードキュメント.md`
- `ページ構成判断基準マスタードキュメント.md`
- `ページ構成作成フロー_段階別ドキュメント参照方式_マスタードキュメント.md`
- `KxxxJSONフォーマットマスタードキュメント.md`