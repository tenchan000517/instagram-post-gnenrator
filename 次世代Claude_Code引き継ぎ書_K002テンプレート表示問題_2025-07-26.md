# 次世代Claude Code引き継ぎ書：K002テンプレート表示問題

## 🚨 現在の状況

### ✅ 正常に動作している部分
1. **ナレッジベース選択・マッチング**: K002が正常に選択され、適切にマッチングされている
2. **ページ構造読み込み**: `typeID002-sequential-dependency`パターンが正常に読み込まれている
3. **コンテンツ生成**: 8ページ全てのコンテンツが正常に生成されている
4. **テンプレートタイプ割り当て**: `basic_intro`（1ページ）、`step_guide_achievement`（2-8ページ）が正しく設定されている

### ❌ 問題箇所
**生成されたコンテンツがUIに表示されない**
- データは正常に生成されているが、テンプレートに挿入されずUI表示に失敗

## 📊 生成されたデータ構造（正常）

```javascript
{
  "pages": [
    {
      "pageNumber": 1,
      "templateType": "basic_intro",
      "templateData": {
        "title": "女性が\"困らない\"働き方のヒント",
        "targetAudience": "あなたはこんなことない？",
        "problems": ["これからの未来に不安しかない", ...],
        "additionalMessage": "キャリアに迷う女性が知っておきたいこと。人生100年時代、一生安心できるキャリアを築きましょう！",
        "savePrompt": "メモが画面な人は1タップで保存完了！"
      }
    },
    {
      "pageNumber": 2,
      "templateType": "step_guide_achievement",
      "templateData": {
        "pointNumber": "1",
        "title": "働き方の選択肢＝人生の選択肢",
        "content": ["結婚、出産、育児…女性のキャリアはライフイベントによって大きく変化します。", ...],
        "actionItems": []
      }
    }
    // ... 8ページまで正常に生成
  ]
}
```

## 🔍 推測される問題原因

### 1. テンプレートコンポーネントへのデータ受け渡し問題
- `templateData`から実際のテンプレートコンポーネントpropsへの変換が失敗している可能性
- 新しく作成したテンプレート（`BasicIntroTemplate`, `StepGuideAchievementTemplate`）の呼び出し方法に問題

### 2. UIレンダリング部分の問題
- `EditablePostGenerator.tsx`または`NewFlowPostGenerator.tsx`でのテンプレート表示ロジックに問題
- `templateComponents`マッピングの問題

### 3. データ形式の不一致
- 生成された`templateData`の構造と、テンプレートコンポーネントが期待するprops構造の不一致

## 🎯 実装完了済みファイル

### ✅ 作成済みテンプレートファイル
- `app/components/templates/BasicIntroTemplate.tsx`
- `app/components/templates/StepGuideAchievementTemplate.tsx`
- `app/components/templates/AchievementSummaryTemplate.tsx`

### ✅ 登録済み設定ファイル
- `app/components/templates/index.ts` - export・import・componentMap追加済み
- `app/components/templates/TemplateTypes.ts` - 型定義追加済み
- `app/components/templates/TemplateRegistry.ts` - メタデータ登録済み

### ✅ ページ構造定義
- `app/services/knowledgeBase/data/pageStructures/typeID002-sequential-dependency.json`
- `app/services/knowledgeBase/PageStructureMatcher.ts` - インポート・マッピング追加済み

### ✅ ナレッジベースファイル
- `app/data/knowledgeBase/knowledge/K002.json` - K115形式に統一済み

## 🔧 次に調査・修正すべき箇所

### 1. テンプレートレンダリング確認
**ファイル**: `app/components/EditablePostGenerator.tsx` 
**確認点**: `renderCurrentPage`関数での新テンプレート呼び出し

### 2. データマッピング確認
**ファイル**: `app/services/contentGeneratorService.ts`
**確認点**: `templateData`から各テンプレートコンポーネントpropsへの変換ロジック

### 3. テンプレートコンポーネントマップ確認
**ファイル**: `app/components/templates/index.ts`
**確認点**: `templateComponents`の`basic_intro`と`step_guide_achievement`のマッピング

### 4. UIコンポーネント側の受け渡し確認
**確認点**: 
- `templateType`と`templateData`がUIコンポーネントに正しく渡されているか
- 新しいテンプレートタイプが既存のレンダリングロジックで処理されているか

## 🎯 想定される修正内容

### 修正1: テンプレートデータの変換
生成された`templateData`を各テンプレートのprops形式に正しく変換する処理の追加・修正

### 修正2: UIレンダリングロジックの更新
新しいテンプレートタイプ（`basic_intro`, `step_guide_achievement`）に対応したレンダリングロジックの追加

### 修正3: デバッグログの追加
テンプレート呼び出し時のデータ状態を確認するためのログ追加

## 💡 デバッグ手順

1. **ブラウザDevToolsでコンソールログ確認**
   - エラーメッセージの有無
   - テンプレートコンポーネントが呼び出されているか

2. **データフロー追跡**
   - 生成された`templateData`が各段階でどう変換されているか
   - UIコンポーネントに到達時のデータ形式

3. **テンプレートコンポーネント個別テスト**
   - 新しく作成したテンプレートコンポーネントが独立して動作するか

## 🚀 期待される結果

修正完了後、K002ナレッジベースから生成されたコンテンツが：
- 1ページ目：`BasicIntroTemplate`で正しく表示
- 2-8ページ目：`StepGuideAchievementTemplate`で正しく表示（misaki.png画像付き）
- 全ページで生成されたコンテンツデータが適切にテンプレートに挿入される

---

**優先度**: 🔥 最高（システムの基本機能に関わる）
**推定作業時間**: 1-2時間
**作業者**: 次世代Claude Code