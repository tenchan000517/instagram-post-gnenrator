# ナレッジベース統合システム完全フロー解説

## 📚 概要
ユーザーがナレッジベースを選択してコンテンツ生成を実行した場合の、handleContentSubmit実行後の完全なデータフローを解説します。

---

## 🎬 開始時点の状況
```javascript
// ContentInputから親に渡されるデータ
content = "【ジャンル】: knowhow [ガクチカ作成法]:長期インターン未経験でも内定を掴む！4ステップで..."

knowledgeBaseParams = {
  typeId: "001",
  targetId: "T001", 
  personaIds: ["P001", "P004"],
  knowledgeIds: ["K004"], // AI判定でK001を除外、K004のみ残った
  knowledgeContents: [
    {
      knowledgeId: "K004",
      actualTitle: "自分を見直してみよう！自己分析の方法5選",
      problemDescription: "自己分析の方法がわからない、何から始めればいいか迷っている就活生の悩み",
      solutionContent: {
        methods: [...], // 自己分析の具体的手法データ
        keyMessage: "自己分析は繰り返しやることが大事！"
      },
      searchKeywords: ["自己分析", "方法", "就活", "自分史", "なぜの深掘り"...],
      effectiveExpressions: ["自分を見直してみよう！", "そもそもなぜ自己分析が必要？"...],
      emotionalTriggers: ["行動促進", "学習意欲", "継続重視"]
    }
  ],
  useKnowledgeBase: true
}
```

---

## 🚀 ステップ1: 親コンポーネントでの受け取り

**場所:** `NewFlowPostGenerator.tsx` - `handleContentSubmit()`

**何をする:** ユーザー入力とナレッジ選択結果を受け取って、画面状態を更新し、コンテンツ生成サービスを呼び出す

**処理内容:**
```javascript
const handleContentSubmit = async (content, knowledgeBaseParams) => {
  // 画面状態の更新
  setInputContent(content) // 入力内容を保存
  setCurrentStep('generation') // 「生成中」画面に切り替え
  setIsGenerating(true) // 生成フラグをON
  setGenerationStatus('AIが高品質なコンテンツを生成中...')
  
  // メインのコンテンツ生成サービス呼び出し
  const generated = await contentGeneratorService.generateHighQualityContent(
    content, // ユーザーの投稿内容（長文）
    knowledgeBaseParams // 選択されたナレッジ情報
  )
}
```

---

## 📋 ステップ2: コンテンツ生成サービス開始

**場所:** `contentGeneratorService.ts` - `generateHighQualityContent()`

**何をする:** 2段階フローでコンテンツを生成する。1段階目でページ構造を決定し、2段階目でコンテンツを生成する

**処理内容:**
```javascript
async generateHighQualityContent(userInput, knowledgeBaseParams) {
  // 同時実行防止（503エラー対策）
  if (this.isGenerating) {
    throw new Error('AI生成が進行中です。少し待ってから再度お試しください。')
  }
  this.isGenerating = true
  
  console.log('🚀 2段階フロー開始...')
  
  // ★1段階目: ページ構造決定
  console.log('📋 段階1: ページ構造分析中...')
  const pageStructures = await pageStructureAnalyzer.analyzePageStructureAndTemplates(
    userInput, // "【ジャンル】: knowhow [ガクチカ作成法]..."
    knowledgeBaseParams // 選択済みナレッジ情報
  )
}
```

**引数の詳細:**
- `userInput`: ユーザーが入力した投稿内容の全文
- `knowledgeBaseParams`: AI判定で絞り込まれたK004のナレッジデータを含む完全な情報

---

## 🔍 ステップ3: ページ構造分析の開始

**場所:** `pageStructureAnalyzer.ts` - `analyzePageStructureAndTemplates()`

**何をする:** 入力からジャンルを判定し、ナレッジベース使用の場合は専用の統合システムを実行する

**処理内容:**
```javascript
async analyzePageStructureAndTemplates(input, knowledgeBaseParams) {
  // ジャンル情報の抽出・判定
  const specifiedGenre = this.extractGenreFromInput(input) // "knowhow"を抽出
  const detectedGenre = specifiedGenre || this.genreDetector.detectGenre(input)
  
  console.log(`🎯 ジャンル判定結果: ${detectedGenre}`) // "knowhow"
  
  // ★重要な分岐点: ナレッジベース統合システムを使用するか？
  if (knowledgeBaseParams?.useKnowledgeBase && 
      knowledgeBaseParams.typeId && 
      knowledgeBaseParams.targetId) {
    
    console.log('🚀 ナレッジベース統合システム実行')
    return this.generateStructuredContent(input, knowledgeBaseParams)
  } else {
    // 従来のAI分析ルート（今回は実行されない）
    return this.従来のAI分析()
  }
}
```

**判定結果:**
- `specifiedGenre = "knowhow"` (入力から抽出)
- `useKnowledgeBase = true` なので統合システムルートに進む

---

## 🎯 ステップ4: ナレッジベース統合システム実行

**場所:** `pageStructureAnalyzer.ts` - `generateStructuredContent()`

**何をする:** TypeIDとTargetIDを使って厳密にマッチするページ構造を取得し、テンプレートマッピングを実行する

**処理内容:**
```javascript
private async generateStructuredContent(input, params) {
  console.log('🎯 新統合システム開始:', {
    typeId: params.typeId,    // "001"
    targetId: params.targetId // "T001"
  })
  
  // ★サブステップ4-1: ページ構造の厳密マッチング
  const { pattern, structure } = PageStructureMatcher.getCompletePageStructure(
    params.typeId,   // "001" (就活ハウツー系)
    params.targetId  // "T001" (新卒向け)
  )
  
  console.log('✅ ページ構造マッチング成功:', pattern.description)
  // → "就活ハウツー×新卒向け 5ページ構成"のような構造が決定
  
  // ★サブステップ4-2: テンプレート項目マッピング
  const mapper = new TemplateItemMapper()
  const mappingResult = await mapper.mapContentToPages(
    input,     // ユーザー投稿内容
    structure  // 決定されたページ構造定義
  )
}
```

**引数の詳細:**
- `params.typeId = "001"`: 投稿タイプ（就活ハウツー系）
- `params.targetId = "T001"`: ターゲット（新卒向け）
- `structure`: マッチしたページ構造の詳細定義（何ページ目にどのテンプレートを使うかなど）

---

## 📊 ステップ5: テンプレート項目マッピング

**場所:** `TemplateItemMapper.ts` - `mapContentToPages()`

**何をする:** 決定されたページ構造に基づいて、ユーザー入力から各ページの具体的な項目を抽出する

**処理内容:**
```javascript
async mapContentToPages(input, pageStructure) {
  console.log(`🎯 Starting template item mapping for: ${pageStructure.name}`)
  console.log(`📄 Processing ${pageStructure.pages.length} pages`)
  
  const mappedPages = []
  
  // 各ページを順番に処理
  for (const page of pageStructure.pages) {
    // ★各ページごとのマッピング実行
    const mappedContent = await this.mapSinglePage(
      input,                           // ユーザー投稿内容
      page,                           // 現在処理中のページ定義
      pageStructure.targetCombination // "001-T001"のような組み合わせ
    )
    
    mappedPages.push(mappedContent)
    console.log(`✅ Page ${page.pageNumber} mapped successfully`)
  }
}
```

**pageStructure の例:**
```javascript
{
  name: "就活ハウツー×新卒向け 5ページ構成",
  pages: [
    {
      pageNumber: 1,
      templateId: "basic-title",
      title: "タイトルページ",
      role: "introduction"
    },
    {
      pageNumber: 2, 
      templateId: "simple-items",
      title: "自己分析の方法",
      role: "method-explanation"
    },
    // ... 3〜5ページ
  ]
}
```

---

## 🔍 ステップ6: 単一ページのマッピング処理

**場所:** `TemplateItemMapper.ts` - `mapSinglePage()`

**何をする:** 1ページ分の具体的なコンテンツを、ナレッジベースから抽出またはAI生成で作成する

**処理内容:**
```javascript
private async mapSinglePage(input, page, targetCombination) {
  console.log(`🔍 Mapping page ${page.pageNumber}: ${page.role}`)
  
  try {
    // ★現在の問題箇所: ナレッジベースからの抽出
    const mappedItems = await this.extractFromKnowledgeBase(
      input,             // ユーザー投稿内容
      page,             // ページ定義（templateId, roleなど）
      targetCombination // "001-T001"
    )
    
    return {
      pageNumber: page.pageNumber,    // 2
      templateId: page.templateId,    // "simple-items" 
      title: page.title,              // "自己分析の方法"
      mappedItems: mappedItems        // 抽出されたコンテンツ
    }
  } catch (error) {
    // フォールバック: AI生成
    console.warn('⚠️ Knowledge base extraction failed, falling back to AI generation')
    const aiGeneratedItems = await this.generateWithAI(input, page)
    return { /* AI生成結果 */ }
  }
}
```

---

## ❌ ステップ7: 現在の問題箇所 - ナレッジベース抽出

**場所:** `TemplateItemMapper.ts` - `extractFromKnowledgeBase()`

**現在の問題:** 既に選択済みのK004ナレッジデータを無視して、再度推定・検索している

**現在の処理内容:**
```javascript
private async extractFromKnowledgeBase(input, page, targetCombination) {
  // ❌ 問題1: 入力から再推定（既に選択済みなのに）
  const personaId = this.extractPersonaFromInput(input)           // 推定でP002?
  const category = this.extractCategoryFromPageRole(page.role)    // "self-analysis"
  const emotionalTrigger = this.extractEmotionalTriggerFromInput(input) // "motivation"
  
  // ❌ 問題2: 再検索（選択済みデータがあるのに）
  const searchResults = this.knowledgeSearch.searchPinpoint(
    personaId,       // 推定値
    category,        // 推定値  
    emotionalTrigger // 推定値
  )
  
  // 検索結果から最適なものを選択
  const bestMatch = searchResults[0]
  return this.formatDataForTemplate(bestMatch, page)
}
```

**本来あるべき処理:**
```javascript
// ✅ 正しい処理（実装すべき）
private async extractFromKnowledgeBase(input, page, targetCombination, knowledgeContents) {
  // 選択済みのナレッジデータ（K004）を直接使用
  const selectedKnowledge = knowledgeContents[0] // K004のデータ
  
  console.log(`✅ Using pre-selected knowledge: ${selectedKnowledge.knowledgeId}`)
  
  // K004の内容を直接テンプレート形式に変換
  return this.formatSelectedKnowledgeForTemplate(selectedKnowledge, page)
}
```

---

## 🔄 ステップ8: 結果の変換と返却

**場所:** `pageStructureAnalyzer.ts` に戻る

**何をする:** マッピング結果をPageStructure形式に変換して返却

**処理内容:**
```javascript
// マッピング完了後
const pageStructures = mappingResult.pages.map(page => ({
  概要: `ナレッジベース統合システムによる最適化コンテンツ`,
  有益性: `TypeID×TargetID厳密マッチングによる最適化された価値提供`,
  template: page.templateId,    // "simple-items"
  title: page.title,           // "自己分析の方法"
  theme: JSON.stringify(page.mappedItems), // 抽出されたコンテンツ
  isStructuredGeneration: true // 新統合システム識別フラグ
}))

return pageStructures
```

---

## 🎉 ステップ9: 最終的な結果処理

**場所:** `contentGeneratorService.ts` に戻る

**何をする:** 新統合システムの結果を従来形式に変換し、キャプション・ハッシュタグを生成

**処理内容:**
```javascript
// 新統合システム結果の検出
if (pageStructures.length > 0 && pageStructures[0].isStructuredGeneration) {
  console.log('🚀 新統合システム結果検出 - 段階2をスキップ')
  
  // 従来形式への変換
  return this.convertStructuredGenerationResult(pageStructures, userInput)
}
```

**convertStructuredGenerationResult()の処理:**
```javascript
// PageStructure → GeneratedContent 形式変換
const pages = pageStructures.map(structure => ({
  pageNumber: index + 1,
  templateType: structure.template,
  content: JSON.parse(structure.theme), // 具体的なコンテンツデータ
  rawContent: structure.概要
}))

// キャプションとハッシュタグ生成
const caption = await captionService.generateCaption(userInput, pages)
const hashtags = hashtagService.generateHashtagSets(userInput)

return {
  pages: pages,        // 生成されたページ配列
  totalPages: pages.length,
  caption: caption,    // Instagram用キャプション
  hashtags: hashtags   // ハッシュタグセット
}
```

---

## 🏁 ステップ10: 親コンポーネントでの完了処理

**場所:** `NewFlowPostGenerator.tsx` に戻る

**何をする:** 生成結果を受け取って画面を更新、ユーザーに結果を表示

**処理内容:**
```javascript
// コンテンツ生成完了
const generated = await contentGeneratorService.generateHighQualityContent(content, knowledgeBaseParams)

console.log('🎨 高品質コンテンツ生成成功 - 生のデータ')
console.log('生成されたコンテンツ:', JSON.stringify(generated, null, 2))

// 画面状態の更新
setGeneratedContent(generated)  // 生成結果を保存
setCurrentStep('approval')      // 「承認」画面に移行
setIsGenerating(false)          // 生成フラグをOFF
```

**最終的なgenerated オブジェクト:**
```javascript
{
  pages: [
    {
      pageNumber: 1,
      templateType: "basic-title",
      content: {
        title: "長期インターン未経験でも内定を掴む！",
        subtitle: "4ステップで完成させる最強の自己PR"
      }
    },
    {
      pageNumber: 2,
      templateType: "simple-items", 
      content: {
        title: "自己分析の方法5選",
        items: ["自分史の作成", "「なぜ」の深掘り", "モチベーショングラフ", ...]
      }
    }
    // ... 残りのページ
  ],
  totalPages: 5,
  caption: "長期インターン未経験でも大丈夫！ガクチカ作成の4ステップを解説✨...",
  hashtags: {
    primary: ["#ガクチカ", "#就活", "#自己分析"],
    secondary: ["#就活生", "#新卒", "#面接対策"],
    // ...
  }
}
```

---

## ⚠️ 現在の重要な問題

**問題箇所:** ステップ7の `extractFromKnowledgeBase()` 

**問題内容:** 
- ContentInputで苦労してAI判定で選択したK004ナレッジデータを完全に無視
- 再度推定・検索を行って、精度の低い結果を使用している

**解決方法:**
`knowledgeBaseParams.knowledgeContents` に含まれる選択済みK004データを直接活用するように修正が必要

これにより、自己分析に関する具体的な手法・表現・キーワードが正確にInstagram投稿に反映される。