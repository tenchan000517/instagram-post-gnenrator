# Instagram投稿生成システム - シンプルフロー図

## 📋 システム処理フロー（6段階）

```
┌─────────────────────────────────────────────────────────────────┐
│                        📝 ユーザー入力                           │
│               「志望動機作成のノウハウを教えて」                   │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│             🎯 段階1: ジャンル判定・抽出                          │
├─────────────────────────────────────────────────────────────────┤
│ 📁 genreDetector.ts                                            │
│ ┣━ GenreDetector.detectGenre()                                 │
│ ┗━ キーワードマッチング → 'knowhow' ジャンル確定                 │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│           🏗️ 段階2: ページ構成決定                               │
├─────────────────────────────────────────────────────────────────┤
│ 📁 pageStructureAnalyzer.ts                                   │
│ ┣━ analyzePageStructureAndTemplates()                          │
│ ┣━ ジャンル設定 (knowhow: 3-5項目)                             │
│ ┣━ AI プロンプト生成・実行                                       │
│ ┗━ ページ構造配列決定 → [ページ1, ページ2, ページ3, ページ4]       │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│          🎨 段階3: テンプレート選択 (各ページ毎)                   │
├─────────────────────────────────────────────────────────────────┤
│ 現在のフロー内で決定                                              │
│ ┣━ ページ1: 'index' テンプレート                                 │
│ ┣━ ページ2: 'simple5' テンプレート                               │
│ ┣━ ページ3: 'section-items' テンプレート                        │
│ ┗━ ページ4: 'checklist-enhanced' テンプレート                   │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│            🔨 段階4: コンテンツ生成                               │
├─────────────────────────────────────────────────────────────────┤
│ 📁 structureConstrainedGenerator.ts                           │
│ ┣━ generateAllPagesWithConstraints()                           │
│ ┣━ templateStructureDefinitions.ts → 構造要件取得               │
│ ┣━ AI 一括コンテンツ生成                                         │
│ ┗━ JSON解析・データ整理                                          │
│                                                               │
│ 生成例:                                                        │
│ ┣━ ページ1: { title: "...", items: [...] }                    │
│ ┣━ ページ2: { title: "...", steps: [...] }                    │
│ ┣━ ページ3: { title: "...", sections: [...] }                 │
│ ┗━ ページ4: { title: "...", checklistItems: [...] }           │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│           🎯 段階5: データ変換・挿入                               │
├─────────────────────────────────────────────────────────────────┤
│ 📁 contentGeneratorService.ts                                 │
│ ┗━ convertToTemplateData()                                     │
│                                                               │
│ 変換処理:                                                      │
│ ┣━ AI生成データ → TemplateData形式                              │
│ ┣━ 各テンプレート専用フィールドにマッピング                        │
│ ┗━ 型安全なデータ構造に統一                                      │
│                                                               │
│ 変換例:                                                        │
│ ┣━ simple5: { steps: [...] } → TemplateData                   │
│ ┣━ section-items: { sections: [...] } → TemplateData         │
│ ┗━ checklist-enhanced: { checklistItems: [...] } → TemplateData│
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│            🖼️ 段階6: テンプレート表示                             │
├─────────────────────────────────────────────────────────────────┤
│ 📁 EditablePostGenerator.tsx                                  │
│ ┗━ テンプレート統合表示・編集管理                                 │
│                                                               │
│ 表示フロー:                                                    │
│ ┣━ TemplateRegistry.getComponent(templateType)                │
│ ┣━ 対応テンプレートコンポーネント取得                             │
│ ┣━ TemplateData をコンポーネントに渡す                           │
│ ┗━ 画面表示 + 編集機能                                          │
│                                                               │
│ 表示例:                                                        │
│ ┣━ IndexTemplate.tsx ← index データ                           │
│ ┣━ Simple5Template.tsx ← simple5 データ                       │
│ ┣━ SectionItemsTemplate.tsx ← section-items データ            │
│ ┗━ ChecklistEnhancedTemplate.tsx ← checklist-enhanced データ   │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 データフロー詳細

### 入力データの変化
```
ユーザー入力 (文字列)
    ↓
ジャンル情報 (Genre型)
    ↓
ページ構造配列 (PageStructure[])
    ↓
生成コンテンツ (GeneratedPage[])
    ↓
テンプレートデータ (TemplateData[])
    ↓
画面表示 (React Component)
```

### 主要な型の流れ
```
string → Genre → PageStructure[] → GeneratedPage[] → TemplateData[] → JSX.Element[]
```

## 🎯 重要なポイント

### 1. テンプレート選択タイミング
- **段階2**: ページ構造決定時に各ページのテンプレートが確定
- **段階3**: 実質的にはすでに決定済み（選択段階は含まれる）

### 2. データ変換の重要性
- **段階4**: AI生成データ（動的フィールド名）
- **段階5**: テンプレート固定フィールド名に変換
- **不整合が発生しやすい箇所**

### 3. 二重のテンプレート管理
- **PageStructureAnalyzer**: テンプレート選択
- **TemplateMatchingService**: 再選択（現在は実質未使用）
- **競合の可能性あり**

## 📊 フロー中の主要ファイル

### 必ず通るファイル (6個)
1. `genreDetector.ts` - ジャンル判定
2. `pageStructureAnalyzer.ts` - 構造決定
3. `structureConstrainedGenerator.ts` - コンテンツ生成
4. `contentGeneratorService.ts` - データ変換
5. `EditablePostGenerator.tsx` - 表示制御
6. 各`*Template.tsx` - 最終表示

### 影響を受けやすいファイル (10個)
1. `TemplateTypes.ts` - 型定義
2. `TemplateRegistry.ts` - テンプレート管理
3. `templateStructureDefinitions.ts` - 構造制約
4. `templateMatchingService.ts` - 選択ロジック
5. `genre.ts` - ジャンル設定
6. 各`*Editor.tsx` - 編集機能

## 🚨 現在の課題

### 1. 同一テンプレート連続選択
- 全ページが `section-items` になる問題
- PageStructureAnalyzer の選択ロジック要改善

### 2. データ変換エラー
- AI動的フィールド → テンプレート固定フィールド
- convertToTemplateData() の型不整合

### 3. フロー統合度
- 6段階の連携不足
- エラーハンドリングの分散

---

このシンプルフロー図により、システム全体の動作を把握し、修正対象の特定が容易になります。