# ナレッジベース対応パターン実装ガイドライン

## 📋 概要
このドキュメントは、新しいナレッジベース（Kxxx）に対応したテンプレートパターンを実装する際の標準的なプロセスをまとめたものです。K002の実装を例に、必要な全ステップを網羅しています。

## 🎯 実装プロセス全体像

### 1. 調査フェーズ

#### 1.1 ナレッジベースファイルの確認
```bash
# 対象ファイルの場所
app/data/knowledgeBase/knowledge/K002.json
```

**確認ポイント：**
- `pageStructurePattern`フィールドの値（例：`typeID002-sequential-dependency`）
- `detailedContent`内の各ページの構造
- 各ページの`content`フィールドに含まれるデータ構造
- 画像フィールド（`illustrationImage`など）の有無

#### 1.2 既存テンプレートとのマッチング確認
```bash
# テンプレート一覧
app/components/templates/
```

**判断基準：**
- 既存テンプレートで表現可能か？
- 新規テンプレートが必要か？
- 必要なデータ構造は何か？

### 2. ナレッジベースファイルの修正

#### 2.1 K115形式への統一
古い形式のナレッジベースは、K115形式に統一する必要があります。

**必須フィールド：**
```json
{
  "knowledgeId": "K002",
  "pageStructurePattern": "typeID002-sequential-dependency",
  "actualTitle": "タイトル",
  "pageCount": 8,
  "contentPageCount": 7,
  "detailedContent": {
    "page1": {
      "role": "導入・問題提起",
      "layout": "基本紹介形式", 
      "section": "intro",
      "content": {
        // ページ固有のデータ
      }
    }
  }
}
```

### 3. パターンの特定とページ構造定義

#### 3.1 ページ構造ファイルの作成/確認
```bash
# ファイルパス
app/services/knowledgeBase/data/pageStructures/typeID002-sequential-dependency.json
```

**構造例：**
```json
{
  "id": "typeID002-sequential-dependency",
  "name": "TypeID002 順序依存型ステップフロー",
  "pages": [
    {
      "pageNumber": 1,
      "templateId": "basic_intro",
      "templateStructure": {
        "title": "string",
        "targetAudience": "string",
        "problems": "string[]",
        "additionalMessage": "string",
        "savePrompt": "string"
      }
    }
  ]
}
```

#### 3.2 PageStructureMatcherへの登録
```typescript
// app/services/knowledgeBase/PageStructureMatcher.ts
import typeID002SequentialDependency from './data/pageStructures/typeID002-sequential-dependency.json'

// structureMappingに追加
'typeID002-sequential-dependency': typeID002SequentialDependency
```

### 4. テンプレートの作成

#### 4.1 新規テンプレートコンポーネントの作成
```bash
# 作成するファイル例
app/components/templates/BasicIntroTemplate.tsx
app/components/templates/StepGuideAchievementTemplate.tsx
```

**テンプレート構造の基本形：**
```typescript
interface TemplateProps {
  data: {
    // 必要なフィールド定義
    title?: string;
    content?: string[];
    illustrationImage?: string; // 画像使用時
  };
}

export default function TemplateComponent({ data }: TemplateProps) {
  const {
    title = '',
    content = [],
    illustrationImage
  } = data || {};
  
  return (
    // JSXコンポーネント
  );
}

export const templateMetadata: TemplateMetadata = {
  id: 'template_id',
  name: 'テンプレート名',
  // その他メタデータ
}
```

### 5. 画像使用バージョンの注意点

#### 5.1 画像フィールドの処理
- Next.jsのImageコンポーネントより、通常の`<img>`タグを使用
- パスは`/public`フォルダからの相対パス（例：`/misaki.png`）

#### 5.2 KnowledgeBasedContentGeneratorでの画像補完
```typescript
// AI生成後に画像フィールドを補完する処理
if (currentPageData?.content?.illustrationImage && !parsedContent.illustrationImage) {
  parsedContent.illustrationImage = currentPageData.content.illustrationImage
}
```

#### 5.3 テンプレート構造定義での画像フィールド
```typescript
'step_guide_achievement': {
  pointNumber: 'string',
  title: 'string',
  content: 'string[]',
  actionItems: 'string[]?',
  illustrationImage: 'string?' // 画像フィールドを忘れずに追加
}
```

### 6. テンプレートの登録

#### 6.1 index.tsへのエクスポート追加
```typescript
// app/components/templates/index.ts

// エクスポート
export { default as BasicIntroTemplate } from './BasicIntroTemplate'
export { default as StepGuideAchievementTemplate } from './StepGuideAchievementTemplate'

// インポート
import BasicIntroTemplate from './BasicIntroTemplate'
import StepGuideAchievementTemplate from './StepGuideAchievementTemplate'

// templateComponentsマップに追加
export const templateComponents = {
  // ...既存のテンプレート
  'basic_intro': BasicIntroTemplate,
  'step_guide_achievement': StepGuideAchievementTemplate
}
```

#### 6.2 TemplateTypes.tsへの型追加
```typescript
// app/components/templates/TemplateTypes.ts
export type TemplateType = 
  | 'existing_templates'
  | 'basic_intro'
  | 'step_guide_achievement'
  // ...
```

#### 6.3 TemplateRegistry.tsへのメタデータ登録
```typescript
// app/components/templates/TemplateRegistry.ts
import { basicIntroMetadata } from './BasicIntroTemplate'
import { stepGuideAchievementMetadata } from './StepGuideAchievementTemplate'

export const templateRegistry: Record<TemplateType, TemplateMetadata> = {
  // ...既存のテンプレート
  basic_intro: basicIntroMetadata,
  step_guide_achievement: stepGuideAchievementMetadata
}
```

### 7. 動作確認とデバッグ

#### 7.1 コンソールログの確認ポイント
- `🎯 新ナレッジベース起点システム実行`
- `📋 使用するページ構成:`
- `🎨 ページX生成中...`
- `🖼️ 画像フィールドを補完:`（画像使用時）

#### 7.2 よくある問題と解決方法

**問題1: テンプレートが表示されない**
- 原因：templateComponentsマップへの登録漏れ
- 解決：index.tsの確認

**問題2: データが正しく渡されない**
- 原因：テンプレートのprops構造が不適切
- 解決：`data`プロパティから展開する形式に統一

**問題3: 画像が表示されない**
- 原因：AI生成時に画像フィールドが欠落
- 解決：KnowledgeBasedContentGeneratorで補完処理を追加

## 📝 チェックリスト

新しいナレッジベース対応パターンを実装する際は、以下のチェックリストを確認してください：

- [ ] K***ファイルの構造確認
- [ ] K115形式への統一（必要な場合）
- [ ] pageStructurePatternの値確認
- [ ] ページ構造定義ファイルの作成/更新
- [ ] PageStructureMatcherへの登録
- [ ] 必要なテンプレートコンポーネントの作成
- [ ] 画像フィールドの有無確認と対応
- [ ] templates/index.tsへの登録
- [ ] TemplateTypes.tsへの型追加
- [ ] TemplateRegistry.tsへのメタデータ登録
- [ ] KnowledgeBasedContentGeneratorのテンプレート構造定義更新
- [ ] 動作確認（コンソールログ確認）
- [ ] 画像表示の確認（画像使用時）

## 🚀 実装の流れ（要約）

1. **調査**: Kxxxファイルの構造を確認
2. **修正**: K115形式に統一（必要に応じて）
3. **定義**: ページ構造定義を作成/確認
4. **作成**: 必要なテンプレートコンポーネントを実装
5. **登録**: 各種設定ファイルに登録
6. **確認**: 動作確認とデバッグ

このガイドラインに従うことで、新しいナレッジベース対応パターンを効率的かつ確実に実装できます。