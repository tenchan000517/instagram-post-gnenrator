# ページ構成動的生成システム設計理論 - マスタードキュメント

## 📋 現在のシステム仕様

### 静的JSON読み込み方式
- ContentGeneratorServiceは静的JSONファイルを読み込む設計
- 各ナレッジの`pageStructurePattern`値に対応するJSONファイルが必要
- ファイルパス: `./knowledgeBase/data/pageStructures/${pageStructureId}.json`

### 現在の問題
- K115の`pageStructurePattern`: `"failure_story_intro,failure_episode,failure_episode,failure_episode,failure_episode,failure_episode,failure_episode,profile_offer"`
- 対応する8ページ固定の静的JSONファイルが存在しない
- システムはページ数固定パターンでないと機能しない

## 🎯 設計理論

### 問題の本質
**全ページ組み合わせだと膨大なパターン数になる**

### 解決策
**各ナレッジで`"section": "mainContent"`フィールドを動的指定**

```json
{
  "page2": { "section": "mainContent" },
  "page3": { "section": "mainContent" },
  "page4": { "section": "mainContent" }
}
```

### 理論の核心
**投稿タイプ別ドキュメントのパターン数 = 必要な静的JSONパターン数**

## 📊 パターン数の計算

### ドキュメント記載のパターン数
- **TypeID=001**: 6パターン → 6つの静的JSON
- **TypeID=002**: 3パターン → 3つの静的JSON  
- **TypeID=003**: 3パターン → 3つの静的JSON
- **TypeID=004**: 1パターン → 1つの静的JSON

### 結果
**合計13パターンで全てのナレッジに対応可能**

## 🔧 実装方式

### 静的JSONの構造
```json
{
  "pageStructureId": "typeID001-episode-parallel-intro",
  "name": "TypeID001 エピソード並列紹介型",
  "pages": [
    {
      "pageNumber": 1,
      "templateId": "failure_story_intro",
      "templateStructure": {
        "question": "string",
        "promise": "string",
        "finalPageOffer": "string",
        "cta": "string"
      }
    },
    {
      "pageNumber": "dynamic",
      "templateId": "failure_episode", 
      "templateStructure": {
        "episodeNumber": "string",
        "title": "string",
        "logo": "string",
        "description": "string",
        "failure": "string",
        "conclusion": "string",
        "savePrompt": "string",
        "question": "string"
      }
    }
  ]
}
```

### ナレッジファイルの指定
```json
{
  "pageStructurePattern": "typeID001-episode-parallel-intro",
  "detailedContent": {
    "page1": {
      "section": "intro",
      "content": { /* 実際のコンテンツ */ }
    },
    "page2": {
      "section": "mainContent", 
      "content": { /* 実際のコンテンツ */ }
    },
    "page3": {
      "section": "mainContent",
      "content": { /* 実際のコンテンツ */ }
    }
  }
}
```

## 💻 動的展開処理の実装

### ContentGeneratorServiceでの処理フロー
```typescript
for (const pageInfo of pageStructure.pages) {
  if (pageInfo.pageNumber === "dynamic") {
    // mainContentセクションのページを特定
    const mainContentPages = Object.keys(knowledgeData.detailedContent)
      .filter(key => {
        const pageData = knowledgeData.detailedContent[key]
        return pageData.section === "mainContent"
      })
      .map(key => parseInt(key.replace('page', '')))
      .sort((a, b) => a - b)

    // 各mainContentページを生成
    for (const actualPageNumber of mainContentPages) {
      // 実際のページ番号で生成処理を実行
      const result = await generator.generatePageContent({
        userInput,
        knowledgeData,
        pageStructure,
        templateStructure: pageInfo.templateStructure,
        pageNumber: actualPageNumber
      })
    }
  }
}
```

### 重要な実装ポイント
1. **セクション判定**: `pageData.section === "mainContent"`でmainContentページを特定
2. **ページ番号抽出**: `parseInt(key.replace('page', ''))`で実際のページ番号を取得
3. **順序保証**: `.sort((a, b) => a - b)`でページ順序を維持
4. **テンプレート構造統一**: 同一の`templateStructure`を全mainContentページで使用

## 🎯 設計効果

1. **パターン数の最小化**: 全組み合わせから13パターンに削減
2. **動的ページ数対応**: mainContent部分が可変長に対応
3. **システム統一**: 静的JSON読み込み方式を維持
4. **実装完了**: K115で動作確認済み（Page 1: intro, Page 2-7: mainContent）

---

**作成日**: 2025-07-25  
**重要度**: 最高 - システム設計の核心理論  
**参照ドキュメント**: 投稿タイプ別Problem-Solution構造分析.md