# ページ構成動的生成システム設計理論 - マスタードキュメント

## 🚨 【重要】ナレッジベースフォーマット統一ルール

### ✅ 正しいKxxxフォーマット（K115準拠）
**全てのナレッジベースファイルは以下の形式に統一する：**

```json
{
  "knowledgeId": "K115",
  "pageStructurePattern": "typeID001-episode-parallel-intro",  // ← 必須：外部構造参照
  "detailedContent": {
    "page1": {
      "role": "導入・問題提起",          // ← 必須：ページの役割
      "layout": "質問形式 + 自己紹介",    // ← 必須：レイアウト指定
      "section": "intro",              // ← 必須：セクション指定
      "content": {                     // ← 必須：contentオブジェクト内にデータ
        "question": "実際の質問文",
        "promise": "約束・予告文"
      }
    }
  }
}
```

### ❌ 間違った形式（旧K002形式）
```json
{
  // pageStructurePatternフィールドが存在しない
  "detailedContent": {
    "page1": {
      "template": "basic_intro",    // ❌ テンプレート直接指定
      "title": "タイトル",          // ❌ contentオブジェクト外のデータ
      "problems": []               // ❌ 構造が不統一
    }
  }
}
```

### 🚫 不要なページ・要素の除外ルール
**以下の要素は一切含めない：**
- ❌ タイトルだけのページ（情報価値なし）
- ❌ 内容に関係のないプロフィールへの導線
- ❌ CTAページ（行動促進ページ）
- ❌ いいねや他の投稿への導線ページ
- ❌ CTA項目（Call To Action要素）

**理由**: コンテンツの本質的価値に集中し、マーケティング的要素を排除

### 📋 正しいフォーマット完全版
```json
{
  "source": "contents-115",
  "problemCategory": "具体的な問題カテゴリ",
  "problemDescription": "問題の詳細説明",
  "postType": "001",
  "postTypeReason": "投稿タイプ選択理由",
  "solutionContent": {
    "概要": "解決策の概要",
    "具体的手順": ["手順1", "手順2"],
    "提供情報": ["情報1", "情報2"],
    "実用的なアドバイス": ["アドバイス1", "アドバイス2"]
  },
  "effectiveExpressions": ["表現手法1", "表現手法2"],
  "searchKeywords": ["キーワード1", "キーワード2"],
  "emotionalTriggers": ["感情トリガー1", "感情トリガー2"],
  "marketingStage": "ターゲット層の説明",
  "knowledgeId": "K115",
  "pageStructurePattern": "typeID001-episode-parallel-intro",
  "actualTitle": "実際のタイトル",
  "pageCount": 7,
  "hashTag": "#関連ハッシュタグ",
  "detailedContent": {
    "page1": {
      "role": "導入・問題提起",
      "layout": "質問形式 + 自己紹介 + 約束",
      "section": "intro",
      "content": {
        "question": "読者への質問文",
        "promise": "提供する価値の約束"
      }
    },
    "page2": {
      "role": "episode 01 - 具体的内容",
      "layout": "エピソード形式",
      "section": "mainContent",
      "content": {
        "episodeNumber": "01",
        "title": "エピソードタイトル",
        "logo": "関連ロゴ・アイコン",
        "description": "エピソードの説明",
        "failure": "失敗・問題の詳細",
        "conclusion": "学び・結論",
        "illustrationImage": "/misaki.png"  // オプション：画像パス指定
      }
    }
  }
}
```

### 🖼️ テンプレート別オプショナル画像機能

#### StepGuideAchievementTemplateの画像設定
**`step_guide_achievement`テンプレートを使用する場合、オプショナルで画像を指定可能：**
- **`illustrationImage`フィールド**：画像パスを指定（例：`"/misaki.png"`）
- **フィールドあり**：指定画像を中央に表示
- **フィールドなし**：画像エリアを削除してコンテンツを詰める

**使用例（K002パターン）：**
```json
"content": {
  "pointNumber": "2",
  "title": "どこでも通用するスキルや経験を",
  "content": ["テキスト内容"],
  "illustrationImage": "/misaki.png"  // ← この行で画像指定
}
```

**適用テンプレート：**
- ✅ `step_guide_achievement`：画像設定可能
- ❌ `basic_intro`：画像設定なし（レイアウト固定）
- ❌ `achievement_summary`：画像設定なし（テキスト中心）

### 🎯 統一ルールの効果
- **TemplateItemMapperエラーの完全回避**
- **PageStructureMatcherとの整合性確保**
- **外部構造定義ファイルとの適切な連携**
- **純粋なコンテンツ価値に特化**

**このフォーマット違いが長時間のデバッグ原因でした。全Kxxxファイルはこの形式に統一すること。**

---

## 🚀 投稿タイプ別Problem-Solution対応システム開発フロー

### 📋 標準開発フロー（毎回このステップで実装）

**1. パターン特定**
- `/mnt/c/instagram-course/instagram-post-generator/投稿タイプ別Problem-Solutionパターンマッピング.md`を参照
- 対象KxxxがどのTypeID・パターンに該当するかを特定
- 例：K002 → TypeID=002 → 順序依存型ステップフロー

**2. ページ構造作成**
- `app/services/knowledgeBase/data/pageStructures/`に構造定義ファイル作成
- ファイル名：`typeIDxxx-pattern-name.json`
- 必要なテンプレートIDを定義

**3. Kxxxファイル修正**
- `pageStructurePattern`フィールドを追加
- `detailedContent`を正しいフォーマットに統一
- **削除必須要素**：
  - ❌ タイトルだけのページ
  - ❌ CTAページ・CTA項目
  - ❌ プロフィール導線
  - ❌ いいね誘導ページ
  - ❌ 装飾関連フィールド

**4. テンプレート実装**
- `app/components/templates/`に新テンプレートコンポーネント作成
- `app/components/templates/index.ts`への登録
- `app/components/templates/TemplateRegistry.ts`への登録
- `app/components/templates/TemplateTypes.ts`への型定義追加

**5. PageStructureMatcherへの登録**
- `app/services/knowledgeBase/PageStructureMatcher.ts`に新構造をインポート
- `pageStructureMap`への追加

### 🎯 開発効率化のポイント

- **毎回エラー分析しない**：このフローに従って機械的に実装
- **パターンマッピング.md参照必須**：既存分析結果を活用
- **フォーマット統一**：K115形式への厳密準拠
- **装飾・CTA要素完全排除**：純粋なコンテンツ価値のみ

### 📊 実装対象パターン一覧
- **TypeID=001**: 3パターン（順序依存型、並列紹介型、エピソード並列型）
- **TypeID=002**: 3パターン（順序依存型、段階的知識習得、実践ガイド）
- **TypeID=003**: 3パターン（情報整理型、比較分析型、データ提示型）
- **TypeID=004**: 1パターン（効率重視簡潔型）

**合計10パターンの体系的実装により、全ナレッジベースをカバー**

---

## 🎯 完全実装フロー（K002実例完了版）

### 📋 コンテンツ分析からパターン実装まで：一連の完全フロー

**1. コンテンツ分析・パターン特定**
- 投稿タイプ別Problem-Solutionパターンマッピング.md参照
- 対象Kxxxの投稿タイプ・構造パターンを特定
- 例：K002 → TypeID=002 → 順序依存型ステップフロー

**2. ページ構造定義作成**
- `app/services/knowledgeBase/data/pageStructures/`にJSON作成
- ファイル名：`typeIDxxx-pattern-name.json`
- 必要テンプレートID・構造を定義

**3. Kxxxナレッジベース修正**
- `pageStructurePattern`フィールド追加
- `detailedContent`をK115形式に統一
- 不要要素の完全削除（CTA、プロフィール導線、装飾等）

**4. テンプレート実装**
- `app/components/templates/`に新テンプレート作成
- props型定義・デフォルト値設定
- 実際のコンテンツ画像参照でデザイン忠実再現

**5. メタデータ定義**
- 各テンプレートファイル内にTemplateMetadata export
- 適用範囲、文字制限、キーワード等を詳細定義

**6. システム登録**
- `app/components/templates/index.ts`：export・import・componentMap追加
- `app/components/templates/TemplateTypes.ts`：型定義追加
- `app/components/templates/TemplateRegistry.ts`：メタデータ登録

**7. PageStructureMatcher登録**
- `app/services/knowledgeBase/PageStructureMatcher.ts`にインポート
- `pageStructureMap`に新構造追加

### 🎯 K002実装完了実績

#### ✅ 作成されたファイル
- `BasicIntroTemplate.tsx` - 基本導入型
- `StepGuideAchievementTemplate.tsx` - ステップガイド達成型（画像対応）
- `AchievementSummaryTemplate.tsx` - 達成まとめ型
- `typeID002-sequential-dependency.json` - ページ構造定義

#### ✅ 修正されたファイル
- `K002.json` - K115形式への完全統一
- `index.ts`, `TemplateTypes.ts`, `TemplateRegistry.ts` - 完全登録
- `PageStructureMatcher.ts` - 構造マッピング追加

#### ✅ 重要な設計決定
- **オプショナル画像システム**: `illustrationImage`フィールドで画像制御
- **安全なprops処理**: デフォルト値設定でエラー回避
- **実コンテンツ忠実再現**: 実際の画像参照でデザイン完全再現

### 🔄 残り9パターンへの適用

このフローをそのまま適用することで：
- **TypeID=001**: 3パターン（順序依存型、並列紹介型、エピソード並列型）
- **TypeID=002**: 2パターン残り（段階的知識習得、実践ガイド）
- **TypeID=003**: 3パターン（情報整理型、比較分析型、データ提示型）
- **TypeID=004**: 1パターン（効率重視簡潔型）

**体系的・機械的に全パターン実装可能**

---

## 📋 現在のシステム仕様

### 静的JSON読み込み方式
- ContentGeneratorServiceは静的JSONファイルを読み込む設計
- 各ナレッジの`pageStructurePattern`値に対応するJSONファイルが必要
- ファイルパス: `./knowledgeBase/data/pageStructures/${pageStructureId}.json`

### 現在の問題
- K115の`pageStructurePattern`: `"failure_story_intro,failure_episode,failure_episode,failure_episode,failure_episode,failure_episode,failure_episode,profile_offer"`
- 対応する8ページ固定の静的JSONファイルが存在しない
- システムはページ数固定パターンでないと機能しない

## 🎯 設計理論

### 問題の本質
**全ページ組み合わせだと膨大なパターン数になる**

### 解決策
**各ナレッジで`"section": "mainContent"`フィールドを動的指定**

```json
{
  "page2": { "section": "mainContent" },
  "page3": { "section": "mainContent" },
  "page4": { "section": "mainContent" }
}
```

### 理論の核心
**投稿タイプ別ドキュメントのパターン数 = 必要な静的JSONパターン数**

## 📊 パターン数の計算

### ドキュメント記載のパターン数
- **TypeID=001**: 6パターン → 6つの静的JSON
- **TypeID=002**: 3パターン → 3つの静的JSON  
- **TypeID=003**: 3パターン → 3つの静的JSON
- **TypeID=004**: 1パターン → 1つの静的JSON

### 結果
**合計13パターンで全てのナレッジに対応可能**

## 🔧 実装方式

### 静的JSONの構造
```json
{
  "pageStructureId": "typeID001-episode-parallel-intro",
  "name": "TypeID001 エピソード並列紹介型",
  "pages": [
    {
      "pageNumber": 1,
      "templateId": "failure_story_intro",
      "templateStructure": {
        "question": "string",
        "promise": "string",
        "finalPageOffer": "string",
        "cta": "string"
      }
    },
    {
      "pageNumber": "dynamic",
      "templateId": "failure_episode", 
      "templateStructure": {
        "episodeNumber": "string",
        "title": "string",
        "logo": "string",
        "description": "string",
        "failure": "string",
        "conclusion": "string",
        "savePrompt": "string",
        "question": "string"
      }
    }
  ]
}
```

### ナレッジファイルの指定
```json
{
  "pageStructurePattern": "typeID001-episode-parallel-intro",
  "detailedContent": {
    "page1": {
      "section": "intro",
      "content": { /* 実際のコンテンツ */ }
    },
    "page2": {
      "section": "mainContent", 
      "content": { /* 実際のコンテンツ */ }
    },
    "page3": {
      "section": "mainContent",
      "content": { /* 実際のコンテンツ */ }
    }
  }
}
```

## 💻 動的展開処理の実装

### ContentGeneratorServiceでの処理フロー
```typescript
for (const pageInfo of pageStructure.pages) {
  if (pageInfo.pageNumber === "dynamic") {
    // mainContentセクションのページを特定
    const mainContentPages = Object.keys(knowledgeData.detailedContent)
      .filter(key => {
        const pageData = knowledgeData.detailedContent[key]
        return pageData.section === "mainContent"
      })
      .map(key => parseInt(key.replace('page', '')))
      .sort((a, b) => a - b)

    // 各mainContentページを生成
    for (const actualPageNumber of mainContentPages) {
      // 実際のページ番号で生成処理を実行
      const result = await generator.generatePageContent({
        userInput,
        knowledgeData,
        pageStructure,
        templateStructure: pageInfo.templateStructure,
        pageNumber: actualPageNumber
      })
    }
  }
}
```

### 重要な実装ポイント
1. **セクション判定**: `pageData.section === "mainContent"`でmainContentページを特定
2. **ページ番号抽出**: `parseInt(key.replace('page', ''))`で実際のページ番号を取得
3. **順序保証**: `.sort((a, b) => a - b)`でページ順序を維持
4. **テンプレート構造統一**: 同一の`templateStructure`を全mainContentページで使用

## 🎯 設計効果

1. **パターン数の最小化**: 全組み合わせから13パターンに削減
2. **動的ページ数対応**: mainContent部分が可変長に対応
3. **システム統一**: 静的JSON読み込み方式を維持
4. **実装完了**: K115で動作確認済み（Page 1: intro, Page 2-7: mainContent）

---

**作成日**: 2025-07-25  
**重要度**: 最高 - システム設計の核心理論  
**参照ドキュメント**: 投稿タイプ別Problem-Solution構造分析.md