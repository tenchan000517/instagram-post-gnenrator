# プロンプト構造オーバーライド対応 進捗報告書

**作成日**: 2025年7月28日  
**作業状況**: フロー調査完了・初期実装完了・検証待ち

---

## 🎯 解決対象問題

### 発見された問題
**プロンプト内の【テンプレート構造】部分のみがオーバーライドシステムから取り残されている**

```typescript
// プロンプト内容（K117 ページ3の場合）
テンプレート: ng_good_comparison          // ← オーバーライド適用済み
【テンプレート構造】
{
  "pointNumber": "string",               // ← step_guide_achievementの構造
  "title": "string",                     // ← オーバーライド前のまま
  "content": "string[]",                 // ← 古い構造が残存
  "actionItems": "string[]"
}
```

### 影響範囲
- AIがテンプレート名と構造定義の不一致を自力で解決する必要あり
- 不安定要素となっている
- K117等のオーバーライド使用ナレッジで正確性に影響

---

## 🔍 完全フロー解析結果

### ナレッジベース生成フロー全体把握
1. **ContentInput.tsx** → ナレッジ選択・AI判定
2. **NewFlowPostGenerator.tsx** → フロー管理
3. **contentGeneratorService.ts** → ページ毎生成制御
4. **KnowledgeBasedContentGenerator.ts** → AI生成実行
5. **EditablePostGenerator.tsx** → UI表示

### オーバーライド適用状況調査

| 項目 | オーバーライド適用 | 実際の値 |
|------|-------------------|----------|
| **テンプレート名** | ✅ 適用済み | `ng_good_comparison` |
| **templateType** | ✅ 適用済み | `ng_good_comparison` |
| **UI表示** | ✅ 適用済み | `NgGoodComparisonTemplate` |
| **【テンプレート構造】** | ❌ **取り残し** | `step_guide_achievement`の構造 |

### 取得元・渡し方の詳細
```typescript
// 現在の問題箇所（KnowledgeBasedContentGenerator.ts 154行目）
【テンプレート構造】
${JSON.stringify(templateStructure, null, 2)}  // pageInfo.templateStructureから取得
```

---

## 💡 解決方針決定プロセス

### 検討した修正案と問題点

#### ❌ 案1: 全テンプレートでgetTemplateStructure使用
```typescript
${JSON.stringify(this.getTemplateStructure(finalTemplate), null, 2)}
```
**問題**: オーバーライドなしテンプレートにも影響→オーバーライドの意味がない

#### ✅ 案2: 条件分岐によるオーバーライド対応
```typescript
${JSON.stringify(
  knowledgeData.templateOverrides?.[pageNumber.toString()]
    ? this.getTemplateStructure(finalTemplate)  // オーバーライドあり
    : templateStructure,                        // オーバーライドなし
  null, 2
)}
```
**利点**: オーバーライドの本来の意味を保持・既存システムへの影響最小化

---

## 🛠️ 実装内容

### 1. KnowledgeBasedContentGenerator.ts修正

#### A. プロンプト生成部分の条件分岐実装（154-159行目）
```typescript
【テンプレート構造】
${JSON.stringify(
  knowledgeData.templateOverrides?.[pageNumber.toString()]
    ? this.getTemplateStructure(finalTemplate)
    : templateStructure,
  null, 2
)}
```

#### B. K117オーバーライドテンプレート構造追加（327-348行目）
```typescript
// K117オーバーライド用テンプレート構造
'ng_good_comparison': {
  ngSection: {
    title: 'string',
    examples: 'string[]'
  },
  goodSection: {
    title: 'string',
    examples: 'string[]'
  },
  bottomNote: 'string?'
},
'category_explanation': {
  categoryTitle: 'string',
  categoryDescription: 'string',
  examples: 'string[]',
  additionalTips: 'string?'
},
'vision_strength_matrix': {
  matrixTitle: 'string',
  rows: '{vision: string, strength: string, result: string}[]',
  conclusion: 'string'
}
```

### 2. K140.jsonにテスト用オーバーライド追加
```json
"templateOverrides": {
  "8": "category_summary"
}
```

---

## 🎪 テスト対象

### 検証ケース1: K117（既存オーバーライド）
- **ページ3**: `ng_good_comparison`構造 ← **修正対象**
- **ページ4-5**: `category_explanation`構造 ← **修正対象**
- **ページ6**: `vision_strength_matrix`構造 ← **修正対象**
- **ページ2**: 従来通り ← **影響なし確認**

### 検証ケース2: K140（新規テスト用）
- **ページ8**: `category_summary`構造 ← **新規追加**
- **ページ1-7**: 従来通り ← **影響なし確認**

### 検証ケース3: 他ナレッジ（影響なし確認）
- **K115等**: 完全に従来通り ← **影響なし確認**

---

## ⚠️ 注意事項・リスク

### 過去の失敗経験
- 以前この修正で他システムが破損した経験あり
- 慎重な検証が必要

### 潜在的リスク
1. **getTemplateStructure定義不足**: 新しいオーバーライドテンプレートで構造未定義の場合
2. **構造不一致**: pageStructureとgetTemplateStructureで同名テンプレートの構造が異なる場合  
3. **既存システム依存**: templateStructureを別箇所で使用している場合

### 安全対策
- 条件分岐により既存動作を完全保持
- オーバーライドなしケースは一切変更なし
- フォールバック機能が既存のgetTemplateStructureに実装済み

---

## 📋 次ステップ検証項目

### 必須検証項目
1. **K117 ページ3の生成結果確認**
   - プロンプトに正しい`ng_good_comparison`構造が送られているか
   - AI生成結果が適切なJSON構造になっているか
   - UI表示が正常に動作するか

2. **K117 ページ2の影響なし確認**
   - 従来通りの構造がプロンプトに送られているか
   - 既存動作に変化がないか

3. **K140 ページ8の新規オーバーライド確認**
   - `category_summary`構造が正しく送られているか
   - CategorySummaryTemplateで正常表示されるか

4. **他ナレッジへの影響確認**
   - K115等でオーバーライドなしナレッジが従来通り動作するか

### デバッグ方法
- `console.log('🔍 プロンプト全文:', prompt)`で実際のプロンプト内容確認
- 生成されたJSONの構造確認
- UI表示の正常性確認

---

## 🔧 不具合時の対処方針

### 症状別対処法

#### パターン1: プロンプト構造が正しく送られない
- 条件分岐ロジックの確認
- `knowledgeData.templateOverrides`の値確認
- `finalTemplate`の値確認

#### パターン2: 構造定義が見つからない
- `getTemplateStructure`に対象テンプレート構造追加
- フォールバック動作の確認

#### パターン3: 既存システムに影響
- 条件分岐を再確認
- オーバーライドなしケースの動作確認

#### パターン4: UI表示エラー
- `templateComponents`にテンプレート登録確認
- AIが生成したJSONとテンプレートの期待構造一致確認

---

## 📞 引き継ぎ情報

### 実装ファイル
- **主要修正**: `/app/services/knowledgeBase/KnowledgeBasedContentGenerator.ts`
- **テスト追加**: `/app/data/knowledgeBase/knowledge/K140.json`

### キーワード
- `templateOverrides`
- `getTemplateStructure`
- `buildKnowledgeBasedPrompt`
- プロンプト構造不一致問題

### 関連ナレッジ
- **K117**: 既存オーバーライド使用（ng_good_comparison, category_explanation, vision_strength_matrix）
- **K140**: 新規テスト用（category_summary）

---

**🚨 重要**: 検証は段階的に行い、問題発生時は即座に問題箇所を特定して慎重に修正すること。過去の失敗を繰り返さないよう、影響範囲を最小限に抑えた修正を心がける。