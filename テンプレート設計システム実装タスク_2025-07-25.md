# テンプレート設計システム実装タスク

## 📋 概要

**目的**: 各Kxxx.jsonのページが新しいテンプレートを使ってコンテンツを生成し、情報の欠損なく完璧に表示できるシステムを構築

**作成日**: 2025-07-25  
**基準**: Phase 1分析結果とプロンプト設計議論を基に策定

---

## 🎯 実装すべき全タスク

### **Phase 1: Kxxx.jsonデータ構造の修正**

#### **タスク1.1: プロンプト生成対象外ページの除外**
各Kxxx.jsonから以下のページをプロンプト生成対象外として明確に分離：

**完全除外対象:**
- `page1`: タイトルページ（全投稿共通）
- 最終2-3ページ: CTA・自己紹介・プロフィール系
  - 自己紹介・実績アピール
  - キャプション・プロフィール
  - アカウント紹介・フォロー促進
  - 関連投稿紹介

**含める対象:**
- まとめページ（CTAなしのコンテンツ総括）

#### **タスク1.2: contentPageCountフィールドの追加**
各Kxxx.jsonにプロンプト生成対象ページ数を追加：

```json
{
  "pageCount": 10,           // 元の総ページ数
  "contentPageCount": 7,     // プロンプト生成対象ページ数（NEW）
  "detailedContent": { ... }
}
```

#### **タスク1.3: pageStructurePatternフィールドの廃止**
以下を削除し、新方式に変更：

```json
// 削除対象
"pageStructurePattern": "",

// 新方式: 各ページのtemplateフィールドから直接取得
"page2": {
  "section": "intro",                    // ← 追加
  "template": "basic_intro",             // ← 追加（直接参照）
  "role": "問題提起・共感",
  "content": "既存のコンテンツ内容"
}
```

#### **タスク1.4: 必要フィールドの追加**
プロンプト生成対象の各ページに以下を追加：

**作業内容:**
- 104個のKxxx.jsonファイルを一括更新
- 各ページに適切な`section`と`template`を設定
- contentPageCountを正確に算出して追加

#### **タスク1.5: 不要フィールドの削除検討**
以下のフィールドの削除を検討：
- `layout`: テンプレートで管理するため不要
- `background`: テンプレートで管理するため不要  
- `elements`: テンプレートで管理するため不要
- その他装飾的な要素

**判断基準:**
- プロンプト生成で使用されないフィールド
- テンプレート側で管理すべき情報

### **Phase 2: 新テンプレート設計・実装**

#### **タスク2.1: Phase 1分析の完了**
**12個の代表例から新テンプレートパターンを特定:**

**対象ファイル:**
- TypeID=001: K006, K027, K030, K032
- TypeID=002: K002, K040, K005  
- TypeID=003: K004, K025, K024
- TypeID=004: K113, K104

**分析項目:**
1. 各ページの`content`構造分析
2. 必要なテンプレート構造の定義
3. テンプレート名の命名

#### **タスク2.2: 新テンプレート構造定義**
Phase 1分析で特定された11個の新テンプレートのデータ構造を定義：

**優先度A（Critical）:**
```typescript
// 1. 順序依存ステップ型
interface SequentialStepLearning {
  stepNumber: number
  stepTitle: string
  stepContent: string[]
  questions?: string[]
}

// 2. Q&A並列紹介型  
interface ParallelQaDiscussion {
  questionText: string
  answerText: string
  practicalAdvice: string
}

// 3. ポイントリスト型
interface PointsListAnalysis {
  pointsTitle: string
  pointsList: string[]
  summaryMessage: string
}

// 4. 時系列ストーリー型
interface TimelineStoryExperience {
  timePoint: string
  scene: string
  character: string
  emotion: string
  context: string
}

// 5. 機能紹介並列型
interface FeatureParallelInfo {
  featureNumber: number
  featureName: string
  description: string
  effect: string
}
```

**優先度B（High）:**
```typescript
// 6-11. その他テンプレート構造
interface CategoryContentLearning {
  categoryName: string
  episodes: string[]
  advice: string
}

interface StepGuideAchievement {
  stepTitle: string
  description: string
  benefit: string
  motivationalMessage: string
}

interface MethodSystematicInfo {
  methodNumber: number
  methodName: string
  description: string
  steps: string[]
}

interface PracticalGuideConversation {
  guideType: string
  points: {title: string, detail: string}[]
  examples?: {phrase: string, usage: string}[]
}

interface CompanyDataList {
  companyName: string
  industry: string
  salary: string
  deadline: string
  selectionFlow: string[]
}

interface UsagePracticalSteps {
  stepNumber: number
  title: string
  content: string
  practicalAdvice: string
}
```

#### **タスク2.3: 新テンプレートコンポーネント実装**
`app/components/templates/`配下に新テンプレートを実装：

```tsx
// 例: SequentialStepTemplate.tsx
export const SequentialStepTemplate = ({ data }: TemplateProps) => {
  return (
    <div className="sequential-step-template">
      <div className="step-number">Point {data.stepNumber}</div>
      <h2>{data.stepTitle}</h2>
      {data.stepContent.map((content, index) => (
        <p key={index}>{content}</p>
      ))}
      <div className="page-indicator">{data.pageIndicator}</div>
    </div>
  )
}
```

#### **タスク2.4: TemplateTypes.tsの更新**
新テンプレートタイプを追加：

```typescript
export type TemplateType = 
  | 'index'
  | 'enumeration'
  // ... 既存テンプレート
  | 'sequential_step_learning'       // ← 追加（優先度A）
  | 'parallel_qa_discussion'         // ← 追加（優先度A）
  | 'points_list_analysis'           // ← 追加（優先度A）
  | 'timeline_story_experience'      // ← 追加（優先度A）
  | 'feature_parallel_info'          // ← 追加（優先度A）
  | 'category_content_learning'      // ← 追加（優先度B）
  | 'step_guide_achievement'         // ← 追加（優先度B）
  | 'method_systematic_info'         // ← 追加（優先度B）
  | 'practical_guide_conversation'   // ← 追加（優先度B）
  | 'company_data_list'              // ← 追加（優先度B）
  | 'usage_practical_steps'          // ← 追加（優先度B）
```

### **Phase 3: プロンプト生成システムの修正**

#### **タスク3.1: KnowledgeBasedContentGeneratorの修正**
`buildKnowledgeBasedPrompt`メソッドを修正：

```typescript
private buildKnowledgeBasedPrompt(request: KnowledgeBasedGenerationRequest): string {
  const { userInput, knowledgeData, pageNumber } = request
  const pageKey = `page${pageNumber}`
  const currentPageData = knowledgeData.detailedContent[pageKey]
  
  return `
  【投稿意図】
  ${userInput}
  ↑この投稿意図に合致する内容で生成してください

  【投稿タイプ】${knowledgeData.postType}
  【投稿タイプ理由】${knowledgeData.postTypeReason}

  【解決すべき困った】
  ${knowledgeData.problemDescription}

  【問題カテゴリ】
  ${knowledgeData.problemCategory}

  【ターゲットの学習レベル】
  ${knowledgeData.marketingStage}

  【活用すべき解決策】
  ${JSON.stringify(knowledgeData.solutionContent, null, 2)}

  【安全確認済み表現事例】
  ${knowledgeData.effectiveExpressions?.join('\n')}

  【感情トリガー】
  ${knowledgeData.emotionalTriggers?.join(', ')}

  【検索キーワード】
  ${knowledgeData.searchKeywords?.join(', ')}

  【生成対象ページ情報】
  ページ番号: ${pageNumber}/${knowledgeData.contentPageCount}  // ← 修正
  ページの役割: ${currentPageData.role}
  セクション: ${currentPageData.section}
  テンプレート: ${currentPageData.template}  // ← 追加

  【このページのコンテンツ参考例】
  ${currentPageData.content}

  【テンプレート構造】
  ${JSON.stringify(this.getTemplateStructure(currentPageData.template), null, 2)}

  【生成ルール】
  1. 投稿意図に完璧に合致する内容で生成（ナレッジの単純コピーではない）
  2. このページが全体の${pageNumber}/${knowledgeData.contentPageCount}ページ目であることを意識  // ← 修正
  3. ページの役割「${currentPageData.role}」に完璧に適合
  4. 上記のテンプレート構造に完璧に適合するJSONで出力

  【出力形式】
  上記のテンプレート構造と完全に一致するJSONのみを出力してください。
  `
}
```

#### **タスク3.2: テンプレート構造取得メソッドの実装**
```typescript
private getTemplateStructure(templateName: string): any {
  const templateStructures = {
    // 優先度A（Critical）
    'sequential_step_learning': {
      stepNumber: 'number',
      stepTitle: 'string', 
      stepContent: 'string[]',
      questions: 'string[]?' // optional
    },
    'parallel_qa_discussion': {
      questionText: 'string',
      answerText: 'string',
      practicalAdvice: 'string'
    },
    'points_list_analysis': {
      pointsTitle: 'string',
      pointsList: 'string[]',
      summaryMessage: 'string'
    },
    'timeline_story_experience': {
      timePoint: 'string',
      scene: 'string',
      character: 'string',
      emotion: 'string',
      context: 'string'
    },
    'feature_parallel_info': {
      featureNumber: 'number',
      featureName: 'string',
      description: 'string',
      effect: 'string'
    },
    // 優先度B（High）
    'category_content_learning': {
      categoryName: 'string',
      episodes: 'string[]',
      advice: 'string'
    },
    'step_guide_achievement': {
      stepTitle: 'string',
      description: 'string',
      benefit: 'string',
      motivationalMessage: 'string'
    },
    'method_systematic_info': {
      methodNumber: 'number',
      methodName: 'string',
      description: 'string',
      steps: 'string[]'
    },
    'practical_guide_conversation': {
      guideType: 'string',
      points: '{title: string, detail: string}[]',
      examples: '{phrase: string, usage: string}[]?' // optional
    },
    'company_data_list': {
      companyName: 'string',
      industry: 'string',
      salary: 'string',
      deadline: 'string',
      selectionFlow: 'string[]'
    },
    'usage_practical_steps': {
      stepNumber: 'number',
      title: 'string',
      content: 'string',
      practicalAdvice: 'string'
    }
  }
  
  return templateStructures[templateName] || {}
}
```

### **Phase 4: データ処理フローの修正**

#### **タスク4.1: convertToTemplateDataメソッドの簡素化**
新テンプレート対応により複雑な変換処理が不要になるため簡素化：

```typescript
private convertToTemplateData(content: any, templateType: TemplateType): TemplateData {
  // 新テンプレートの場合は、AIが生成した構造をそのまま使用
  if (this.isNewTemplate(templateType)) {
    return content // 変換不要
  }
  
  // 既存テンプレートの場合は従来の変換処理
  return this.convertLegacyTemplate(content, templateType)
}
```

#### **タスク4.2: テンプレートマッピングシステムの実装**
```typescript
// 新テンプレートと既存テンプレートの対応関係を管理
const TEMPLATE_MAPPING = {
  // 新テンプレート（優先度A）
  'sequential_step_learning': 'new',
  'parallel_qa_discussion': 'new', 
  'points_list_analysis': 'new',
  'timeline_story_experience': 'new',
  'feature_parallel_info': 'new',
  // 新テンプレート（優先度B）
  'category_content_learning': 'new',
  'step_guide_achievement': 'new',
  'method_systematic_info': 'new',
  'practical_guide_conversation': 'new',
  'company_data_list': 'new',
  'usage_practical_steps': 'new',
  // 既存テンプレート
  'enumeration': 'legacy',
  'list': 'legacy',
  'section-items': 'legacy'
  // ...
}
```

### **Phase 5: 一括更新スクリプトの作成**

#### **タスク5.1: Kxxx.json一括更新スクリプト**
```typescript
// scripts/updateKnowledgeBase.ts
const updateKnowledgeBaseFiles = async () => {
  const knowledgeFiles = glob.sync('app/data/knowledgeBase/knowledge/K*.json')
  
  for (const filePath of knowledgeFiles) {
    const knowledge = JSON.parse(fs.readFileSync(filePath, 'utf8'))
    const updatedKnowledge = addSectionAndTemplate(knowledge)
    fs.writeFileSync(filePath, JSON.stringify(updatedKnowledge, null, 2))
  }
}

const addSectionAndTemplate = (knowledge: any) => {
  // Phase 1分析結果に基づいてsectionとtemplateを追加
  const mapping = getSectionTemplateMapping(knowledge.knowledgeId)
  
  Object.keys(knowledge.detailedContent).forEach(pageKey => {
    if (mapping[pageKey]) {
      knowledge.detailedContent[pageKey].section = mapping[pageKey].section
      knowledge.detailedContent[pageKey].template = mapping[pageKey].template
    }
  })
  
  return knowledge
}
```

#### **タスク5.2: セクション・テンプレートマッピングデータ**
```typescript
// Phase 1分析結果を基にした完全なマッピング（例）
const SECTION_TEMPLATE_MAPPING = {
  "K002": {
    "contentPageCount": 8,  // プロンプト生成対象ページ数
    "pages": {
      "page2": { "section": "intro", "template": "basic_intro" },
      "page3": { "section": "mainContent", "template": "sequential_step_learning" },
      "page4": { "section": "mainContent", "template": "sequential_step_learning" },
      "page5": { "section": "mainContent", "template": "sequential_step_learning" },
      "page6": { "section": "mainContent", "template": "sequential_step_learning" },
      "page7": { "section": "mainContent", "template": "sequential_step_learning" },
      "page8": { "section": "mainContent", "template": "sequential_step_learning" },
      "page9": { "section": "summary", "template": "basic_summary" }
      // page1（タイトル）とpage10（CTA）は除外
    }
  },
  "K113": {
    "contentPageCount": 8,
    "pages": {
      "page2": { "section": "intro", "template": "basic_intro" },
      "page3": { "section": "mainContent", "template": "feature_parallel_info" },
      "page4": { "section": "mainContent", "template": "feature_parallel_info" },
      "page5": { "section": "mainContent", "template": "feature_parallel_info" },
      "page6": { "section": "mainContent", "template": "feature_parallel_info" },
      "page7": { "section": "mainContent", "template": "feature_parallel_info" },
      "page8": { "section": "mainContent", "template": "feature_parallel_info" },
      "page9": { "section": "summary", "template": "basic_summary" }
    }
  }
  // ... 全104個のマッピング
}
```

---

## 🚀 実装順序

### **優先度1（Critical）: Phase 1完了**
1. **12個の代表例分析完了**
   - 各ページの構造とテンプレート特定
   - 必要なテンプレート一覧の確定

### **優先度2（High）: 基盤システム構築**
2. **新テンプレート構造定義**
3. **プロンプト生成システム修正**
4. **テンプレート構造取得システム実装**

### **優先度3（Medium）: テンプレート実装**
5. **新テンプレートコンポーネント実装**
6. **TemplateTypes.ts更新**
7. **データ処理フロー修正**

### **優先度4（Low）: 一括適用**
8. **セクション・テンプレートマッピング作成**
9. **Kxxx.json一括更新実行**
10. **不要フィールド削除**

---

## 📊 成功指標

### **技術的指標**
- [ ] 新テンプレートでの情報欠損率: 0%
- [ ] convertToTemplateDataでの複雑な変換処理: 削減
- [ ] AIが生成するデータ構造の適合率: 100%

### **運用指標**  
- [ ] 全104個のKxxx.jsonが正常動作
- [ ] 新テンプレートでのページ表示が完璧
- [ ] プロンプト生成時間の短縮

### **品質指標**
- [ ] 100点マッチングシステムの実現
- [ ] 情報の欠損なく完璧な表示
- [ ] ナレッジベースの多様な構造に完全対応

---

## ⚠️ 注意事項

### **データ整合性**
- Kxxx.json更新前に必ずバックアップ作成
- 段階的な更新とテストの実施
- 既存システムとの互換性確保

### **テンプレート設計**
- レスポンシブデザイン対応
- 既存デザインシステムとの統一性
- アクセシビリティの確保

### **プロンプト最適化**
- AIの理解しやすい構造化
- 生成品質の継続的監視
- エラーハンドリングの強化

---

**このタスクリストに従って実装することで、ナレッジベースの構造に完璧に適合する新テンプレートシステムが構築され、情報欠損のない完璧なコンテンツ表示が実現されます。**