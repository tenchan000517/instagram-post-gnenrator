'use client'

import { useState, useRef, useEffect } from 'react'
import { ArrowLeft, Download, RefreshCw, ChevronLeft, ChevronRight, Edit, Palette, Eye, Save, CheckSquare, Square, PackageOpen } from 'lucide-react'
import { GeneratedContent, GeneratedPage, contentGeneratorService } from '../services/contentGeneratorService'
import { templateMatchingService } from '../services/templateMatchingService'
import { ContentLayoutService } from '../services/contentLayoutService'
import { templateComponents } from './templates'
import { TemplateType } from './templates/TemplateTypes'
import { templateRegistry } from './templates/TemplateRegistry'
import Viewport from './Viewport'
import html2canvas from 'html2canvas'
import { bulkDownloadService, DownloadItem } from '../services/bulkDownloadService'

interface EditablePostGeneratorProps {
  generatedContent: GeneratedContent
  onBack: () => void
  onSave: (content: GeneratedContent) => void
  mainTheme?: string // INDEX„Éö„Éº„Ç∏ÁîüÊàêÁî®
}

export default function EditablePostGenerator({ 
  generatedContent, 
  onBack, 
  onSave,
  mainTheme
}: EditablePostGeneratorProps) {
  const [currentContent, setCurrentContent] = useState<GeneratedContent>(generatedContent)
  const [currentPage, setCurrentPage] = useState(0)
  const [isTemplateSelectionMode, setIsTemplateSelectionMode] = useState(false)
  const [selectedPageForTemplateChange, setSelectedPageForTemplateChange] = useState<number | null>(null)
  const [isEditMode, setIsEditMode] = useState(false)
  const [editingPage, setEditingPage] = useState<number | null>(null)
  const [isGenerating, setIsGenerating] = useState(false)
  const [downloadItems, setDownloadItems] = useState<DownloadItem[]>([])
  const [isDownloading, setIsDownloading] = useState(false)
  const [downloadProgress, setDownloadProgress] = useState({ current: 0, total: 0 })
  const [includeMiddleFooter, setIncludeMiddleFooter] = useState(false)
  const [includeEndFooter, setIncludeEndFooter] = useState(false)
  const previewRef = useRef<HTMLDivElement>(null)
  const pageRefs = useRef<{ [key: number]: HTMLDivElement | null }>({})         // „Éó„É¨„Éì„É•„ÉºÁî®
  const downloadPageRefs = useRef<{ [key: number]: HTMLDivElement | null }>({}) // „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÁî®

  // Âõ∫ÂÆö„Éï„ÉÉ„Çø„ÉºÂÆöÁæ©
  const getMiddleFooter = () => `

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

„ÄåËá™ÂàÜ„Å´„ÅØ‰Ωï„ÇÇ„Å™„ÅÑ„Äç„Åã„Çâ
„ÄåËá™ÂàÜ„Å´„ÅØ„Åì„Çå„Åå„ÅÇ„Çã„Äç„ÅåË¶ã„Å§„Åã„Çã„Ç≥„Éü„É•„Éã„ÉÜ„Ç£

ÊúÄÂàù„ÅØË™∞„Åß„ÇÇÂàùÂøÉËÄÖ„ÄÇ
„Åì„Åì„ÅßË¶ã„Å§„Åë„Åü„ÄåÂæóÊÑè„Äç„Åå„ÄÅ‰∫∫Áîü„ÇíÂ§â„Åà„Çã„Åç„Å£„Åã„Åë„Å´„Å™„Çã„ÄÇ

‰∏Ä‰∫∫„ÅßÈ†ëÂºµ„Çã„Çà„Çä„ÄÅ„Åø„Çì„Å™„ÅßÊåëÊà¶„Åô„ÇãÊñπ„ÅåÂúßÂÄíÁöÑ„Å´Êó©„ÅèÊàêÈï∑„Åß„Åç„Çã„ÄÇ

4Âπ¥Èñì„Åß40Âπ¥ÂàÜ„ÅÆ„Ç≠„É£„É™„Ç¢„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„ÇíÊßãÁØâ„Åô„Çã„ÄÇ

„Éó„É≠„Éï„Ç£„Éº„É´Ê¨Ñ„ÅÆURL„Åã„Çâ„ÅäÊ∞óËªΩ„Å´„ÅîÂèÇÂä†„Åè„Å†„Åï„ÅÑÔºÅ

@find_to_do`
  
  const getEndFooter = () => `

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

„ÅÑ„ÅÑ„Å≠„Éª„Ç≥„É°„É≥„Éà„Éª„Ç∑„Çß„Ç¢„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ

FIND to DO(@find_to_do)„Åß„ÅØ
‚úÖ ÊØéÊó•Â∞±Ê¥ª„Å´ÂΩπÁ´ã„Å§„ÇØ„Ç§„Ç∫„Çí„Çπ„Éà„Éº„É™„Éº„ÅßÈÖç‰ø°
‚úÖ ÈñãÂÇ¨„Ç§„Éô„É≥„Éà„ÅÆÊÉÖÂ†±„Çí„ÅäÂ±ä„Åë
‚úÖ Â∞±Ê¥ª„Å´ÂΩπÁ´ã„Å§„Éé„Ç¶„Éè„Ç¶„ÇíÈÖç‰ø°‰∏≠

„Éï„Ç©„É≠„Éº„Åó„Å¶ÂèÇËÄÉ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`

  // Initialize download items
  useEffect(() => {
    const items: DownloadItem[] = currentContent.pages.map(page => ({
      id: `page-${page.pageNumber}`,
      pageNumber: page.pageNumber,
      title: page.content.title || `Page ${page.pageNumber}`,
      selected: false,
      element: pageRefs.current[page.pageNumber - 1] || undefined
    }))
    setDownloadItems(items)
  }, [currentContent])

  // Update page elements after render
  useEffect(() => {
    const timer = setTimeout(() => {
      setDownloadItems(prev => prev.map(item => ({
        ...item,
        element: pageRefs.current[item.pageNumber - 1] || undefined
      })))
    }, 100)
    
    return () => clearTimeout(timer)
  }, [currentContent])

  const handleTemplateChange = async (pageIndex: number, newTemplateType: TemplateType) => {
    const targetPage = currentContent.pages[pageIndex]
    
    // AIÂÜçÈÖçÁΩÆ„ÇíÂÆüË°åÔºàÊîπÂñÑË¶Å‰ª∂‚ë°ÂØæÂøúÔºâ
    console.log('üîÑ AIÂÜçÈÖçÁΩÆ„ÇíÈñãÂßã:', { pageIndex, newTemplateType })
    
    try {
      // ÁèæÂú®„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÊñáÂ≠óÂàó„Å®„Åó„Å¶ÂÜçÊßãÁØâ
      const pageContent = [
        targetPage.content.title,
        targetPage.content.subtitle,
        targetPage.content.description,
        ...(targetPage.content.items || []),
        ...(targetPage.content.sections?.map(s => `${s.title}: ${s.content}`) || [])
      ].filter(Boolean).join('\n')
      
      // ContentLayoutService„Çí‰ΩøÁî®„Åó„Å¶AIÂÜçÈÖçÁΩÆ
      const layoutResult = ContentLayoutService.layoutContentToTemplate(pageContent, newTemplateType)
      
      if (layoutResult.layoutSuccess) {
        console.log('‚úÖ AIÂÜçÈÖçÁΩÆÊàêÂäü:', layoutResult)
        
        const updatedPages = currentContent.pages.map((page, index) => {
          if (index === pageIndex) {
            return {
              ...page,
              templateType: newTemplateType,
              templateData: layoutResult.templateData
            }
          }
          return page
        })

        setCurrentContent({
          ...currentContent,
          pages: updatedPages
        })
      } else {
        console.warn('‚ö†Ô∏è AIÂÜçÈÖçÁΩÆ„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô:', layoutResult.layoutNotes)
        
        // ÈÖçÁΩÆ„Å´ÂïèÈ°å„Åå„ÅÇ„Å£„Å¶„ÇÇ„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂ§âÊõ¥„ÅØÂÆüË°å
        const updatedPages = currentContent.pages.map((page, index) => {
          if (index === pageIndex) {
            return {
              ...page,
              templateType: newTemplateType
            }
          }
          return page
        })

        setCurrentContent({
          ...currentContent,
          pages: updatedPages
        })
      }
    } catch (error) {
      console.error('‚ùå AIÂÜçÈÖçÁΩÆ„Ç®„É©„Éº:', error)
      
      // „Ç®„É©„ÉºÁô∫ÁîüÊôÇ„ÇÇÂü∫Êú¨ÁöÑ„Å™„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂ§âÊõ¥„ÅØÂÆüË°å
      const updatedPages = currentContent.pages.map((page, index) => {
        if (index === pageIndex) {
          return {
            ...page,
            templateType: newTemplateType
          }
        }
        return page
      })

      setCurrentContent({
        ...currentContent,
        pages: updatedPages
      })
    }

    setIsTemplateSelectionMode(false)
    setSelectedPageForTemplateChange(null)
  }

  const handlePageNavigation = (direction: 'prev' | 'next') => {
    if (direction === 'prev' && currentPage > 0) {
      setCurrentPage(currentPage - 1)
    } else if (direction === 'next' && currentPage < currentContent.pages.length - 1) {
      setCurrentPage(currentPage + 1)
    }
  }

  const handleDownload = async () => {
    // Èö†„ÅóË¶ÅÁ¥†„Åã„ÇâÂØæË±°„Éö„Éº„Ç∏„ÇíÂèñÂæóÔºà‰∏ÄÊã¨„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å®Âêå„ÅòÊñπÂºèÔºâ
    const targetPage = currentContent.pages[currentPage]
    const pageIndex = targetPage.pageNumber - 1
    const currentPageElement = downloadPageRefs.current[pageIndex]
    
    if (!currentPageElement) {
      alert('„Éö„Éº„Ç∏„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÂ∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ')
      return
    }

    setIsGenerating(true)
    try {
      // ÂÆüÈöõ„ÅÆË¶ÅÁ¥†„ÅÆÈ´ò„Åï„ÇíÂèñÂæó
      const actualHeight = currentPageElement.offsetHeight
      console.log('üì∏ Single download element height:', actualHeight)
      
      const canvas = await html2canvas(currentPageElement, {
        background: '#ffffff',
        width: 850,
        height: actualHeight, // Âõ∫ÂÆöÂÄ§„Åß„ÅØ„Å™„ÅèÂÆüÈöõ„ÅÆÈ´ò„Åï„Çí‰ΩøÁî®
        useCORS: true,
        allowTaint: false
      })

      const link = document.createElement('a')
      link.download = `instagram-post-page-${currentPage + 1}.png`
      link.href = canvas.toDataURL('image/png')
      link.click()
    } catch (error) {
      console.error('Download failed:', error)
      alert('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
    } finally {
      setIsGenerating(false)
    }
  }

  const handleSave = () => {
    onSave(currentContent)
  }

  const handlePageTextEdit = (pageIndex: number, field: string, value: string) => {
    const updatedPages = currentContent.pages.map((page, index) => {
      if (index === pageIndex) {
        return {
          ...page,
          templateData: {
            ...page.templateData,
            [field]: value
          }
        }
      }
      return page
    })

    setCurrentContent({
      ...currentContent,
      pages: updatedPages
    })
  }

  const handleDownloadItemToggle = (itemId: string) => {
    setDownloadItems(prev => prev.map(item => 
      item.id === itemId ? { ...item, selected: !item.selected } : item
    ))
  }

  const handleSelectAll = () => {
    const allSelected = downloadItems.every(item => item.selected)
    setDownloadItems(prev => prev.map(item => ({ ...item, selected: !allSelected })))
  }

  const handleBulkDownload = async () => {
    const selectedItems = downloadItems.filter(item => item.selected)
    
    if (selectedItems.length === 0) {
      alert('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åô„Çã„Éö„Éº„Ç∏„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ')
      return
    }

    setIsDownloading(true)

    try {
      // ÈÅ∏Êäû„Åï„Çå„Åü„Éö„Éº„Ç∏„ÅßINDEX„ÇíÁîüÊàê
      let pagesToDownload = selectedItems
      
      if (mainTheme && selectedItems.length > 1) {
        const selectedPages = selectedItems.map(item => {
          const page = currentContent.pages.find(p => p.pageNumber === item.pageNumber)
          return page
        }).filter(Boolean) as GeneratedPage[]
        
        const pagesWithIndex = contentGeneratorService.generateIndexForSelectedPages(selectedPages, mainTheme)
        
        // INDEX„Éö„Éº„Ç∏„ÇíÂê´„ÇÅ„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂØæË±°„ÇíÊõ¥Êñ∞
        pagesToDownload = pagesWithIndex.map((page, index) => ({
          id: `page-${page.pageNumber}`,
          pageNumber: page.pageNumber,
          title: page.content.title || `Page ${page.pageNumber}`,
          selected: true,
          element: undefined // ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã„Åü„ÇÅ„ÄÅÂæå„ÅßË®≠ÂÆö
        }))
        
        console.log('üì• ÈÅ∏Êäû„Éö„Éº„Ç∏Áî®INDEX„Éö„Éº„Ç∏ÁîüÊàêÂÆå‰∫Ü', { 
          original: selectedItems.length, 
          withIndex: pagesToDownload.length 
        })
      }

      setDownloadProgress({ current: 0, total: pagesToDownload.length })

      // ÂêÑ„Éö„Éº„Ç∏„ÇíÂçò‰∏Ä„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÅÆÊñπÊ≥ï„ÅßÈ†ÜÊ¨°Âá¶ÁêÜ
      for (let i = 0; i < pagesToDownload.length; i++) {
        const item = pagesToDownload[i]
        
        // INDEX„Éö„Éº„Ç∏„ÅÆÂ†¥Âêà„ÅØÁâπÂà•Âá¶ÁêÜ
        if (item.pageNumber === 0) {
          // INDEX„Éö„Éº„Ç∏„Çí‰∏ÄÊôÇÁöÑ„Å´„É¨„É≥„ÉÄ„É™„É≥„Ç∞
          const tempIndexPage = currentContent.pages.find(p => p.pageNumber === 0 && p.templateType === 'index')
          if (tempIndexPage) {
            setCurrentPage(0) // INDEX„Éö„Éº„Ç∏„Å´ÁßªÂãï
            await new Promise(resolve => setTimeout(resolve, 500))
            
            const currentPageElement = pageRefs.current[0]
            if (currentPageElement) {
              await downloadSinglePage(currentPageElement, 'INDEX')
            }
          }
        } else {
          const pageIndex = item.pageNumber - 1
          
          // Ë©≤ÂΩì„Éö„Éº„Ç∏„Å´ÁßªÂãï
          setCurrentPage(pageIndex)
          
          // Â∞ë„ÅóÂæÖÊ©ü„Åó„Å¶„É¨„É≥„ÉÄ„É™„É≥„Ç∞ÂÆå‰∫Ü„ÇíÂæÖ„Å§
          await new Promise(resolve => setTimeout(resolve, 500))
          
          // Ë©≤ÂΩì„Éö„Éº„Ç∏„ÅÆË¶ÅÁ¥†„ÇíÂèñÂæó
          const currentPageElement = downloadPageRefs.current[pageIndex]
          if (!currentPageElement) {
            console.warn(`Page ${pageIndex + 1} element not found, skipping`)
            continue
          }

          // Âçò‰∏Ä„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å®Âêå„ÅòÊñπÊ≥ï„ÅßÁîªÂÉèÁîüÊàê
          await downloadSinglePage(currentPageElement, `page-${item.pageNumber}`)
        }

        setDownloadProgress({ current: i + 1, total: pagesToDownload.length })
      }

      alert(`${pagesToDownload.length}„Éö„Éº„Ç∏„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ`)
    } catch (error) {
      console.error('Bulk download failed:', error)
      alert('‰∏ÄÊã¨„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
    } finally {
      setIsDownloading(false)
      setDownloadProgress({ current: 0, total: 0 })
    }
  }

  const downloadSinglePage = async (element: HTMLDivElement, filename: string) => {
    // ÂÆüÈöõ„ÅÆË¶ÅÁ¥†„ÅÆÈ´ò„Åï„ÇíÂèñÂæó
    const actualHeight = element.offsetHeight
    console.log('üì∏ Download element height:', actualHeight, 'for', filename)
    
    const canvas = await html2canvas(element, {
      background: '#ffffff',
      width: 850,
      height: actualHeight, // Âõ∫ÂÆöÂÄ§„Åß„ÅØ„Å™„ÅèÂÆüÈöõ„ÅÆÈ´ò„Åï„Çí‰ΩøÁî®
      useCORS: true,
      allowTaint: true
    })

    // „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂÆüË°å
    const link = document.createElement('a')
    link.download = `${filename}.png`
    link.href = canvas.toDataURL('image/png')
    link.click()
  }

  const renderCurrentPage = () => {
    const page = currentContent.pages[currentPage]
    if (!page) return null

    const TemplateComponent = templateComponents[page.templateType]
    if (!TemplateComponent) {
      return <div className="text-red-500">„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>
    }

    return (
      <TemplateComponent
        data={{
          ...page.templateData,
          pageNumber: page.pageNumber
        }}
      />
    )
  }

  const renderAllPagesForDownload = () => {
    return currentContent.pages.map((page, index) => {
      const TemplateComponent = templateComponents[page.templateType]
      if (!TemplateComponent) return null

      // „Ç¢„Ç§„ÉÜ„É†Êï∞„Å´Âü∫„Å•„ÅÑ„Å¶È´ò„Åï„ÇíË®àÁÆó
      const calculateHeight = () => {
        console.log('üîç calculateHeight - templateType:', page.templateType)
        
        // Áã¨Á´ã„Éú„ÉÉ„ÇØ„ÇπÊßãÈÄ†„ÅÆÂ†¥Âêà
        if (page.templateType === 'item-n-title-content') {
          const itemCount = getItemCountForPage(page)
          console.log('üìä Item count:', itemCount)
          
          if (itemCount >= 4) {
            // 4ÂÄã‰ª•‰∏ä„ÅÆÂ†¥Âêà„ÅØÈ´ò„Åï„ÇíÊã°Âºµ„ÄÅ5ÂÄã‰ª•‰∏ä„ÅØÊîπË°åËÄÉÊÖÆ„ÅßËøΩÂä†‰ΩôÁôΩ
            const baseHeight = 280 + (itemCount * 170)
            const extraPadding = itemCount >= 5 ? 50 : 0 // 5ÂÄã‰ª•‰∏ä„ÅÆÂ†¥Âêà„ÅØ50pxËøΩÂä†
            const calculatedHeight = `${baseHeight + extraPadding}px`
            console.log('üìè Calculated height:', calculatedHeight)
            return calculatedHeight
          }
        }
        // „Éá„Éï„Ç©„É´„Éà„ÅÆÈ´ò„Åï
        console.log('üìè Using default height: 899px')
        return '899px'
      }

      const finalHeight = calculateHeight()
      console.log('üéØ Final height being applied:', finalHeight, 'for page:', page.pageNumber)

      return (
        <div
          key={`download-page-${index}`}
          ref={el => { downloadPageRefs.current[page.pageNumber - 1] = el }}
          style={{
            width: '850px',
            height: finalHeight,
            minHeight: '899px',
            position: 'fixed',
            top: '0',
            left: '-100vw',
            zIndex: 9999,
            visibility: 'visible',
            overflow: 'visible', // hidden„Åã„Çâvisible„Å´Â§âÊõ¥
            display: 'block',
            backgroundColor: '#ffffff',
            fontFamily: 'inherit'
          }}
        >
          <TemplateComponent
            data={{
              ...page.templateData,
              pageNumber: page.pageNumber
            }}
          />
        </div>
      )
    })
  }

  // „Éö„Éº„Ç∏„ÅÆ„Ç¢„Ç§„ÉÜ„É†Êï∞„ÇíÂèñÂæó„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
  const getItemCountForPage = (page: GeneratedPage) => {
    const data = page.templateData as any
    let count = 0
    
    // itemNTitle/ContentÂΩ¢Âºè„Çí„ÉÅ„Çß„ÉÉ„ÇØ
    for (let i = 1; i <= 6; i++) {
      if (data[`item${i}Title`] || data[`item${i}Content`]) {
        count++
      }
    }
    
    // ÈÄöÂ∏∏„ÅÆitemsÈÖçÂàó„ÇÇ„ÉÅ„Çß„ÉÉ„ÇØ
    if (count === 0 && data.items) {
      count = Array.isArray(data.items) ? data.items.length : 0
    }
    
    return count
  }

  const renderTemplateSelection = () => {
    if (!isTemplateSelectionMode || selectedPageForTemplateChange === null) return null

    const targetPage = currentContent.pages[selectedPageForTemplateChange]
    const allTemplates = templateMatchingService.getAllTemplatesWithScores(targetPage)

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-xl font-bold">„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû - {selectedPageForTemplateChange + 1}„Éö„Éº„Ç∏ÁõÆ</h3>
            <button
              onClick={() => {
                setIsTemplateSelectionMode(false)
                setSelectedPageForTemplateChange(null)
              }}
              className="text-gray-500 hover:text-gray-700"
            >
              ‚úï
            </button>
          </div>

          <div className="mb-4 text-sm text-gray-600">
            ÂÖ®{allTemplates.length}Á®ÆÈ°û„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åã„ÇâÈÅ∏Êäû„Åß„Åç„Åæ„Åô„ÄÇÈÅ©ÂêàÂ∫¶È†Ü„Å´Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ
          </div>

          <div className="space-y-3">
            {allTemplates.map((template, index) => (
              <div
                key={template.templateType}
                className={`p-4 border rounded-lg cursor-pointer transition-colors ${
                  template.templateType === targetPage.templateType
                    ? 'border-blue-500 bg-blue-50'
                    : 'border-gray-200 hover:border-gray-300'
                }`}
                onClick={() => handleTemplateChange(selectedPageForTemplateChange, template.templateType)}
              >
                <div className="flex justify-between items-start">
                  <div>
                    <h4 className="font-medium text-lg">{template.displayName}</h4>
                    <p className="text-sm text-gray-600 mt-1">{template.reason}</p>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">
                      ÈÅ©ÂêàÂ∫¶: {Math.round(template.score * 100)}%
                    </span>
                    {template.templateType === targetPage.templateType && (
                      <span className="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">
                        ÁèæÂú®‰ΩøÁî®‰∏≠
                      </span>
                    )}
                    {index < 3 && (
                      <span className="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs">
                        Êé®Â•®
                      </span>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>

          <div className="mt-6 flex justify-end gap-3">
            <button
              onClick={() => {
                setIsTemplateSelectionMode(false)
                setSelectedPageForTemplateChange(null)
              }}
              className="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50"
            >
              „Ç≠„É£„É≥„Çª„É´
            </button>
          </div>
        </div>
      </div>
    )
  }

  const renderTextEditModal = () => {
    if (!isEditMode || editingPage === null) return null

    const page = currentContent.pages[editingPage]
    if (!page) return null

    const handleArrayItemEdit = (field: string, index: number, itemField: string, value: string) => {
      const updatedPages = currentContent.pages.map((p, i) => {
        if (i === editingPage) {
          const currentArray = p.templateData?.[field] || []
          const updatedArray = [...currentArray]
          if (updatedArray[index]) {
            updatedArray[index] = {
              ...updatedArray[index],
              [itemField]: value
            }
          }
          return {
            ...p,
            templateData: {
              ...p.templateData,
              [field]: updatedArray
            }
          }
        }
        return p
      })

      setCurrentContent({
        ...currentContent,
        pages: updatedPages
      })
    }

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-xl font-bold">„Éö„Éº„Ç∏ {editingPage + 1} - „ÉÜ„Ç≠„Çπ„ÉàÁ∑®ÈõÜ ({templateRegistry[page.templateType]?.name || page.templateType})</h3>
            <button
              onClick={() => {
                setIsEditMode(false)
                setEditingPage(null)
              }}
              className="text-gray-500 hover:text-gray-700"
            >
              ‚úï
            </button>
          </div>

          <div className="space-y-6">
            {/* „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†± */}
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
              <h4 className="text-sm font-semibold text-yellow-800 mb-2">„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±</h4>
              <pre className="text-xs text-yellow-700 whitespace-pre-wrap">
                {JSON.stringify({
                  templateType: page.templateType,
                  hasItems: !!page.templateData?.items,
                  itemsLength: page.templateData?.items?.length || 0,
                  hasSteps: !!page.templateData?.steps,
                  hasPoints: !!page.templateData?.points,
                  hasBoxes: !!page.templateData?.boxes,
                  templateDataKeys: Object.keys(page.templateData || {})
                }, null, 2)}
              </pre>
            </div>

            {/* Âü∫Êú¨„Éï„Ç£„Éº„É´„Éâ */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">„Çø„Ç§„Éà„É´</label>
                <input
                  type="text"
                  value={page.templateData?.title || ''}
                  onChange={(e) => handlePageTextEdit(editingPage, 'title', e.target.value)}
                  className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">„Çµ„Éñ„Çø„Ç§„Éà„É´</label>
                <input
                  type="text"
                  value={page.templateData?.subtitle || ''}
                  onChange={(e) => handlePageTextEdit(editingPage, 'subtitle', e.target.value)}
                  className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">„É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ</label>
              <textarea
                value={page.templateData?.content || ''}
                onChange={(e) => handlePageTextEdit(editingPage, 'content', e.target.value)}
                className="w-full p-3 border rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                rows={3}
              />
            </div>

            {/* StepsÁ∑®ÈõÜ (simple5Áî®) */}
            {page.templateData?.steps && (
              <div>
                <h4 className="text-lg font-semibold mb-3">„Çπ„ÉÜ„ÉÉ„Éó</h4>
                <div className="space-y-3">
                  {page.templateData.steps.map((step: any, index: number) => (
                    <div key={index} className="border rounded-lg p-4 bg-gray-50">
                      <div className="flex items-center gap-2 mb-2">
                        <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">„Çπ„ÉÜ„ÉÉ„Éó {step.step}</span>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">„Çø„Ç§„Éà„É´</label>
                          <input
                            type="text"
                            value={step.title || ''}
                            onChange={(e) => handleArrayItemEdit('steps', index, 'title', e.target.value)}
                            className="w-full p-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Ë™¨Êòé</label>
                          <textarea
                            value={step.description || ''}
                            onChange={(e) => handleArrayItemEdit('steps', index, 'description', e.target.value)}
                            className="w-full p-2 border rounded-md resize-none focus:outline-none focus:ring-1 focus:ring-blue-500"
                            rows={2}
                          />
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* PointsÁ∑®ÈõÜ (explanation2Áî®) */}
            {page.templateData?.points && (
              <div>
                <h4 className="text-lg font-semibold mb-3">„Éù„Ç§„É≥„Éà</h4>
                <div className="space-y-3">
                  {page.templateData.points.map((point: any, index: number) => (
                    <div key={index} className="border rounded-lg p-4 bg-gray-50">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">„Çø„Ç§„Éà„É´</label>
                          <input
                            type="text"
                            value={point.title || ''}
                            onChange={(e) => handleArrayItemEdit('points', index, 'title', e.target.value)}
                            className="w-full p-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Ë™¨Êòé</label>
                          <textarea
                            value={point.description || ''}
                            onChange={(e) => handleArrayItemEdit('points', index, 'description', e.target.value)}
                            className="w-full p-2 border rounded-md resize-none focus:outline-none focus:ring-1 focus:ring-blue-500"
                            rows={2}
                          />
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* ItemsÁ∑®ÈõÜ (enumerationÁ≠âÁî®) */}
            {page.templateData?.items && page.templateData.items.length > 0 && (
              <div>
                <h4 className="text-lg font-semibold mb-3">„Ç¢„Ç§„ÉÜ„É† ({page.templateData.items.length}ÂÄã)</h4>
                <div className="space-y-3">
                  {page.templateData.items.map((item: any, index: number) => (
                    <div key={index} className="border rounded-lg p-4 bg-gray-50">
                      {typeof item === 'string' ? (
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">„Ç¢„Ç§„ÉÜ„É† {index + 1}</label>
                          <input
                            type="text"
                            value={item}
                            onChange={(e) => {
                              const updatedPages = currentContent.pages.map((p, i) => {
                                if (i === editingPage) {
                                  const updatedItems = [...(p.templateData?.items || [])]
                                  updatedItems[index] = e.target.value
                                  return {
                                    ...p,
                                    templateData: {
                                      ...p.templateData,
                                      items: updatedItems
                                    }
                                  }
                                }
                                return p
                              })
                              setCurrentContent({ ...currentContent, pages: updatedPages })
                            }}
                            className="w-full p-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                          />
                        </div>
                      ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">„Çø„Ç§„Éà„É´</label>
                            <input
                              type="text"
                              value={item.title || ''}
                              onChange={(e) => handleArrayItemEdit('items', index, 'title', e.target.value)}
                              className="w-full p-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">ÂÜÖÂÆπ</label>
                            <textarea
                              value={item.content || ''}
                              onChange={(e) => handleArrayItemEdit('items', index, 'content', e.target.value)}
                              className="w-full p-2 border rounded-md resize-none focus:outline-none focus:ring-1 focus:ring-blue-500"
                              rows={2}
                            />
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* BoxesÁ∑®ÈõÜ (simple2Áî®) */}
            {page.templateData?.boxes && (
              <div>
                <h4 className="text-lg font-semibold mb-3">„Éú„ÉÉ„ÇØ„Çπ</h4>
                <div className="space-y-3">
                  {page.templateData.boxes.map((box: any, index: number) => (
                    <div key={index} className="border rounded-lg p-4 bg-gray-50">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">„Çø„Ç§„Éà„É´</label>
                          <input
                            type="text"
                            value={box.title || ''}
                            onChange={(e) => handleArrayItemEdit('boxes', index, 'title', e.target.value)}
                            className="w-full p-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">ÂÜÖÂÆπ</label>
                          <textarea
                            value={box.content || ''}
                            onChange={(e) => handleArrayItemEdit('boxes', index, 'content', e.target.value)}
                            className="w-full p-2 border rounded-md resize-none focus:outline-none focus:ring-1 focus:ring-blue-500"
                            rows={2}
                          />
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          <div className="mt-6 flex justify-end gap-3">
            <button
              onClick={() => {
                setIsEditMode(false)
                setEditingPage(null)
              }}
              className="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50"
            >
              Èñâ„Åò„Çã
            </button>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* „Éò„ÉÉ„ÉÄ„Éº */}
      <div className="bg-white shadow-sm border-b">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-4">
            <div className="flex items-center gap-4">
              <button
                onClick={onBack}
                className="flex items-center gap-2 text-gray-600 hover:text-gray-800"
              >
                <ArrowLeft size={20} />
                Êàª„Çã
              </button>
              <div className="flex items-center gap-2">
                <h1 className="text-xl font-bold text-gray-800">ÊäïÁ®ø„Ç®„Éá„Ç£„Çø„Éº</h1>
                <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                  {currentContent.pages.length}„Éö„Éº„Ç∏
                </span>
              </div>
            </div>
            
            <div className="flex items-center gap-3">
              <button
                onClick={() => {
                  setSelectedPageForTemplateChange(currentPage)
                  setIsTemplateSelectionMode(true)
                }}
                className="flex items-center gap-2 px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600"
              >
                <Palette size={16} />
                „ÉÜ„É≥„Éó„É¨„Éº„ÉàÂ§âÊõ¥
              </button>
              <button
                onClick={handleDownload}
                disabled={isGenerating}
                className="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:opacity-50"
              >
                {isGenerating ? (
                  <RefreshCw size={16} className="animate-spin" />
                ) : (
                  <Download size={16} />
                )}
                Âçò‰∏Ä„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
              </button>
              <button
                onClick={handleBulkDownload}
                disabled={isDownloading || downloadItems.filter(item => item.selected).length === 0}
                className="flex items-center gap-2 px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600 disabled:opacity-50"
              >
                {isDownloading ? (
                  <RefreshCw size={16} className="animate-spin" />
                ) : (
                  <PackageOpen size={16} />
                )}
                ‰∏ÄÊã¨„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ ({downloadItems.filter(item => item.selected).length})
              </button>
              <button
                onClick={handleSave}
                className="flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600"
              >
                <Save size={16} />
                ‰øùÂ≠ò
              </button>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢ */}
          <div className="lg:col-span-2">
            <div className="bg-white rounded-lg shadow-sm p-6">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-semibold">„Éó„É¨„Éì„É•„Éº</h2>
                <div className="flex items-center gap-2">
                  <span className="text-sm text-gray-500">
                    {currentPage + 1} / {currentContent.pages.length}
                  </span>
                  <button
                    onClick={() => handlePageNavigation('prev')}
                    disabled={currentPage === 0}
                    className="p-2 border rounded-md hover:bg-gray-50 disabled:opacity-50"
                  >
                    <ChevronLeft size={16} />
                  </button>
                  <button
                    onClick={() => handlePageNavigation('next')}
                    disabled={currentPage === currentContent.pages.length - 1}
                    className="p-2 border rounded-md hover:bg-gray-50 disabled:opacity-50"
                  >
                    <ChevronRight size={16} />
                  </button>
                </div>
              </div>

              <div className="flex justify-center">
                <div ref={previewRef}>
                  <Viewport width={850} height={899}>
                    <div ref={el => { pageRefs.current[currentPage] = el }}>
                      {renderCurrentPage()}
                    </div>
                  </Viewport>
                </div>
              </div>

              {/* ‰∏ÄÊã¨„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÈÄ≤Êçó */}
              {isDownloading && (
                <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                  <div className="flex items-center gap-2 mb-2">
                    <RefreshCw size={16} className="animate-spin text-blue-600" />
                    <span className="text-blue-800 font-medium">
                      „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ‰∏≠... ({downloadProgress.current}/{downloadProgress.total})
                    </span>
                  </div>
                  <div className="w-full bg-blue-200 rounded-full h-2">
                    <div 
                      className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                      style={{ width: `${downloadProgress.total > 0 ? (downloadProgress.current / downloadProgress.total) * 100 : 0}%` }}
                    />
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* „Çµ„Ç§„Éâ„Éê„Éº */}
          <div className="space-y-6">
            {/* „Éö„Éº„Ç∏‰∏ÄË¶ß */}
            <div className="bg-white rounded-lg shadow-sm p-4">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-semibold">„Éö„Éº„Ç∏‰∏ÄË¶ß</h3>
                <button
                  onClick={handleSelectAll}
                  className="flex items-center gap-2 text-sm text-blue-600 hover:text-blue-800"
                >
                  {downloadItems.every(item => item.selected) ? (
                    <CheckSquare size={16} />
                  ) : (
                    <Square size={16} />
                  )}
                  ÂÖ®ÈÅ∏Êäû
                </button>
              </div>
              <div className="space-y-2">
                {currentContent.pages.map((page, index) => {
                  const downloadItem = downloadItems.find(item => item.pageNumber === page.pageNumber)
                  return (
                    <div
                      key={index}
                      className={`p-3 border rounded-lg transition-colors ${
                        index === currentPage
                          ? 'border-blue-500 bg-blue-50'
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="flex justify-between items-start">
                        <div 
                          className="flex-1 cursor-pointer"
                          onClick={() => setCurrentPage(index)}
                        >
                          <div className="font-medium text-sm">
                            {index + 1}. {page.templateData?.title || page.content?.title || '„Çø„Ç§„Éà„É´„Å™„Åó'}
                          </div>
                          <div className="text-xs text-gray-500 mt-1">
                            {templateRegistry[page.templateType]?.name || page.templateType}
                          </div>
                        </div>
                        <div className="flex items-center gap-2">
                          <button
                            onClick={() => handleDownloadItemToggle(downloadItem?.id || `page-${page.pageNumber}`)}
                            className="p-1 hover:bg-gray-100 rounded"
                            title="„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÈÅ∏Êäû"
                          >
                            {downloadItem?.selected ? (
                              <CheckSquare size={16} className="text-green-600" />
                            ) : (
                              <Square size={16} className="text-gray-400" />
                            )}
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation()
                              setEditingPage(index)
                              setIsEditMode(true)
                            }}
                            className="p-1 hover:bg-gray-100 rounded"
                            title="„ÉÜ„Ç≠„Çπ„ÉàÁ∑®ÈõÜ"
                          >
                            <Edit size={14} />
                          </button>
                        </div>
                      </div>
                    </div>
                  )
                })}
              </div>
            </div>

            {/* „Ç≠„É£„Éó„Ç∑„Éß„É≥„Éª„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞ */}
            <div className="bg-white rounded-lg shadow-sm p-4">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-semibold">„Ç≠„É£„Éó„Ç∑„Éß„É≥„Éª„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞</h3>
                <div className="flex gap-2">
                  <button
                    onClick={async () => {
                      // „Ç≠„É£„Éó„Ç∑„Éß„É≥ÂÜçÁîüÊàê
                      try {
                        console.log('üîÑ „Ç≠„É£„Éó„Ç∑„Éß„É≥ÂÜçÁîüÊàêÈñãÂßã')
                        setIsGenerating(true)
                        
                        // AIÁîüÊàê„Çí‰ΩøÁî®„Åó„Å¶„Ç≠„É£„Éó„Ç∑„Éß„É≥ÂÜçÁîüÊàê
                        const newCaption = await contentGeneratorService.regenerateCaption(currentContent)
                        
                        console.log('üìù Êñ∞„Åó„ÅÑ„Ç≠„É£„Éó„Ç∑„Éß„É≥:', newCaption)
                        
                        setCurrentContent({
                          ...currentContent,
                          caption: newCaption
                        })
                        
                        console.log('‚úÖ „Ç≠„É£„Éó„Ç∑„Éß„É≥ÂÜçÁîüÊàêÂÆå‰∫Ü')
                      } catch (error) {
                        console.error('‚ùå „Ç≠„É£„Éó„Ç∑„Éß„É≥ÂÜçÁîüÊàê„Ç®„É©„Éº:', error)
                        alert('„Ç≠„É£„Éó„Ç∑„Éß„É≥ÂÜçÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (error instanceof Error ? error.message : '‰∏çÊòé„Å™„Ç®„É©„Éº'))
                      } finally {
                        setIsGenerating(false)
                      }
                    }}
                    disabled={isGenerating}
                    className="flex items-center gap-2 px-3 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:opacity-50 text-sm"
                  >
                    {isGenerating ? (
                      <RefreshCw size={14} className="animate-spin" />
                    ) : (
                      <RefreshCw size={14} />
                    )}
                    „Ç≠„É£„Éó„Ç∑„Éß„É≥ÂÜçÁîüÊàê
                  </button>
                  <button
                    onClick={async () => {
                      // „Éè„ÉÉ„Ç∑„É•„Çø„Ç∞ÂÜçÁîüÊàê
                      try {
                        setIsGenerating(true)
                        // ÂÖ®„Éö„Éº„Ç∏„ÅÆÂÜÖÂÆπ„ÇíÁµêÂêà„Åó„Å¶„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞ÁîüÊàê
                        const contentForHashtags = currentContent.pages.map(page => 
                          `${page.content.title || ''} ${page.content.description || ''} ${page.content.subtitle || ''}`
                        ).join(' ')
                        
                        // HashtagService„Çí‰ΩøÁî®„Åó„Å¶„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞ÁîüÊàê
                        const { hashtagService } = await import('../config/hashtags')
                        const newHashtags = hashtagService.selectHashtags(contentForHashtags)
                        
                        setCurrentContent({
                          ...currentContent,
                          hashtags: {
                            primary: newHashtags.large,
                            secondary: newHashtags.medium,
                            trending: newHashtags.small,
                            large: newHashtags.large,
                            medium: newHashtags.medium,
                            small: newHashtags.small,
                            all: newHashtags.all
                          }
                        })
                      } catch (error) {
                        alert('„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞ÂÜçÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
                      } finally {
                        setIsGenerating(false)
                      }
                    }}
                    disabled={isGenerating}
                    className="flex items-center gap-2 px-3 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 disabled:opacity-50 text-sm"
                  >
                    <RefreshCw size={14} />
                    „Éè„ÉÉ„Ç∑„É•„Çø„Ç∞ÂÜçÁîüÊàê
                  </button>
                </div>
              </div>
              <div className="space-y-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    „Ç≠„É£„Éó„Ç∑„Éß„É≥
                  </label>
                  <textarea
                    value={currentContent.caption}
                    onChange={(e) => setCurrentContent({
                      ...currentContent,
                      caption: e.target.value
                    })}
                    className="w-full p-3 border rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                    rows={4}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    „Éè„ÉÉ„Ç∑„É•„Çø„Ç∞
                  </label>
                  <div className="space-y-2">
                    <div className="flex flex-wrap gap-2">
                      {currentContent.hashtags.primary.map((tag, index) => (
                        <span key={`primary-${index}`} className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm">
                          {tag}
                        </span>
                      ))}
                      {currentContent.hashtags.secondary.map((tag, index) => (
                        <span key={`secondary-${index}`} className="bg-gray-100 text-gray-700 px-2 py-1 rounded-full text-sm">
                          {tag}
                        </span>
                      ))}
                      {currentContent.hashtags.trending.map((tag, index) => (
                        <span key={`trending-${index}`} className="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm">
                          {tag}
                        </span>
                      ))}
                    </div>
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Áµ±Âêà„Ç≥„Éî„ÉºÁî®Ôºà„Ç≠„É£„Éó„Ç∑„Éß„É≥ + „Éè„ÉÉ„Ç∑„É•„Çø„Ç∞Ôºâ
                  </label>
                  <div className="relative">
                    <textarea
                      value={`${currentContent.caption}${includeMiddleFooter ? getMiddleFooter() : ''}${includeEndFooter ? getEndFooter() : ''}\n\n${currentContent.hashtags.all.join(' ')}`}
                      readOnly
                      className="w-full p-3 border rounded-md resize-none bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      rows={12}
                    />
                    <button
                      onClick={() => {
                        const combinedText = `${currentContent.caption}${includeMiddleFooter ? getMiddleFooter() : ''}${includeEndFooter ? getEndFooter() : ''}\n\n${currentContent.hashtags.all.join(' ')}`
                        navigator.clipboard.writeText(combinedText)
                        // Á∞°Âçò„Å™„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíË°®Á§∫
                        const btn = document.activeElement as HTMLButtonElement
                        const originalText = btn.textContent
                        btn.textContent = '„Ç≥„Éî„ÉºÂÆå‰∫ÜÔºÅ'
                        setTimeout(() => {
                          btn.textContent = originalText
                        }, 1000)
                      }}
                      className="absolute top-2 right-2 bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600"
                    >
                      „Ç≥„Éî„Éº
                    </button>
                  </div>
                  
                  {/* Âõ∫ÂÆö„Éï„ÉÉ„Çø„ÉºÈÅ∏Êäû */}
                  <div className="mt-4 space-y-4">
                    <div className="flex items-center gap-4">
                      <label className="text-sm font-medium text-gray-700">Âõ∫ÂÆö„Éï„ÉÉ„Çø„Éº:</label>
                      <div className="flex gap-4">
                        <label className="flex items-center">
                          <input
                            type="checkbox"
                            checked={includeMiddleFooter}
                            onChange={(e) => setIncludeMiddleFooter(e.target.checked)}
                            className="mr-2"
                          />
                          <span className="text-sm">‰∏≠Áõ§</span>
                        </label>
                        <label className="flex items-center">
                          <input
                            type="checkbox"
                            checked={includeEndFooter}
                            onChange={(e) => setIncludeEndFooter(e.target.checked)}
                            className="mr-2"
                          />
                          <span className="text-sm">ÂæåÂçä</span>
                        </label>
                      </div>
                    </div>
                    
                    {/* ‰∏≠Áõ§Âõ∫ÂÆö„Éï„ÉÉ„Çø„Éº */}
                    <div className="border-t pt-4">
                      <div className="bg-gray-50 p-3 rounded-md">
                        <div className="text-xs text-gray-600 mb-2">„Äê‰∏≠Áõ§Âõ∫ÂÆö„Éï„ÉÉ„Çø„Éº„Äë</div>
                        <div className="text-sm text-gray-700 whitespace-pre-line">
                          {getMiddleFooter()}
                        </div>
                      </div>
                    </div>
                    
                    {/* ÂæåÂçäÂõ∫ÂÆö„Éï„ÉÉ„Çø„Éº */}
                    <div className="border-t pt-4">
                      <div className="bg-gray-50 p-3 rounded-md">
                        <div className="text-xs text-gray-600 mb-2">„ÄêÂæåÂçäÂõ∫ÂÆö„Éï„ÉÉ„Çø„Éº„Äë</div>
                        <div className="text-sm text-gray-700 whitespace-pre-line">
                          {getEndFooter()}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ */}
      {renderTemplateSelection()}

      {/* „ÉÜ„Ç≠„Çπ„ÉàÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ */}
      {renderTextEditModal()}

      {/* ‰∏ÄÊã¨„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÁî®„ÅÆÈö†„Åó„Éö„Éº„Ç∏ */}
      <div style={{ position: 'relative' }}>
        {renderAllPagesForDownload()}
      </div>
    </div>
  )
}