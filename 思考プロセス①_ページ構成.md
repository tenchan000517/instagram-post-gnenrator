# 思考プロセス① - ページ構成詳細分析

## 概要
6つの完成ページ構成パターンの詳細分析。各構成の流れ、テンプレート要件、使用場面を明確化。

## 1. typeID001-emotion-empathy-list（感情共感型問題解決）

### 基本情報
- **名称**: TypeID001 感情共感型問題解決
- **特徴**: 感情的な問題・困りごとに対する共感型アプローチ
- **ページ構造**: 導入→リスト→まとめ

### ページ流れ
```
Page 1 (optional): emotion_empathy_intro
       ↓
Page 2-N (dynamic): emotion_empathy_list（メインコンテンツ）
       ↓
Page Last (optional): emotion_empathy_summary
```

### テンプレート要件
1. **basic_intro** (統合BasicIntroTemplate)
   - 導入・問題提起用
   - 投稿タイプ・ターゲット別動的キャラクター画像選択
   - オプショナル（省略可能）

2. **emotion_empathy_list** (EmotionEmpathyListTemplate)
   - **メインコンテンツ**
   - 動的ページ数対応
   - 必須フィールド: `number`, `title`, `content[]`, `additionalText?`

3. **emotion_empathy_summary** (EmotionEmpathyListTemplate代用)
   - まとめ・締めくくり用
   - オプショナル（省略可能）

### 使用想定シーン
- 感情的な悩みへの共感
- 心理的サポート
- 価値観転換

---

## 2. typeID001-episode-parallel-intro（エピソード並列紹介型）

### 基本情報
- **名称**: TypeID001 エピソード並列紹介型
- **特徴**: 失敗体験エピソードを通じた学習
- **ページ構造**: 導入→エピソード群→まとめ

### ページ流れ
```
Page 1: basic_intro
       ↓
Page 2-N (dynamic): failure_episode（複数エピソード）
       ↓
Page Last (optional): episode_summary ※未実装
```

### テンプレート要件
1. **basic_intro** (統合BasicIntroTemplate)
   - 問いかけ導入
   - 投稿タイプ・ターゲット別動的キャラクター画像選択
   - 必須フィールド: `title`, `targetAudience`, `problems[]`, `additionalMessage`

2. **failure_episode** (FailureEpisodeTemplate)
   - **メインコンテンツ**（複数エピソード）
   - 動的ページ数対応
   - 必須フィールド: `episodeNumber`, `title`, `description`, `failure`, `conclusion`
   - オプショナル: `logo`, `savePrompt`, `question`

3. **episode_summary** (❌未実装）
   - まとめページ
   - 現在は最終ページ無しで運用

### 使用想定シーン
- 失敗体験からの学び
- エピソード並列紹介
- ストーリーテリング

---

## 3. typeID002-ng-good-comparison-pattern（NG/GOOD比較フォーカス型）

### 基本情報
- **名称**: TypeID002 NG/GOOD比較フォーカス型
- **特徴**: 実践的スキル習得において、NG例とGOOD例の対比による学習効果最大化
- **ページ構造**: 導入→比較→まとめ

### ページ流れ
```
Page 1: basic_intro
       ↓
Page 2-N (dynamic): ng_good_comparison（比較コンテンツ）
       ↓
Page Final: achievement_summary
```

### テンプレート要件
1. **basic_intro** (BasicIntroTemplate)
   - 基本導入
   - 必須フィールド: `title`, `targetAudience`, `problems[]`, `additionalMessage`

2. **ng_good_comparison** (NgGoodComparisonTemplate)
   - **メインコンテンツ**（NG/GOOD比較）
   - 動的ページ数対応  
   - 必須フィールド: `title`, `content[]`（❌/✅記号解析）

3. **achievement_summary** (AchievementSummaryTemplate)
   - 達成まとめ
   - 必須フィールド: `summaryTitle`, `achievementPoints[]`, `encouragementMessage`

### 使用想定シーン
- スキル習得支援
- 良い例・悪い例の対比
- 実践的ノウハウ

---

## 4. typeID002-parallel-introduction（並列紹介型）

### 基本情報
- **名称**: TypeID002 並列紹介型
- **特徴**: 複数の方法・ポイントを並列的に紹介
- **ページ構造**: 導入→並列紹介→まとめ

### ページ流れ
```
Page 1: basic_intro
       ↓
Page 2-N (dynamic): dual_enumeration（2個ずつ並列）
       ↓
Page Last: achievement_summary
```

### テンプレート要件
1. **basic_intro** (BasicIntroTemplate)
   - 基本導入
   - 必須フィールド: `title`, `targetAudience`, `problems[]`, `additionalMessage`
   - 追加: `savePrompt`

2. **dual_enumeration** (DualEnumerationTemplate)
   - **メインコンテンツ**（2個ずつ並列表示）
   - 動的ページ数対応
   - 必須フィールド: `items[]`（厳密に2個）
   - アイテム構造: `{number, title, description, imageSrc?}`

3. **achievement_summary** (AchievementSummaryTemplate)
   - 達成まとめ
   - 必須フィールド: `summaryTitle`, `achievementPoints[]`, `encouragementMessage`

### 使用想定シーン
- 方法論の並列紹介
- ポイント・テクニック集
- K132のような実践的ノウハウ

---

## 5. typeID002-sequential-dependency（順序依存型ステップフロー）

### 基本情報
- **名称**: TypeID002 順序依存型ステップフロー
- **特徴**: 段階的・順序立てたステップガイド
- **ページ構造**: 導入→ステップ群→まとめ

### ページ流れ
```
Page 1: basic_intro
       ↓
Page 2-N (dynamic): step_guide_achievement（順序ステップ）
       ↓
Page Last (optional): achievement_summary
```

### テンプレート要件
1. **basic_intro** (BasicIntroTemplate)
   - 基本導入
   - 必須フィールド: `title`, `targetAudience`, `problems[]`, `additionalMessage`
   - 追加: `savePrompt`

2. **step_guide_achievement** (StepGuideAchievementTemplate)
   - **メインコンテンツ**（ステップガイド）
   - 動的ページ数対応
   - 必須フィールド: `pointNumber`, `title`, `content[]`
   - オプショナル: `actionItems[]`, `illustrationImage`

3. **achievement_summary** (AchievementSummaryTemplate)
   - 達成まとめ（オプショナル）
   - 必須フィールド: `summaryTitle`, `achievementPoints[]`, `encouragementMessage`

### 使用想定シーン
- 段階的学習コンテンツ
- プロセス指導
- 順序重要な手順説明

---

## 6. typeID004-tools-services-introduction（ツール・サービス紹介型）

### 基本情報
- **名称**: TypeID004 ツール・サービス紹介型
- **特徴**: ツールやサービスの具体的紹介
- **ページ構造**: 導入→ツール群→まとめ

### ページ流れ
```
Page 1: tools_intro
       ↓
Page 2-N (dynamic): multiple_items_display（ツール群）
       ↓
Page Last: achievement_summary
```

### テンプレート要件
1. **tools_intro** (ToolsIntroTemplate)
   - ツール紹介専用導入（ten.png使用）
   - 必須フィールド: `title`, `targetAudience`, `problems[]`, `additionalMessage`
   - 追加: `savePrompt`

2. **multiple_items_display** (MultipleItemsDisplayTemplate)
   - **メインコンテンツ**（3個のツール紹介）
   - 動的ページ数対応
   - 必須フィールド: `tools[]` or `items[]`（3個）
   - オプショナル: `title`, `subtitle`, `category`, `benefit`
   - アイテム構造: `{name, description, imageSrc?}`

3. **achievement_summary** (AchievementSummaryTemplate)
   - 達成まとめ
   - 必須フィールド: `summaryTitle`, `achievementPoints[]`, `encouragementMessage`

### 使用想定シーン
- AI・ツール紹介
- サービス比較
- 効率化ツール集

---

## 共通パターン分析

### ページ数の仕組み
- **固定ページ**: `pageNumber: 1`, `pageNumber: "last"`
- **動的ページ**: `pageNumber: "dynamic"` 
- **オプショナル**: `optional: true`

### テンプレート分類
- **導入系**: `basic_intro`, `tools_intro`, `failure_story_intro`, `emotion_empathy_intro`
- **メインコンテンツ系**: `dual_enumeration`, `ng_good_comparison`, `step_guide_achievement`, `multiple_items_display`, `failure_episode`, `emotion_empathy_list`
- **まとめ系**: `achievement_summary`, `emotion_empathy_summary`, `episode_summary`

### 構造設計思想
1. **4段階構造**: 導入（共感やターゲットの悩みなど）→ INDEX的な要素（オプショナル）→ メインコンテンツ → まとめ（オプショナル）
2. **導入の複数性**: 導入は一つとは限らない（複数ページの導入も可能）
3. **INDEX要素**: コンテンツ内容的にINDEXがあった方がいいものと不要なものがある（オプショナル）
4. **動的ページ対応**: メインコンテンツは複数ページに分割可能
5. **投稿タイプ別テンプレート**: 同じレイアウト・構造でも投稿タイプごとに全て違うテンプレートを使用（キャラクターが異なるため）

---

## テンプレート完成度評価

### 完成テンプレート
- **basic_intro** ✅ 完成
- **tools_intro** ✅ 完成

### 優秀テンプレート
- **multiple_items_display** 🌟 優秀

### 特定用途に最適
- **dual_enumeration** 🎯 8~12個の並列紹介に最適
  - 特に画像挿入のオプショナル機能が優秀
  - **改善要望**: 同じ概念で4~6個の紹介用に上下ではなく1つを紹介するものが必要

### 仮実装・要改善
- **step_guide_achievement** ⚠️ デザイン自体は仮実装

### 未確認テンプレート
- **EmotionEmpathyListTemplate** ❓ デザイン確認未完了
- **FailureStoryIntroTemplate** ❓ デザイン確認未完了
- **FailureEpisodeTemplate** ❓ デザイン確認未完了
- **NgGoodComparisonTemplate** ❓ デザイン確認未完了
- **AchievementSummaryTemplate** ❓ デザイン確認未完了

### 未実装要素
- **EpisodeSummaryTemplate** ❌ 未実装
- **4~6個紹介用の単一表示テンプレート** ❌ 未実装（dual_enumerationの改良版）

---

## 新規追加テンプレート（2025年実装）

### 投稿タイプ別導入テンプレート（8個）

#### 通常版（4個）
- **Type001IntroTemplate** (`type001_intro`) - misaki_worry.png、ピンク背景
- **Type002IntroTemplate** (`type002_intro`) - king.png、オレンジ背景  
- **Type003IntroTemplate** (`type003_intro`) - kikuyo.png、緑背景
- **Type004IntroTemplate** (`type004_intro`) - ten.png、ピンク背景

#### 就活版（4個）
- **Type001IntroJobTemplate** (`type001_intro_job`) - iida.png、ピンク背景
- **Type002IntroJobTemplate** (`type002_intro_job`) - iida.png、オレンジ背景
- **Type003IntroJobTemplate** (`type003_intro_job`) - iida.png、緑背景  
- **Type004IntroJobTemplate** (`type004_intro_job`) - iida.png、ピンク背景

### 新規ページ構成（2個）

#### 7. typeID001-basic-intro（Type001基本導入型）
```
Page 1: type001_intro (templateOptions: ["type001_intro", "type001_intro_job", "basic_intro"])
       ↓
Page 2-N (dynamic): dual_enumeration（2個ずつ並列）
       ↓
Page Last (optional): achievement_summary
```

#### 8. typeID003-basic-intro（Type003基本導入型）
```
Page 1: type003_intro (templateOptions: ["type003_intro", "type003_intro_job", "basic_intro"])
       ↓
Page 2-N (dynamic): multiple_items_display（2-5個アイテム）
       ↓
Page Last (optional): achievement_summary
```

### 既存ページ構成の更新

#### Type002系（3ファイル）
- **typeID002-ng-good-comparison-pattern**
- **typeID002-parallel-introduction**  
- **typeID002-sequential-dependency**

**更新内容**: Page 1のtemplateOptionsに選択肢追加
```json
"templateOptions": ["basic_intro", "type002_intro", "type002_intro_job"]
```

#### Type004系（1ファイル）
- **typeID004-tools-services-introduction**

**更新内容**: Page 1のtemplateOptionsに選択肢追加
```json
"templateOptions": ["tools_intro", "type004_intro", "type004_intro_job"]
```

### システム統合状況
- **index.ts**: 全8テンプレートのエクスポート・インポート・マッピング完了
- **ページ構成**: 6ファイル更新（4更新+2新規）
- **編集機能**: 既存システムと並存（段階的移行対応）

### 使用方針
1. **新規Kxxx作成時**: 新しいテンプレートIDを使用
2. **既存Kxxx更新時**: 段階的に新テンプレートに移行
3. **ターゲット別対応**: 就活案件はiida.png版を使用
4. **旧テンプレート**: 移行完了後に削除予定

---

## Type003（業界情報）の真の定義と再分類の必要性

### contents/00サンプル分析結果

contents/00ディレクトリ内の16枚の投稿画像から判明した、真の「業界情報」コンテンツの特徴：

#### **真の業界情報の特徴**
1. **データドリブンな企業情報**
   - 年収・採用人数・残業時間等の具体的数値データ
   - 業界内での相対的な位置づけ（ランキング形式）
   - 企業の労働条件・福利厚生の詳細情報

2. **業界トレンド・技術情報**
   - 生成AIの業界での活用実態
   - 新しいビジネスツールの紹介
   - 業界での技術導入状況

3. **採用・インターン市場情報**
   - 特定業界・企業の採用動向
   - インターン選考の難易度情報
   - 採用スケジュール・選考フロー

#### **確認できた具体例**
- 学歴フィルターなし大量採用企業情報（JR東海、ニトリ、TOPPAN等）
- サマーインターン情報（SEGA、YKKグループ等）
- 残業少ない職種ランキング（医療事務、貿易事務等）
- インターンで内定できる高倍率企業TOP50（日本航空等）
- 企業別福利厚生詳細（YKK家賃補助、DIC労働条件等）

### 現在のType003分類の問題点

#### **混在している内容の分析**
**✅ 真の業界情報（Type003として適切）**
- K007: 人事インサイダー情報・業界知見
- K016: 企業実態情報
- K024: 大手企業採用情報
- K026: インターン企業TOP50
- K031: 残業多い職種ランキング
- K036: 夏インターン企業18選
- K051: 休日多い仕事9選

**❌ 就活ノウハウ（再分類が必要）**
- K046: SPI語彙70選
- K075: 生成AI就活活用方法
- K076: AI活用術就活編
- K077: 面接官にコミュ力が高いと思われるポイント
- K080: 就活基本質問リスト30

**❌ 基礎知識（再分類が必要）**
- K011: 業界と職種の違い
- K105: 自分の人生をちゃんと生きている人
- K111: MBTI診断16タイプ特徴

**❌ 技術情報（再分類が必要）**
- K098: SaaS時代終了・AIエージェント時代
- K101: AIツール使い分け

### 再分類提案

#### **Type003（真の業界情報）の定義**
- **企業・業界データ系**: 具体的な企業の年収・労働条件・採用人数データ
- **市場動向・トレンド系**: 業界での新技術導入状況、採用市場の動向
- **業界特化型実用情報**: 特定業界のツール・システム情報、商習慣

#### **他カテゴリへの移動提案**
1. **就活ノウハウ系** → Type002または新カテゴリ
2. **基礎知識系** → Type001
3. **技術情報系** → Type004または新カテゴリ

### Type003ページ構成の方向性

真の業界情報コンテンツの特徴を踏まえ、以下のページ構成パターンが必要：

1. **企業データ比較型**: 複数企業の数値データを比較表示
2. **ランキング形式型**: 業界内での順位・評価を表示
3. **市場動向解説型**: トレンド情報と分析を段階的に説明
4. **採用情報一覧型**: 募集要項・スケジュールを整理表示

**結論**: 現在のType003は再定義と再分類が必要。真の業界情報は「具体的なデータと市場動向に基づく実用的な情報」として位置づけ、専用のページ構成パターンを確立する必要がある。

---

## 7. typeID003-industry-ranking-list（業界ランキング・一覧型）

### 基本情報
- **名称**: TypeID003 業界ランキング・一覧型
- **特徴**: 業界データをランキング形式や一覧形式で表示し、企業・職種・市場情報を効率的に比較検討
- **ページ構造**: 導入→ランキング表示→まとめ

### ページ流れ
```
Page 1: basic_intro (templateOptions: ["basic_intro", "type003_intro", "type003_intro_job"])
       ↓
Page 2 (dynamic): industry_ranking（ランキング表示）
       ↓
Page 3 (optional): achievement_summary
```

### テンプレート要件
1. **basic_intro** (BasicIntroTemplate)
   - 基本導入
   - 必須フィールド: `title`, `targetAudience`, `problems[]`, `additionalMessage`
   - オプショナル: `savePrompt`

2. **industry_ranking** (IndustryRankingTemplate)
   - **メインコンテンツ**（ランキング表示）
   - 必須フィールド: `title`, `subtitle?`, `displayType`, `items[]`
   - アイテム構造: `{rank, name, primaryValue, secondaryValue?, description?, category?}`
   - オプショナル: `note`, `source`, `tiers`（Tire表対応）

3. **achievement_summary** (AchievementSummaryTemplate)
   - まとめ・行動促進（オプショナル）
   - 必須フィールド: `summaryTitle`, `achievementPoints[]`, `encouragementMessage`

### Kxxxファイル構造例（K026基準）
```json
{
  "pageStructurePattern": "typeID003-industry-ranking-list",
  "pageCount": 3,
  "detailedContent": {
    "page1": {
      "role": "導入・問題提起",
      "section": "introduction",
      "content": {
        "title": "インターンで内定できる高倍率企業TOP50",
        "targetAudience": "大学3年生、内定直結インターンを探している就活生",
        "problems": [
          "インターンシップで内定を掴みたいけど、どの企業が高倍率？",
          "内定に繋がりやすいインターン企業を知りたい！"
        ],
        "additionalMessage": "インターンから内定を狙うなら、高倍率企業を攻略するのが近道！"
      }
    },
    "page2": {
      "role": "ランキング表示",
      "section": "mainContent",
      "content": {
        "title": "インターン内定率TOP50企業",
        "subtitle": "業界別・採用状況付きランキング",
        "displayType": "ranking",
        "items": [
          {
            "rank": 1,
            "name": "東京ドーム",
            "category": "レジャー",
            "primaryValue": "限定選考",
            "description": "エンターテイメント業界大手"
          }
        ],
        "note": "採用状況は最新情報を確認してください",
        "source": "就活支援データベース2024年版"
      }
    },
    "page3": {
      "role": "まとめ・行動促進",
      "section": "summary",
      "content": {
        "summaryTitle": "インターン攻略のポイント",
        "achievementPoints": [
          "高倍率企業を狙って内定確率アップ",
          "業界別に戦略的にアプローチ"
        ],
        "encouragementMessage": "TOP50企業を参考に、あなたも内定への道筋を描こう！"
      }
    }
  }
}
```

### 使用想定シーン
- 企業年収ランキング
- 業界別採用人数一覧
- 職種別残業時間ランキング
- インターン倍率企業TOP50
- 福利厚生充実企業一覧
- 業界Tire表（SSS/SS/S/Aランク分類）

---

## 8. typeID003-company-detail-showcase（企業詳細紹介型）

### 基本情報
- **名称**: TypeID003 企業詳細紹介型
- **特徴**: 1-2社の企業を深掘りして詳細に紹介。年収・労働条件・選考フロー・企業文化まで包括的に情報提供
- **ページ構造**: 導入→企業詳細群→まとめ

### ページ流れ
```
Page 1: basic_intro (templateOptions: ["basic_intro", "type003_intro", "type003_intro_job"])
       ↓
Page 2-N (dynamic): company_detail（企業詳細）
       ↓
Page Last (optional): achievement_summary
```

### テンプレート要件
1. **basic_intro** (BasicIntroTemplate)
   - 基本導入
   - 必須フィールド: `title`, `targetAudience`, `problems[]`, `additionalMessage`
   - オプショナル: `savePrompt`

2. **company_detail** (CompanyDetailTemplate)
   - **メインコンテンツ**（企業詳細表示）
   - 動的ページ数対応（企業数に応じて）
   - 必須フィールド: `companyName`, `features`, `details`
   - features構造: `{industry, salary?, deadline?, workingHours?, holidays?, employees?, overtime?}`
   - details構造: `{overview, recruitment[], hiringCount?, benefits?}`
   - オプショナル: `selectionProcess[]`, `catchphrase`, `logo`, `backgroundImage`, `illustration`, `highlightMessage`, `additionalInfo`

3. **achievement_summary** (AchievementSummaryTemplate)
   - まとめ・行動促進（オプショナル）
   - 必須フィールド: `summaryTitle`, `achievementPoints[]`, `encouragementMessage`

### Kxxxファイル構造例（K024基準）
```json
{
  "pageStructurePattern": "typeID003-company-detail-showcase",
  "pageCount": 8,
  "contentPageCount": 6,
  "detailedContent": {
    "page1": {
      "role": "導入・問題提起",
      "section": "introduction",
      "content": {
        "title": "まだ内定0でもいける大手企業5社",
        "targetAudience": "26卒で内定がまだ取れていない就活生",
        "problems": [
          "大手企業は諦めるしかない？",
          "まだエントリーできる企業はある？"
        ],
        "additionalMessage": "諦めるのはまだ早い！まだ間に合う大手企業があります"
      }
    },
    "page2": {
      "role": "企業詳細",
      "section": "mainContent",
      "content": {
        "companyName": "ソニーグループ",
        "features": {
          "industry": "電機・エレクトロニクス",
          "salary": "約1,113万円",
          "deadline": "2025年4月24日"
        },
        "details": {
          "overview": "26卒まだエントリーできる大手企業",
          "recruitment": ["総合職", "技術職"],
          "benefits": ["完全週休2日制", "各種社会保険完備"]
        },
        "selectionProcess": ["ES提出", "適性検査", "面接複数回", "内々定"]
      }
    }
  }
}
```

### 使用想定シーン
- 隠れ優良企業の詳細紹介
- 大手企業の採用情報詳細
- 業界特化企業の深掘り分析
- 福利厚生充実企業の特集
- 新卒採用企業の選考情報
- 企業文化・働き方の詳細解説

---

## 実装フィードバック（2025年7月）

### Type003システム整備で発見された課題

#### 1. ナレッジファイル構造の不整合
**問題**: K026が13ページの詳細構成になっていたが、実際はランキング形式が適切
- **対応**: 詳細ページ構成から3ページのランキング形式に作り替え
- **学習**: `pageStructurePattern`と`detailedContent`の整合性確保が重要

#### 2. ターゲットマッピングの誤分類
**問題**: P026（K026対応ペルソナ）がT007（Type002系）にマッピングされていた
- **対応**: P026をT007から削除し、T013（Type003系）に移動
- **学習**: postType設定とペルソナマッピングの一致確認が必要

#### 3. AIモデルバージョンの混在
**問題**: KnowledgeBasedContentGeneratorとKnowledgeMatchingServiceで異なるGeminiモデル使用
- **対応**: 全てgemini-2.0-flashに統一
- **学習**: システム全体でのAIモデル一貫性管理が重要

#### 4. PageStructureMatchingの不完全性
**問題**: 003-T013パターンがPageStructureMatchingに未登録
- **状況**: ナレッジマッチング成功時は`pageStructurePattern`使用のため問題なし
- **学習**: フォールバックシステム用のパターン登録も必要

#### 5. コンテンツ生成フローの理解
**発見**: 正常フローではKnowledgeMatchingService成功→pageStructurePattern使用
- PageStructureMatcherはフォールバック時のみ使用
- ナレッジファイルの`detailedContent`優先でページ生成

### 成功パターンの固定化

#### Type003ランキング形式の標準構造
1. **3ページ構成**: 導入→ランキング→まとめ
2. **ランキングデータ構造化**: rank/name/category/primaryValue/description
3. **テンプレート整合性**: `typeID003-industry-ranking-list`パターン準拠

#### 品質管理チェックポイント
1. **postType一致**: ナレッジファイルのpostTypeとペルソナマッピングの整合性
2. **構造適合性**: pageStructurePatternとdetailedContentの構造一致
3. **データ品質**: ランキング項目の完全性（必須フィールド充足）
4. **AIモデル統一**: 全コンポーネントでの同一モデル使用

### 今後の展開指針

#### 他Type003ナレッジファイルの検証
- K031（残業ランキング）、K036（インターン18選）、K051（休日多い仕事）の構造確認
- 必要に応じてK026同様のランキング形式への作り替え
- K016（企業実態情報）の企業詳細型への最適化

#### テンプレート拡張
- **Tire表対応**: SSS/SS/S/A分類での表示機能
- **複数指標ランキング**: 年収+福利厚生など複合評価対応
- **業界別フィルター**: カテゴリ別表示機能

#### システム統合完成度向上
- PageStructureMatching完全対応（全TypeID×TargetID組み合わせ）
- エラーハンドリング強化（フォールバック時の品質担保）
- AIモデル統一管理（バージョン更新時の一括対応）

---

## 【重要】セクション名統一仕様（必須共有事項）

### セクション名の統一ルール

**全ナレッジファイルで必須**: 動的ページ生成対象ページは`"section": "mainContent"`に統一

### 技術的背景

**contentGeneratorService.ts:241行目**で動的ページ展開時に以下の条件で検索：
```typescript
return pageData?.section === "mainContent"
```

### 統一前の問題例（K002）
- page2-3: `"section": "foundationSkillPhase"`  
- page4-5: `"section": "practicalSkillPhase"`
- page6-8: `"section": "practicalApplicationChunk"`

→ **結果**: `mainContent`セクションが0件のため1ページしか生成されない

### 統一後の正常動作（K002修正済み）
- page2-8: **全て**`"section": "mainContent"`

→ **結果**: 7ページが正しく検出され、合計8ページ生成

### 適用対象
1. **pageNumber: "dynamic"**で展開されるページ
2. **メインコンテンツ**として複数ページに分割されるページ
3. **導入・まとめページ以外**の中核コンテンツページ

### 例外
- **page1（導入）**: `"section": "introduction"` または `"section": "practical-introduction"`
- **最終ページ（まとめ）**: `"section": "summary"` または `"section": "achievement"`

### 品質管理チェックポイント
- [ ] 新規ナレッジファイル作成時のセクション名確認
- [ ] 既存ナレッジファイルの段階的修正
- [ ] 動的ページ生成テスト時のページ数確認

**重要**: この統一を怠ると複数ページ投稿が1ページしか生成されない重大な不具合が発生します。

---

## 【性能問題】ナレッジマッチングAPI過負荷対策（要最適化）

### 現在の問題

**KnowledgeMatchingService**でのGemini API過負荷発生

### 問題の詳細

**発生箇所**: `KnowledgeMatchingService.ts:67行目`
```typescript
const response = await makeModelRequest(prompt) // 巨大プロンプトで503エラー
```

**負荷原因**:
1. **大量ナレッジ処理**: 一度に34個のナレッジを処理
2. **巨大プロンプト**: 各ナレッジの詳細な解決内容を全て含む
3. **API制限**: gemini-1.5-flashへの高負荷リクエスト

### エラーの連鎖反応

```
Gemini API 503エラー
    ↓
ナレッジマッチング失敗
    ↓  
空のナレッジでフォールバック実行
    ↓
PageStructureMatcher 002-T009パターン未登録エラー
    ↓
コンテンツ生成完全失敗
```

### 最適化方針

#### 短期対策
- **リトライ機構**: 503エラー時の自動再試行
- **待機時間**: API負荷軽減のための遅延処理

#### 中期対策  
- **プロンプト最適化**: ナレッジ情報の簡略化
- **分割処理**: 34個を複数回に分けて処理
- **キャッシュ機構**: 同一入力の結果保存

#### 長期対策
- **事前フィルタリング**: 投稿タイプ別にナレッジを事前絞り込み
- **ベクトル検索**: 意味的類似度による効率的マッチング
- **API切り替え**: より軽量なモデルでの一次選別

### 影響度
- **頻度**: ナレッジベース利用時に高確率で発生
- **影響**: システム全体の機能停止
- **優先度**: **高（早急な対応が必要）**

**注意**: この問題は単なるPageStructureMatcherエラーではなく、ナレッジマッチングの根本的な性能問題です。

---

## ターゲット振り分け最適化手法（2025年7月29日追記）

### 現在の問題認識

**type-target-persona-relations.json**のtargetToPersonasセクションにおいて、実際のディレクトリ配置とコンテンツ内容分析に基づく振り分けを実施した結果、特定のターゲットにペルソナが集中する状況が発生。

### 集中ターゲットの現状
- **T001**: 10ペルソナ（Type001基本ターゲット）
- **T007**: 23ペルソナ（Type002基本ターゲット）
- **T013**: 5ペルソナ（Type003基本ターゲット）
- **T019**: 5ペルソナ（Type004基本ターゲット）
- **T024**: 26ペルソナ（Type004統合ターゲット）

他の多数のターゲット（T002-T006, T008-T012, T014-T018, T020-T023）が空の状態。

### 最適化手法

#### **方法1: ui-names.jsonの修正**
ターゲット定義の見直しと統合により、実際に使用するターゲット数を調整。

#### **方法2: typeToTargetsセクションの修正**
```json
"typeToTargets": {
  "001": ["T001", "T002", "T003", "T004", "T005", "T006"],
  "002": ["T007", "T008", "T009", "T010", "T011", "T012"],
  "003": ["T013", "T014", "T015", "T016", "T017", "T018"],
  "004": ["T019", "T020", "T021", "T022", "T023", "T024"]
}
```

この部分の対応関係を実際の利用状況に合わせて最適化。

### 振り分け再実行フロー

上記2つの修正完了後、以下の手順で自動的に最適化される：

1. **新しいターゲット定義**の確定（ui-names.json）
2. **新しい対応関係**の確定（typeToTargets）
3. **既存ペルソナの再振り分け**（自動実行）

### 優先度と実装方針

- **現在**: システム動作に問題なし（基本ターゲットで正常稼働）
- **将来**: ユーザビリティ向上のための段階的最適化
- **手法**: 設定ファイル修正のみで対応可能（コード変更不要）

この最適化により、より適切なターゲット分散とシステムの運用効率向上を実現する。