# HANDOVER - section-itemsテンプレート偏重問題の解決

## 🎯 引き継ぎ内容

**重要課題**: 全ページが `section-items` テンプレートに偏重してしまう問題の解決

## 📋 調査結果ドキュメント

### 主要問題分析ドキュメント
1. **docs/system-flow-simple.md** (154-158行)
   - 問題の明確な記載: 「全ページが `section-items` になる問題」
   - 原因: PageStructureAnalyzer の選択ロジック要改善

2. **docs/deep-system-analysis.md**
   - section-items選択される具体的理由の分析
   - 複数独立カテゴリ + まとめページ性質 + 各カテゴリに説明付き

3. **docs/03_BUTTERFLY_EFFECT_ANALYSIS.md** 
   - 蝶の羽ばたき効果による影響範囲分析
   - AI判定: □記号 + 複数カテゴリ → section-items選択の流れ

4. **NOTES.md** (375-378行)
   - 解決指針: PageStructureAnalyzer が実際の選択箇所
   - 重要警告: templateMatchingService.ts の修正は慎重に

### 技術実装箇所
- **app/services/pageStructureAnalyzer.ts** (76-134行)
  - テンプレート選択指針プロンプト
  - 実際のAI判定ロジック

## 🚨 現状の問題点

### 1. テンプレート選択の偏重
- **現象**: 入力内容に関係なく section-items が選ばれやすい
- **影響**: テンプレート多様性の欠如、コンテンツ表現力の低下
- **原因**: PageStructureAnalyzer のプロンプト設計問題

### 2. AI判定ロジックの課題  
- **問題**: □記号 + 複数カテゴリ = 自動的にsection-items判定
- **背景**: 汎用的な「まとめページ」として認識されやすい構造
- **結果**: 他の専門テンプレート(ranking, graph, table等)が選ばれにくい

### 3. ジャンル特性の未活用
- **問題**: strategy ジャンルなのに checklist-enhanced が選択されない
- **原因**: ジャンル別テンプレート優先度の実装不足
- **影響**: ジャンルに最適化されたコンテンツ生成ができない

## 🔍 解決アプローチ（要検討・実装）

### Phase 1: 問題の深堀り調査
1. **PageStructureAnalyzer プロンプトの詳細分析**
   - 現在のテンプレート選択ルールの問題点特定
   - section-items が選ばれやすい条件の洗い出し
   - 他テンプレートの選択条件の不備確認

2. **実際のAI判定ログ分析**
   - 様々な入力パターンでの選択結果検証
   - section-items選択時のAI推論プロセス調査
   - 期待されるテンプレートが選ばれない原因特定

### Phase 2: プロンプト設計の改善策検討
1. **テンプレート選択優先度の設計**
   - ジャンル別優先テンプレートマッピング
   - キーワード→テンプレート判定ルールの精緻化
   - section-items選択条件の限定化

2. **AI判定プロンプトの最適化**
   - より明確なテンプレート判定基準の記述
   - 曖昧さを排除した選択ロジック
   - ネガティブサンプルの追加（section-itemsを選ぶべきでない例）

### Phase 3: 実装と検証
1. **pageStructureAnalyzer.ts の修正**
   - テンプレート選択指針プロンプトの改良
   - ジャンル特性を活用した判定ロジック追加
   - 多様性確保メカニズムの実装

2. **検証とテスト**
   - 様々なジャンル・内容でのテンプレート選択テスト
   - section-items偏重の解消確認
   - 他テンプレートの適切な選択確認

## ⚠️ 重要な注意事項

### 修正時の留意点
1. **templateMatchingService.ts は触らない**
   - UI表示専用のため修正は慎重に
   - PageStructureAnalyzer が実際の選択を行う

2. **蝶の羽ばたき効果に注意**
   - 小さな変更が全体に大きな影響を与える可能性
   - 修正後は全テンプレートでの動作確認必須

3. **既存の良好な判定は維持**
   - 現在正しく選択されているケースを壊さない
   - 段階的な改善アプローチを採用

## 🔧 次世代開発者への指示

### やるべきこと
1. **現状理解**: 上記ドキュメントを熟読し問題の本質を理解
2. **詳細調査**: PageStructureAnalyzer のプロンプトを詳細分析
3. **解決策立案**: 具体的な改善案を複数パターン検討
4. **段階的実装**: 影響範囲を考慮した慎重な修正実施
5. **十分な検証**: 修正後の全テンプレート動作確認

### やってはいけないこと
- templateMatchingService.ts の安易な修正
- 全体的な大幅変更（蝶の羽ばたき効果のため）
- 検証不十分な本番反映

## 📊 成功指標

### 目標
- **テンプレート多様性**: 各ジャンルで適切なテンプレートが選ばれる
- **section-items使用率**: 適切な場面でのみ選択される（目安: 30%以下）
- **ジャンル特化度**: 各ジャンルの特性に応じたテンプレート選択

### 確認方法
- 同一入力で複数回生成時のテンプレート分散確認
- ジャンル別代表入力でのテンプレート選択結果検証
- ユーザーが期待するテンプレートと実際の選択結果の一致度測定

---

**この問題の解決により、システムの表現力とユーザー満足度が大幅に向上することが期待されます。**